
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <link rel="stylesheet" href="css/styles.css" type="text/css" media="screen"/>
    <link rel="alternate" type="application/rss+xml" title="ExoMemory" href="http://steveliles.github.com/rss.xml" />
    <link href='http://fonts.googleapis.com/css?family=Gochi+Hand' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:700' rel='stylesheet' type='text/css'>
    <meta name="description" content="Thoughts on Java, GWT, programming, and other geek stuff"></meta>
    <script type="text/javascript" src="google-analytics.js"></script>
    <title>Steve Liles' Blog</title>
  </head>
  <body>
    <div>
      <div class="site-header">
        <div class="left">
          <a href="/index.html"><h2>Because I'll forget it if I don't write it down...</h2></a>
        </div>
        <div class="right">
	  <a rel="author" href="http://steveliles.github.com/about_me.html"><img src="images/lego-small.png"></a>
        </div>
      </div>
      <div class="nav">
        <span>
          <a rel="me" href="https://plus.google.com/105248011271585565954"><img src="https://ssl.gstatic.com/images/icons/gplus-16.png" width="16" height="16"></a>
          <a rel="me" href="http://www.twitter.com/steveliles"><img src="http://twitter-badges.s3.amazonaws.com/t_mini-a.png" alt="Follow steveliles on Twitter"></a>
	  <a rel="me" href="http://uk.linkedin.com/in/steveliles"><img src="http://www.linkedin.com/img/webpromo/btn_in_20x15.png" width="20" height="15" alt="View my LinkedIn profile"></a>
	  <form action="http://www.google.com/search" method="get">
            <input type="hidden" name="q" value="site:steveliles.github.com">
            <input type="text" name="q" placeholder="search"></input>
          </form>
	  <a href="rss.xml"><img src="images/rss.png" width="16" height="16" alt="Subscribe to RSS feed"></a>
        </span>
      </div>
      <div class="content">
        <div class="main">
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="2,215" description="">
              <span class="meta" itemprop="datePublished"><time datetime="2014-04-21">April 21, 2014</time></span>
              <a itemprop="url" href="is_my_android_app_currently_foreground_or_background.html"><h1 itemprop="name" itemprop="headline">Is my Android app currently foreground or background?</h1></a>
	      <span itemprop="articleBody"><p>Android doesn't directly provide a way to know if your app is currently foreground or background, by which I mean actively running an Activity (screen on, user present, and your app currently presenting UI to the user).</p>

<p>Obviously if you're coding in an Activity then for almost all of the time (e.g. in any callbacks other than <code>onPause</code>, <code>onStop</code>, or <code>onDestroy</code>) you already know you are foreground, however if you have <code>Service</code>'s or <code>BroadcastReceiver</code>'s that need to adjust their behaviour when the app is foreground vs. background you need a different approach.</p>

<p>Since API level 14 (Android 4, ICS) we can easily obtain this information by hooking into the activity lifecycle events using <code>Application.registerActivityLifecycleCallbacks</code>.</p>

<p>Using this method we can register a single listener that will be called back whenever an activity lifecycle method is called on any activity in our application. We could call our listener class <code>Foreground</code>, and hook it in to the activity lifecycle methods by providing a custom Application class for our application:</p>

<pre><code>class MyApplication extends Application {
    public void onCreate(){
        Foreground.init(this);
    }
}
</code></pre>

<p>Of course, we need to register this custom <code>Application</code> class in our <code>Manifest.xml</code>:</p>

<pre><code>&amp;lt;application
    android:label="@string/app_name"
    android:theme="@style/AppTheme"
    android:name=".MyApplication"&gt;
</code></pre>

<p>So, what does our <code>Foreground</code> class look like? Let's begin by creating a class that implements <code>ActivityLifecycleCallbacks</code> and allows only one instance of itself to be created via a static method:  </p>

<pre><code>class Foreground 
implements Application.ActivityLifecycleCallbacks {

    private static Foreground instance;

    public static void init(Application app){
        if (instance == null){
            instance = new Foreground();
            app.registerActivityLifecycleCallbacks(instance);
        }
    }

    public static Foreground get(){
        return instance;
    }

    private Foreground(){}

    // TODO: implement the lifecycle callback methods!

}
</code></pre>

<p>This approach of using <code>Singleton's</code> is used a lot in Android programming, as it is a technique recommended by Google.</p>

<p>OK, so we have a class that we can initialise from our Application and then retrieve from any code in our app using <code>Foreground.get()</code>. Now we need to implement the lifecycle callbacks to track the foreground/background status of our app.</p>

<p>To do that we'll use the <code>onActivityPaused</code>/<code>onActivityResumed</code> method-pair, using paused to signal a potential shift to background, and resumed to know we are in the foreground. </p>

<pre><code>private boolean foreground;

public boolean isForeground(){
    return foreground;
}

public boolean isBackground(){
    return !foreground;
}

public void onActivityPaused(Activity activity){
    foreground = false;
}

public void onActivityResumed(Activity activity){
    foreground = true;
}

// other ActivityLifecycleCallbacks methods omitted for brevity
// we don't need them, so they are empty anyway ;)
</code></pre>

<p>Nice, so now from any code in our application we can test whether we're currently foreground or not, like this:</p>

<pre><code>Foreground.get().isForeground()
</code></pre>

<p>Cool. Are we done? We-ell, depends.</p>

<p>There are three potential issues here:</p>

<ol>
<li>The app might go to background at any time, so it would be nice if we could get notified instead of having to continually poll the <code>isForeground</code> method.</li>
<li>When an application transitions between two Activities there is a brief period during which the first <code>Activity</code> is paused and the second <code>Activity</code> has not yet resumed ... during this period <code>isForeground</code> will return false, even though our application <em>is</em> the foreground app.</li>
<li><code>Application.registerActivityLifecycleCallbacks</code> is only available from API-level 14 onwards.</li>
</ol>

<p>Can we address both of these issues? You betcha!</p>

<p>First lets make it possible to get notified of foreground/background state transitions. We'll add a Listener interface to our Foreground class:</p>

<pre><code>class Foreground 
implements Application.ActivityLifecycleCallbacks {

    public interface Listener {
        public void onBecameForeground();
        public void onBecameBackground();
    }

    ...
}
</code></pre>

<p>We'll also need to manage any registered listeners and allow listeners to be added and removed. We'll manage registered listeners using a thread-safe and efficient <code>List</code> implementation from java.util.concurrent - <code>CopyOnWriteArrayList</code>:</p>

<pre><code>private List&lt;Listener&gt; listeners = 
    new CopyOnWriteArrayList&lt;Listener&gt;();

public void addListener(Listener listener){
    listeners.add(listener);
}

public void removeListener(Listener listener){
    listeners.remove(listener);
}
</code></pre>

<p>And, of course, we'll need to notify our listeners whenever we transition between foreground and background states, which we'll do by updating our <code>onActivityPaused</code> and <code>onActivityResumed</code> methods:</p>

<pre><code>public void onPause(){
    foreground = false;
    for (Listener l : listeners){
        try {
            l.onBecameBackground();
        } catch (Exception exc) {
            Log.e("Foreground", "Unhappy listener", exc);
        }
    }
}

public void onResume(){
    foreground = true;
    for (Listener l : listeners){
        try {
            l.onBecameForeground();
        } catch (Exception exc) {
            Log.e("Foreground", "Unhappy listener", exc);
        }
    }
}
</code></pre>

<p>Allright, now we're able to register listeners with our Foreground class which will be called-back when we transition from foreground to background and vice-versa. </p>

<p>Bear in mind that the callback is invoked from the lifecycle callbacks and therefore <em>on the main thread</em>. Remember the golden rule of Android development: do not block the main thread. If you don't know what that means you should <a href="http://steveliles.github.io/asynchronous_android.html">buy my book</a> :)</p>

<p>Right, that's problem 1 sorted, what about problem 2? (What, you forgot it already? I mean the brief period between <code>onPause</code> being called in <code>Activity</code> A before <code>onResume</code> is called in <code>Activity</code> B).</p>

<p>OK, the issue here is that if we blindly update our foreground/background state in <code>onActivityPaused</code> and <code>onActivityResumed</code> we will always have a period where we're reporting incorrect values. Worse, if we're firing events we'll even tell everyone who's listening that we just went background when we didn't really!</p>

<p>Lets fix that by giving ourselves a brief period of grace before announcing that we've gone background. This is, like many things in engineering, is a compromise - in this case between immediacy and correctness. We'll accept a small delay in order not to falsely report that we went to background.</p>

<p>To do this we'll use one of the nice features of Android's <code>Handler</code> class - the ability to post a Runnable onto the main-thread's event-loop to be executed after a specified delay.</p>

<p>Things are getting a bit more complex now, and we've some extra state to juggle. We're going to introduce another boolean to track whether we're paused or not, and we'll also need to keep a reference to the Runnable that we post to the main thread, so that we can cancel it when necessary.</p>

<pre><code>private boolean foreground = false, paused = true;
private Handler handler = new Handler();
private Runnable check;
</code></pre>

<p>A quick note on <code>Handler</code>'s: A <code>Handler</code> created with the no-arg constructor will perform all of its work on the thread that created it. Since we're instantiating this Handler inline in the <code>Foreground</code> class, and the <code>Foreground</code> instance is being created on the main thread during our <code>Application</code>'s <code>onCreate</code> method callback, any work we post to this <code>Handler</code> will execute on the main thread.</p>

<p>Here's what our updated <code>onActivityPaused</code> and <code>onActivityResumed</code> methods look like:</p>

<pre><code>@Override
public void onActivityResumed(Activity activity) {
    paused = false;
    boolean wasBackground = !foreground;
    foreground = true;

    if (check != null)
        handler.removeCallbacks(check);

    if (wasBackground){
        Log.i(TAG, "went foreground");
        for (Listener l : listeners) {
            try {
                l.onBecameForeground();
            } catch (Exception exc) {
                Log.e(TAG, "Listener threw exception!", exc);
            }
        }
    } else {
        Log.i(TAG, "still foreground");
    }
}

@Override
public void onActivityPaused(Activity activity) {
    paused = true;

    if (check != null)
        handler.removeCallbacks(check);

    handler.postDelayed(check = new Runnable(){
        @Override
        public void run() {
            if (foreground &amp;&amp; paused) {
                foreground = false;
                Log.i(TAG, "went background");
                for (Listener l : listeners) {
                    try {
                        l.onBecameBackground();
                    } catch (Exception exc) {
                        Log.e(TAG, "Listener threw exception!", exc);
                    }
                }
            } else {
                Log.i(TAG, "still foreground");
            }
        }
    }, CHECK_DELAY);
}
</code></pre>

<p>A couple of things worth pointing out here:</p>

<ol>
<li><code>onActivityPaused</code> schedules a Runnable to execute after CHECK<em>DELAY milliseconds (CHECK</em>DELAY is set to 500), and captures the Runnable in the <code>check</code> member variable so it can be cancelled if necessary</li>
<li><code>onActivityResumed</code> removes (cancels) the <code>check</code> callback if there is one, to cancel the pending notification of going background.</li>
</ol>

<p>So now we have a nice neat mechanism for making direct checks for foreground/background status (Foreground.get().isBackground(), etc), and for being notified of changes to this status using the <code>Listener</code> interface.</p>

<p>To support API levels below 14 we'd need to hook our <code>Foreground</code> class more directly from the <code>onPause</code> and <code>onResume</code> methods of each individual <code>Activity</code>. This is most easily done by extending all activities in our application from a common base class and implementing the calls to Foreground from there.</p>

<p>For completeness, here's the <a href="https://gist.github.com/steveliles/11116937">github gist</a> containing the full code for the Foreground class we've just explored.</p>

<div style="font-family:'Ubuntu Mono', monospace; font-size:12px">
<script src="https://gist.github.com/steveliles/11116937.js"></script>
</div>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Android">Android</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Foreground">Foreground</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Background">Background</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Detect">Detect</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="is_my_android_app_currently_foreground_or_background.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="563" description=" Asynchronous Android is a practical book that guides you through the concurrency constructs provided by the Android platform, illustrating the applications, benefits and pitfalls of each">
              <span class="meta" itemprop="datePublished"><time datetime="2013-12-18">December 18, 2013</time></span>
              <a itemprop="url" href="asynchronous_android.html"><h1 itemprop="name" itemprop="headline">Asynchronous Android</h1></a>
	      <span itemprop="articleBody"><p>My book is published!</p>

<p>Its been an incredible learning experience - I read a lot of tech books, and find them invaluable, but if you <em>really</em> want to learn about something, try writing a book about it - the desire to deliver value to your readers with broad and deep coverage, and to <em>not get things wrong</em>, really focuses the mind!</p>

<p>Here's the cover and the marketing blurb I originally wrote, but which the publishers only used in part. I laboured over it for ages, so I figured I'd post it all here:</p>

<p><img src="images/asynchronous-android-cover.png" alt="Asynchronous Android - Cover" /></p>

<p>With more than a million apps available from Google Play, it is more important than ever to build apps that stand out from the crowd. To be successful, apps must react quickly to user-input, deliver results in a flash, and sync data in the background. The key to this is understanding the right way to implement asynchronous operations that work <em>with</em> the platform, instead of against it.</p>

<p>Asynchronous Android is a practical book that guides you through the concurrency constructs provided by the Android platform, illustrating the applications, benefits, and pitfalls of each.</p>

<p>There's so much more to Android than Activities and Fragments. To get the best from modern Android devices, developers must look to unlock the power of multi-core CPU's. Concurrency is hard, but Google's engineers have worked miracles to build a platform that makes asynchronous programming natural and fun. </p>

<p>In this book you will:</p>

<p>Learn to use <code>AsyncTask</code> correctly to perform operations in the background, keeping user-interfaces running smoothly while avoiding treacherous memory leaks.</p>

<p>Discover <code>Handler</code>, <code>HandlerThread</code> and <code>Looper</code>, the related and fundamental building blocks of asynchronous programming in Android.</p>

<p>Escape from the constraints of the <code>Activity</code> lifecycle to load and cache data efficiently across your entire application with the <code>Loader</code> framework.</p>

<p>Keep your data fresh with scheduled tasks, and understand how <code>Services</code> let your application continue to run in the background, even when the user is busy with something else.</p>

<p>Key Points:</p>

<ul>
<li>Understand Android's process model and its implications for your applications</li>
<li>Exercise multi-threading correctly to build well-behaved Android apps that work <em>with</em> the platform, not against it</li>
<li>Apply and control concurrency to deliver results quickly and keep your apps responsive to user-input</li>
<li>Avoid the common pitfalls that catch out even experienced developers</li>
<li>Discover Android-specific constructs that make asynchronous programming easy and efficient</li>
<li>Learn how, when, and why to apply Android's concurrency constructs to build smooth, response apps</li>
</ul>

<p>Asynchronous Android will help you to build well-behaved apps with smooth, responsive user-interfaces; delight your users with speedy results and data that's always fresh; and keep the system happy and the battery charged by playing by the rules.</p>

<p>Right now you can get the book direct from <a href="http://www.packtpub.com/concurrent-programming-on-android/book">Packt Publishing</a>, and <a href="http://www.barnesandnoble.com/w/asynchronous-android-steve-liles/1117737892?ean=9781783286874">Barnes and Noble</a>.</p>

<p>The links for <a href="http://www.amazon.com/dp/1783286873/?tag=packtpubli-20">Amazon US</a>, <a href="http://goo.gl/DblAKO">Amazon UK</a>, <a href="http://shop.oreilly.com/product/9781783286874.do">OReilly</a>, and <a href="http://my.safaribooksonline.com/9781783286874?cid=packt-cat-readnow-9781783286874">Safari</a> aren't active yet, but should be by the time you read this.</p>

<p>A free sample chapter should be available from the Packt page soon - I believe it will be <em>Chapter 7, Scheduling work with AlarmManager</em>.</p>

<p>The source code for all of the examples is available from <a href="https://github.com/steveliles/AsyncAndroid">GitHub</a>, and if you can download a pre-built app that runs all of the examples from <a href="https://play.google.com/store/apps/details?id=com.packt.asyncandroid">Google Play</a>.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Asynchronous">Asynchronous</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Android">Android</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Book">Book</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=AsyncTask">AsyncTask</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Handler">Handler</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=HandlerThread">HandlerThread</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Loader">Loader</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Service">Service</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=AlarmManager">AlarmManager</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="asynchronous_android.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="280" description="">
              <span class="meta" itemprop="datePublished"><time datetime="2013-10-21">October 21, 2013</time></span>
              <a itemprop="url" href="porting_ischangingconfigurations_to_api_levels_below_11.html"><h1 itemprop="name" itemprop="headline">Porting isChangingConfigurations to API-levels below 11</h1></a>
	      <span itemprop="articleBody"><p>A really handy method since API-level 11 is <code>isChangingConfigurations()</code>. When you need to make a decision about which objects to tear down, observers to unregister, etc., you really want to know if your <code>Activity</code> is restarting, going onto the back-stack, or finishing for good.</p>

<p><code>isFinishing()</code> differentiates between going to the back-stack or one of the other two cases, but doesn't help us to figure out if we're finishing for good or coming right back following a configuration change, say.</p>

<p>At API-level 11 we got a new method to help address that - <code>isChangingConfigurations()</code>. This is great - in lifecycle methods (typically <code>onPause</code>) we can check to see why we're pausing and potentially leave some of our long lived objects alone, being careful to avoid memory leaks, of course!</p>

<blockquote class="twitter-tweet"><p>note to self: do not write ContentObserver&#39;s as anonymous inner classes of Activity&#39;s <a href="https://twitter.com/search?q=%23android&amp;src=hash">#android</a> <a href="https://twitter.com/search?q=%23memoryleak&amp;src=hash">#memoryleak</a> <a href="https://twitter.com/search?q=%23iamadope&amp;src=hash">#iamadope</a></p>&mdash; Steve Liles (@steveliles) <a href="https://twitter.com/steveliles/statuses/392051976990892032">October 20, 2013</a></blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>What options do we have prior to API-level 11? Not a whole lot, actually. The best I could come up with was to create a base <code>Activity</code> class (sub-classing <code>FragmentActivity</code>, obviously) and override two methods:</p>

<ol>
<li><code>onSaveInstanceState</code> - overridden to set a boolean property <code>isConfigChange</code> to true.</li>
<li><code>isChangingConfigurations</code> - overridden to either invoke the super-class method or return the value of <code>isConfigChange</code>, depending on the API level running the app.</li>
</ol>

<p>There is one big downside - <code>onSaveInstanceState</code> is not invoked until <em>after</em> <code>onPause</code> has completed, so <code>isChangingConfigurations()</code> will only return a correct value when invoked from <code>onStop</code> pre API-level 11.</p>

<p>Full source code below.</p>

<div style="font-family:'Ubuntu Mono', monospace">
<script src="https://gist.github.com/steveliles/7076351.js"></script>
</div>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Fragmentation">Fragmentation</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Android">Android</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="porting_ischangingconfigurations_to_api_levels_below_11.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="641" description=" Trust anchor for certification path not found, Android - don't automatically reach for a custom trust manager!">
              <span class="meta" itemprop="datePublished"><time datetime="2013-05-01">May 01, 2013</time></span>
              <a itemprop="url" href="android_ssl_certificate_not_trusted.html"><h1 itemprop="name" itemprop="headline">Android SSL - Certificate not trusted</h1></a>
	      <span itemprop="articleBody"><p>I hit a problem in Android, trying to talk HTTPS with an Apache web-server that has an SSL certificate purchased from Dynadot/AlphaSSL:</p>

<pre><code>javax.net.ssl.SSLHandshakeException: 
  java.security.cert.CertPathValidatorException: 
    Trust anchor for certification path not found.
</code></pre>

<p>The code to talk to the server looks something like this:</p>

<pre><code>...
HttpsURLConnection _conn = null;
try {
    _conn = (HttpsURLConnection) 
        new URL(aUrl).openConnection();
    if ((_conn.getResponseCode() &gt;= 200) &amp;&amp; 
        (_conn.getResponseCode() &lt; 300)) {
        return handleSuccessResponse(_conn);
    } else if (...) {
        ...
    } else {
        return handleErrorResponse(_conn);
    }
finally {
    _conn.disconnect();
}
...
</code></pre>

<p>I googled the message "Trust anchor for certification path not found". Unsurprisingly, StackOverflow shows up several times in the results, but several of the top hits I got suggest reaching immediately for a custom trust manager as the preferred solution.</p>

<p>This set off alarm bells for me, ranging from "that sounds like a lot of effort" through "so, why does connecting to another https site (e.g. my bank) work?".  </p>

<p>You <em>do</em> need a custom trust manager <em>if</em> you signed your own certificate. </p>

<p>I haven't thought about it much, but the extra effort actually seems to outweigh the cost of buying a certificate. </p>

<p>You <em>do not</em> need a custom trust manager if you <em>bought</em> your certificate!</p>

<p>If you <em>bought</em> a certificate, building a custom trust manager is a complicated, slow, high-effort <em>workaround</em> for your actual problem, and - worse - you'd have to repeat the workaround on each client (imagine you are building apps for Android, iOS and Windows Mobile).</p>

<p>Certificates are signed in a "chain", where the chain eventually leads back to a set of root authority certificates that are known and trusted by Android. The point is to be able to trace a certificate back to a trusted signing authority without having to have any advance knowledge of the certificate. </p>

<p>So why is my certificate not trusted?</p>

<p>It turns out the server I was connecting to was misconfigured. It was returning its own certificate, but it was not returning the intermediate certificate, so there was no chain, and Android was unable to verify its authenticity, hence "trust anchor not found". Happily I was able to get access to the server to fix up the configuration.</p>

<p>One way to investigate your certificate chain is with openssl client:</p>

<pre><code>openssl s_client -debug -connect www.thedomaintocheck.com:443
</code></pre>

<p>This lists some useful information about your cert, including the chain. If you are experiencing a trust anchor not found, your chain will probably only contain one element, like this:</p>

<pre><code>Certificate chain
  0 s:/OU=Domain Control Validated/CN=www.thedomaintocheck.com
    i:/O=AlphaSSL/CN=AlphaSSL CA - G2
</code></pre>

<p>.. and openssl will finish its output with something like</p>

<pre><code>Verify return code: 21 (unable to verify the first certificate)
</code></pre>

<p>A server configured correctly with intermediate certificates will return a complete chain, like this:</p>

<pre><code>Certificate chain
  0 s:/OU=Domain Control Validated/CN=www.thedomaintocheck.com
    i:/O=AlphaSSL/CN=AlphaSSL CA - G2
  1 s:/O=AlphaSSL/CN=AlphaSSL CA - G2
    i:/C=BE/O=GlobalSign nv-sa/OU=Root CA/CN=GlobalSign Root CA
  2 s:/C=BE/O=GlobalSign nv-sa/OU=Root CA/CN=GlobalSign Root CA
    i:/C=BE/O=GlobalSign nv-sa/OU=Root CA/CN=GlobalSign Root CA
</code></pre>

<p>.. and Android's HttpsURLConnection will happily accept the certificate - no custom trust manager keystore nonsense here, thank you.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=SSL">SSL</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Android">Android</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Trust Manager">Trust Manager</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Certificate">Certificate</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=URLConnection">URLConnection</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="android_ssl_certificate_not_trusted.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="3,067" description="Previously I wrote my first ever Clojure code to convert Roman numerals to decimal numbers. Continuing with that exercise I moved on to trying to convert decimals to Roman numerals.">
              <span class="meta" itemprop="datePublished"><time datetime="2013-03-03">March 03, 2013</time></span>
              <a itemprop="url" href="roman_numeral_conversion_in_clojure_part_ii.html"><h1 itemprop="name" itemprop="headline">Roman numeral conversion in Clojure, part II</h1></a>
	      <span itemprop="articleBody"><p><a href="http://steveliles.github.com/roman_numeral_conversion_in_clojure.html">Previously</a> I translated Roman numerals to decimals with this code:</p>

<pre><code>(def numerals {\I 1, \V 5, \X 10, \L 50, \C 100, \D 500, \M 1000})

(defn add-numeral [n t]
  (if (&gt; n (* 4 t)) (- n t) (+ t n)))

(defn roman [s]
  (reduce add-numeral (map numerals (reverse s))))
</code></pre>

<p>Now I want to continue my Clojure practise by doing the reverse: translating from decimals to Roman numerals.</p>

<p>I started where I left off previously, so I already have the numerals map defined. I figure the inverse of this map will be handy for doing look-ups of decimals, and sure enough clojure has a handy function - map-invert:</p>

<pre><code>=&gt; (use '[clojure.set :only (map-invert)])
nil

=&gt; (doc map-invert)
&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;&amp;ndash;
clojure.set/map-invert
([m])
  Returns the map with the vals mapped to the keys.
nil
</code></pre>

<p>Inverting my numerals map gives:</p>

<pre><code>=&gt; (map-invert numerals)
{10 \X, 5 \V, 1000 \M, 50 \L, 1 \I, 500 \D, 100 \C}
</code></pre>

<p>Great, but that highlights a lack of foresight in my original naming of the numerals map, so I define a new one named <code>numerals-to-decimals</code>, and decimals to numerals as its inverse:</p>

<pre><code>(def numerals-to-decimals {\I 1, \V 5, \X 10, \L 50, \C 100, \D 500, \M 1000})
(def decimals-to-numerals (map-invert numerals-to-decimals))
</code></pre>

<p>Now I can convert easily to numerals where there is an exact match for the decimal:</p>

<pre><code>=&gt; (decimals-to-numerals 10)
\X
</code></pre>

<p>But I get nil if there's no match:</p>

<pre><code>=&gt; (decimals-to-numerals 11)
nil
</code></pre>

<p>In Roman numerals there is no zero, but they did use the concept of nul (nulla), so I start composing a function which I will incrementally improve as I figure out more steps:</p>

<pre><code>(defn decimal-to-roman [d]
  (cond
    (= 0 d) "nulla"
    :else 
      (decimals-to-numerals d)))
</code></pre>

<p>Which yields the following results:</p>

<pre><code>=&gt; (decimal-to-roman 0)
"nulla"
=&gt; (decimal-to-roman 5)
\V
=&gt; (decimal-to-roman 11)
nil
</code></pre>

<p>So now I need to tackle the case where the decimal value can only be represented by some composite of the available Roman numerals. Clearly this is going to need to involve dividing the decimal number by the largest available numeral, then repeating for the remainder. Lets try for a single numeral:</p>

<pre><code>(defn decompose-decimal-with-numeral [d v n]
  [n (quot d v) (rem d v)])
</code></pre>

<p>Testing that gives:</p>

<pre><code>=&gt; (decompose-decimal-with-numeral 23 10 \X)
[\X 2 3]
=&gt; (decompose-decimal-with-numeral 3 10 \X)
[\X 0 3]
</code></pre>

<p>Where the resulting vector contains the numeral, the number of times it divides into the decimal value, and the remainder. Lets apply that function to our map of <code>decimals-to-numerals</code>:</p>

<pre><code>(defn decompose-decimal-with-numerals [d]
  (for [[v n] decimals-to-numerals]
    (decompose-decimal-with-numeral d v n)))
</code></pre>

<p>Applying this function to the decimal 123 gives me the following:</p>

<pre><code>=&gt; (decompose-decimal-with-numerals 123)
([\X 12 3] [\V 24 3] [\M 0 123] [\L 2 23] [\I 123 0] [\D 0 123] [\C 1 23])
</code></pre>

<p>That's useful progress, but now I want to get the result of the biggest divisor only. To do that I need to filter when the divisors are larger than the input, and sort the results. Filtering is relatively straight-forward by supplying a <code>:when</code> filter function to the comprehension.</p>

<pre><code>(defn decompose-decimal-with-numerals [d]
  (for [[v n] decimals-to-numerals :when (#(&gt;= d v))]
    (decompose-decimal-with-numeral d v n)))
</code></pre>

<p>I could sort at various points along the way. Most efficient is probably to work with a sorted list of numerals from the outset, so lets create one:</p>

<pre><code>(def numerals-desc (sort-by first &gt; decimals-to-numerals))
</code></pre>

<p>Printing the new list gives:</p>

<pre><code>=&gt; (println numerals-desc)
([1000 M] [500 D] [100 C] [50 L] [10 X] [5 V] [1 I])
</code></pre>

<p>Using that in the decompose method gives:</p>

<pre><code>(defn decompose-decimal-with-numerals [d]
  (for [[v n] numerals-desc :when (#(&gt;= d v))]
    (decompose-decimal-with-numeral d v n)))

=&gt; (decompose-decimal-with-numerals 123)
([\C 1 23] [\L 2 23] [\X 12 3] [\V 24 3] [\I 123 0])
</code></pre>

<p>Sweet! We only actually need the result for the largest available divisor, so lets re-write this function to do that:</p>

<pre><code>(defn largest-divisor [d]
  (first (for [[v n] numerals-desc :when (#(&gt;= d v))]
    (decompose-decimal-with-numeral d v n))))

=&gt; (largest-divisor 123)
[\C 1 23]
</code></pre>

<p>Actually what I really want is the string representation of the numeral * the number of occurrences, so I create a new function n-numerals which concatenates N of the numeral together into a string and modify the <code>decompose-decimal-with-numeral</code> function:</p>

<pre><code>(defn n-numerals [n num]
  (apply str (for [n (range 0 n)] num)))

(defn decompose-decimal-with-numeral [d v n]
  [(n-numerals (quot d v) n) (rem d v)])
</code></pre>

<p>Now I can apply <code>decompose-decimal-with-numerals</code> and see the break-down for each numeral:</p>

<pre><code>=&gt; (decompose-decimal-with-numerals 23)
([&amp;quot;XX&amp;quot; 3] [&amp;quot;VVVV&amp;quot; 3] [&amp;quot;IIIIIIIIIIIIIIIIIIIIIII&amp;quot; 0])
</code></pre>

<p>Good to see that it is giving the correct values, but more importantly I can use <code>largest-divisor</code> to see the Roman numeral form of the quotient:</p>

<pre><code>=&gt;(largest-divisor 323)
[&amp;quot;CCC&amp;quot; 23]
</code></pre>

<p>What remains is to apply this recursively until the remainder is zero:</p>

<pre><code>(defn decompose-decimal-recursively [d]
  (let [[n r] (largest-divisor d)]
    (if (= 0 r) n (apply str n (decompose-decimal-recursively r)))))
</code></pre>

<p>Here I'm using tail recursion and the recursion can never be very deep because the set of numerals is small, so there should be no danger of blowing the stack. Testing the function gives:</p>

<pre><code>=&gt; (decompose-decimal-recursively 424)
"CCCCXXIIII"
=&gt; (decompose-decimal-recursively 1984)
"MDCCCCLXXXIIII"
</code></pre>

<p>These are correct answers, but there are two problems: First, the results are not optimal - we have runs of 4 numerals, for example <code>IIII</code> which can be written more succinctly as <code>IV</code>. Second, I think I've over-complicated things by using division instead of subtraction.</p>

<p>The decimal-to-roman translation program so far looks like:</p>

<pre><code>(use '[clojure.set :only (map-invert)])

(def numerals-to-decimals {\I 1, \V 5, \X 10, \L 50, \C 100, \D 500, \M 1000})
(def decimals-to-numerals (map-invert numerals-to-decimals))

(def numerals-desc (sort-by first &gt; decimals-to-numerals))

(defn n-numerals [n num]
  (apply str (for [n (range 0 n)] num)))

(defn decompose-decimal-with-numeral [d v n]
  [(n-numerals (quot d v) n) (rem d v)])

(defn largest-divisor [d]
  (first (for [[v n] numerals-desc :when (#(&gt;= d v))]
    (decompose-decimal-with-numeral d v n))))

(defn decompose-decimal-recursively [d]
  (let [[n r] (largest-divisor d)]
    (if (= 0 r) n (apply str n (decompose-decimal-recursively r)))))
</code></pre>

<p>I'm going to try to simplify before fixing the optimisation problem. I can find the next largest numeral that can be <em>subtracted</em> from the total like this:</p>

<pre><code>(defn largest-numeral-in [d]
  (first (for [[v n] numerals-desc :when (#(&gt;= d v))] [v n])))
</code></pre>

<p>Then I can recursively use this to eat away at the target decimal, like this:</p>

<pre><code>(defn decimal-to-roman [d]
  (let [[v n] (largest-numeral-in d) [r] [(- d v)]]
    (if (= 0 r) (str n) (apply str n (decimal-to-roman r)))))
</code></pre>

<p>The program just got a lot simpler! From 4 functions in 10 lines to 3 functions in 6 lines. Here it is in entirety:</p>

<pre><code>(use '[clojure.set :only (map-invert)])

(def numerals-to-decimals {\I 1, \V 5, \X 10, \L 50, \C 100, \D 500, \M 1000})
(def decimals-to-numerals (map-invert numerals-to-decimals))

(def numerals-desc (sort-by first &gt; decimals-to-numerals))

(defn largest-numeral-in [d]
  (first (for [[v n] numerals-desc :when (#(&gt;= d v))] [v n])))

(defn decimal-to-roman [d]
  (let [[v n] (largest-numeral-in d) [r] [(- d v)]]
    (if (= 0 r) (str n) (apply str n (decimal-to-roman r)))))
</code></pre>

<p>Now to optimise the results. After noodling with this for a while I realise that there really aren't all that many optimisation cases. They are: 4, 9, 40, 45, 49, 90, 95, 99, 400, 450, 490, 495, 499, 900, 950, 990, 995, and 999. 18 cases. I could generate these and then just do a lookup</p>

<pre><code>(def optimisations (apply hash-map (flatten 
  (for [[n1 d1] numerals-to-decimals]
    (for [[n2 d2] numerals-to-decimals :when (#(&amp;lt; d2 (quot d1 2)))]
      [(- d1 d2) (str n2 n1)])))))
</code></pre>

<p>I'm sure there's a much neater way of doing that, but it does the trick and produces this map:</p>

<pre><code>=&gt; (println optimisations)
{450 LD, 99 IC, 995 VM, 4 IV, 900 CM, 999 IM, 40 XL, 9 IX, 
490 XD, 45 VL, 495 VD, 400 CD, 49 IL, 499 ID, 950 LM, 90 XC, 
990 XM, 95 VC}
</code></pre>

<p>Now I can simply check this map in addition to the map of single numerals. Even better if there was just one map containing all of these numerals, so:</p>

<pre><code>(def opt-decimals-to-numerals
  (merge decimals-to-numerals optimisations))
</code></pre>

<p>Redefining <code>numerals-desc</code> to include the optimisations should be all I need to do:</p>

<pre><code>(def numerals-desc (sort-by first &gt; opt-decimals-to-numerals))
</code></pre>

<p>So now when I invoke <code>decimal-to-roman</code> I get:</p>

<pre><code>=&gt; (decimal-to-roman 1999)
"MIM"
=&gt; (decimal-to-roman 1954)
"MLMIV"
=&gt; (decimal-to-roman 1984)
"MLMXXXIV"
=&gt; (decimal-to-roman 313)
"CCCXIII"
=&gt; (decimal-to-roman 413)
"CDXIII"
=&gt; (decimal-to-roman 419)
"CDXIX"
</code></pre>

<p>The program in entirety now looks like this:</p>

<pre><code>(use '[clojure.set :only (map-invert)])

(def numerals-to-decimals {\I 1, \V 5, \X 10, \L 50, \C 100, \D 500, \M 1000})
(def decimals-to-numerals (map-invert numerals-to-decimals))

(def optimisations (apply hash-map (flatten 
  (for [[n1 d1] numerals-to-decimals]
    (for [[n2 d2] numerals-to-decimals :when (#(&amp;lt; d2 (quot d1 2)))]
      [(- d1 d2) (str n2 n1)])))))

(def opt-decimals-to-numerals
  (merge decimals-to-numerals optimisations))

(def numerals-desc (sort-by first &gt; opt-decimals-to-numerals))

(defn largest-numeral-in [d]
  (first (for [[v n] numerals-desc :when (#(&gt;= d v))] [v n])))

(defn decimal-to-roman [d]
  (let [[v n] (largest-numeral-in d) [r] [(- d v)]]
    (if (= 0 r) (str n) (apply str n (decimal-to-roman r)))))
</code></pre>

<p>There's quite a chunk of code there simply for converting the map of numerals-to-decimals to include the optimisations. The code would be shorter if I simply created that map to begin with:</p>

<pre><code>(def numerals-desc 
  '([1000 "M"] [999 "IM"] [995 "VM"] [990 "XM"] [950 "LM"] [900 "CM"] 
   [500 "D"] [499 "ID"] [495 "VD"] [490 "XD"] [450 "LD"] [400 "CD"] 
   [100 "C"] [99 "IC"] [95 "VC"] [90 "XC"] [50 "L"] [49 "IL"] [45 "VL"] 
   [40 "XL"] [10 "X"] [9 "IX"] [5 "V"] [4 "IV"] [1 "I"]))

(defn largest-numeral-in [d]
  (first (for [[v n] numerals-desc :when (#(&gt;= d v))] [v n])))

(defn decimal-to-roman [d]
  (let [[v n] (largest-numeral-in d) [r] [(- d v)]]
    (if (= 0 r) (str n) (apply str n (decimal-to-roman r)))))
</code></pre>

<p>Nice! Now to put everything together so that I can convert both ways - decimal-to-roman and roman-to-decimal:</p>

<pre><code>(use '[clojure.set :only (map-invert)])

(def numerals-desc 
  '([1000 "M"] [999 "IM"] [995 "VM"] [990 "XM"] [950 "LM"] [900 "CM"] 
   [500 "D"] [499 "ID"] [495 "VD"] [490 "XD"] [450 "LD"] [400 "CD"] 
   [100 "C"] [99 "IC"] [95 "VC"] [90 "XC"] [50 "L"] [49 "IL"] [45 "VL"] 
   [40 "XL"] [10 "X"] [9 "IX"] [5 "V"] [4 "IV"] [1 "I"]))

(def numerals-to-decimals
  (map-invert (apply hash-map (flatten numerals-desc))))

(defn largest-numeral-in [d]
  (first (for [[v n] numerals-desc :when (#(&gt;= d v))] [v n])))

(defn decimal-to-roman [d]
  (let [[v n] (largest-numeral-in d) [r] [(- d v)]]
    (if (= 0 r) (str n) (apply str n (decimal-to-roman r)))))

(defn add-numeral [n t]
  (if (&gt; n (* 4 t)) (- n t) (+ t n)))

(defn roman-to-decimal [r]
  (reduce add-numeral 
    (map numerals-to-decimals (map str (reverse r)))))

(defn optimise-roman [r]
  (decimal-to-roman (roman-to-decimal r)))
</code></pre>

<p>For fun I added one extra function <code>optimise-roman</code> which takes a roman-numeral string and returns the optimal representation, for example:</p>

<pre><code>=&gt; (optimise-roman "VIIII")
"IX"
=&gt; (optimise-roman "XCVIIII")
"IC"
=&gt; (optimise-roman "MDCCCCLXXXXVIIII")
"MIM"
</code></pre>

<p>I confess I am struggling with the mind-shift from imperative to functional programming. I find myself thinking of various convoluted ways to avoid recursion (why!?) and struggling to remember to <em>use</em> list comprehensions, even though (I think) I understand them well enough.</p>

<p>I'm not sure if it was because of this or in spite of it that it took me quite a while to realise that I was starting with a too-complex algorithm (division) when a much simpler one existed (subtraction).</p>

<p>Still, Clojure is fun :)</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=clojure">clojure</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=exercise">exercise</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=roman-numerals">roman-numerals</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="roman_numeral_conversion_in_clojure_part_ii.html">Comment on this post</a>

            </div>
        </div>
        <div class="sidebar">
          <div>
            <div class="twitter-feed" show="4" account="steveliles">
              <h5>Recent Tweets</h5>            
              <ul class="tweets">
                <li class="tweet-template" style="display:none">        
                  <span class="text"></span>&nbsp;<span class="date" format="yyyy"></span>
                </li>
              </ul>
              <a href="https://twitter.com/steveliles" class="twitter-follow-button" data-show-count="false">Follow @steveliles</a>
	      <script src="//platform.twitter.com/widgets.js" type="text/javascript"></script>
            </div>
          </div>
          <div>
            <a href="article-archive.html"><h5>Recent Posts</h5></a>
            <ul>
                <li><a href="is_my_android_app_currently_foreground_or_background.html">Is my Android app currently foreground or background?</a><span class="date"> - Apr 21, 2014</span></li>
                <li><a href="asynchronous_android.html">Asynchronous Android</a><span class="date"> - Dec 18, 2013</span></li>
                <li><a href="porting_ischangingconfigurations_to_api_levels_below_11.html">Porting isChangingConfigurations to API-levels below 11</a><span class="date"> - Oct 21, 2013</span></li>
                <li><a href="android_ssl_certificate_not_trusted.html">Android SSL - Certificate not trusted</a><span class="date"> - May 01, 2013</span></li>
                <li><a href="roman_numeral_conversion_in_clojure_part_ii.html">Roman numeral conversion in Clojure, part II</a><span class="date"> - Mar 03, 2013</span></li>
            </ul>
            <a href="article-archive.html">Older posts...</a>
          </div>
        </div>
      </div>
      <div class="nav">
        <div class="links">
          
          <div class="next"><a title="next" href="index_1.html">Older Posts</a></div>
        </div>
      </div>
    </div>
    <script type="text/javascript" language="javascript" src="blog/blog.nocache.js"></script>
  </body>
</html>

