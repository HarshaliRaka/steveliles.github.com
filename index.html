
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <link rel="stylesheet" href="css/styles.css" type="text/css" media="screen"/>
    <link rel="alternate" type="application/rss+xml" title="ExoMemory" href="http://steveliles.github.com/rss.xml" />
    <link href='http://fonts.googleapis.com/css?family=Gochi+Hand' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:700' rel='stylesheet' type='text/css'>
    <meta name="description" content="Thoughts on Java, GWT, programming, and other geek stuff"></meta>
    <script type="text/javascript" src="google-analytics.js"></script>
    <title>Steve Liles' Blog</title>
  </head>
  <body>
    <div>
      <div class="site-header">
        <div class="left">
          <a href="/index.html"><h1>ExoMemory</h1></a>
          <h2>Because I'll forget it if I don't write it down...</h2>
        </div>
        <div class="right">
	  <a rel="author" href="http://steveliles.github.com/about_me.html"><img src="images/lego.png"></a>
        </div>
      </div>
      <div class="nav">
        <span>
          <a rel="me" href="https://plus.google.com/105248011271585565954"><img src="http://www.google.com/images/icons/ui/gprofile_button-16.png" width="16" height="16"></a>
          <a rel="me" href="http://www.twitter.com/steveliles"><img src="http://twitter-badges.s3.amazonaws.com/t_mini-a.png" alt="Follow steveliles on Twitter"></a>
	  <a rel="me" href="http://uk.linkedin.com/in/steveliles"><img src="http://www.linkedin.com/img/webpromo/btn_in_20x15.png" width="20" height="15" alt="View my LinkedIn profile"></a>
	  <form action="http://www.google.com/search" method="get">
            <input type="hidden" name="q" value="site:steveliles.github.com">
            <input type="text" name="q" placeholder="search"></input>
          </form>
	  <a href="rss.xml"><img src="images/rss.png" width="16" height="16" alt="Subscribe to RSS feed"></a>
        </span>
      </div>
      <div class="content">
        <div class="main">
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="272" description="A couple of commands I've been using to create iOS-style icons with ImageMagick">
              <span class="meta" itemprop="datePublished"><time datetime="2012-01-27">January 27, 2012</time></span>
              <a itemprop="url" href="creating_ios_style_icons_with_imagemagick.html"><h1 itemprop="name" itemprop="headline">Creating iOS style icons with ImageMagick</h1></a>
	      <span itemprop="articleBody"><p>Icons for iOS apps are generally provided by the app with square corners and no "sheen". The rounded corners and glossy sheen are added by iOS.</p>

<p>If you want to achieve the iOS icon look on icons used elsewhere (Android, Web, etc), you need to round the corners and apply the sheen yourself.</p>

<p>What follows is my quick attempt to give the iOS treatment to this 512x512 icon:</p>

<p><img src="https://lh6.googleusercontent.com/-UaUMm3U99L8/TyLi2QD6E-I/AAAAAAAAIq4/gl-21ZMoBg4/s800/in.png" alt="Original Icon" /></p>

<h3>Transparent Rounded Corners</h3>

<p>OK, transparent rounded corners are actually the easy part. There are several ways to get ImageMagick to do this. The easiest (read: shortest) command i've found looks like this:</p>

<pre><code>convert -size 512x512 xc:none -fill white -draw \
    'roundRectangle 0,0 512,512 50,50' in.png \
    -compose SrcIn -composite rounded.png
</code></pre>

<p>So now we have this:</p>

<p><img src="https://lh3.googleusercontent.com/-ndvucr5orZ4/TyLmOX_XYqI/AAAAAAAAIrc/gMdrV_Hvil8/s800/test.png" alt="Rounded Corners" /></p>

<h3>Overlay some sheen</h3>

<p>The sheen is trickier. I imagine that real ImageMagick pro's could generate the sheen mask with some deft command-line, but I'm nowhere near that proficient.</p>

<p>Instead I created the following image in Gimp - exactly how is a topic for another post :). The black background is coming from the div containing the image - where you see black is actually transparent in my png, and the grey highlight at the top is semi-transparent:</p>

<div style="background-color:black; width:512px;"><img src="https://lh5.googleusercontent.com/-gssBzUQ5a0c/TyLi4f6F6fI/AAAAAAAAIrE/Lc9HhdfRQN8/s800/gloss-over.png"></div>

<p>To composite the rounded-corner image with the glossy overlay (gloss-over.png), I use this ImageMagick command:</p>

<pre><code>convert -draw "image Screen 0,0 0,0 'gloss-over.png'" \
    rounded.png final.png
</code></pre>

<p><img src="https://lh4.googleusercontent.com/-YaXSMS3j_Ws/TyLmvOKZLMI/AAAAAAAAIr0/h_nP4EQ8k94/s800/final.png" alt="Final iOS style image" /></p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=ImageMagick">ImageMagick</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=iOS">iOS</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Icon">Icon</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="creating_ios_style_icons_with_imagemagick.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="2,395" description="Invoking an external process from Java appears easy enough but there are sooo many gotchas to watch out for. Here I try to describe some of them, and suggest some ways to avoid those problems.">
              <span class="meta" itemprop="datePublished"><time datetime="2012-01-26">January 26, 2012</time></span>
              <a itemprop="url" href="invoking_processes_from_java.html"><h1 itemprop="name" itemprop="headline">Invoking Processes from Java</h1></a>
	      <span itemprop="articleBody"><p>Invoking an external process from Java appears easy enough but there are sooo many gotchas to watch out for. Typical problems that arise include:</p>

<ol>
<li><em>Hanging Processes</em> - The invoked process "hangs" and never completes (because it is waiting for input that never comes, or for the output buffer(s) to be drained).</li>
<li><em>Failure to execute</em> - Commands that work fine from the cmdline refuse to run when invoked from Java (because the parameters are passed incorrectly).</li>
<li><em>Mysterious issues in production</em> - Peculiar situations where processes cease to work after running happily for some time (the file-handle quota is exhausted because the IO streams are not being correctly closed).</li>
</ol>

<p>The first two are irritating, but at least they present themselves immediately and are typically fixed before the code leaves the developer. </p>

<p>The last problem is much more insidious and often only rears its head after some time in production (sometimes this is because it takes time and a significant number of executions before it manifests, other times it is because of differences between the development and production environments).</p>

<p>Lets have a look at the general solution to each of these problems. Later I'll list some code that I've been using to invoke processes safely.</p>

<h3>Hanging Processes</h3>

<p><em>Symptoms:</em> When invoked, the process starts but does not complete. Sometimes this may appear to be caused by the input that is being fed to the process (e.g. with input A it works but with input B it does not), which adds to the confusion over why the problem occurs.</p>

<p><em>Cause:</em> The most common reason for this problem is failing to pump input into the program, and drain output buffers from the program, using separate threads.</p>

<p>If a program is consuming sufficient input via standard-input (stdin), or producing sufficient output via stdout or stderr, the limited buffers available to it will fill up. Until those buffers are drained the process will block on IO to those buffers, so the process is effectively hung.</p>

<p><em>Solution:</em> When you invoke any process from Java, you must use separate threads to pump data to/from stdin, stdout, and stderr:</p>

<pre><code>// invoke the process, keeping a handle to it for later...
final Process _p = Runtime.getRuntime().exec("some-command-or-other");

// Handle stdout...
new Thread() {
    public void run() {
    try {
            Streams.copy(_p.getInputStream(), System.out);
        } catch (Exception anExc) {
            anExc.printStackTrace();
        }
    }
}.start();

// Handle stderr...
new Thread() {
    public void run() {
    try {
            Streams.copy(_p.getInputStream(), System.out);
        } catch (Exception anExc) {
            anExc.printStackTrace();
        }
    }
}.start();
</code></pre>

<h3>Failure to Execute</h3>

<p><em>Symptoms:</em> You have a command-line that works perfectly when executed at the shell prompt, but invoking it from Java results in strange errors and, perhaps, complaints about invalid parameters.</p>

<p><em>Cause:</em> Typically this occurs when you try to pass parameters which include spaces - for example file-names - which you escape or quote at the shell prompt.</p>

<p><em>Example:</em> Running ImageMagick "convert" to add transparent rounded corners to an icon:</p>

<pre><code>convert -size 72x72 xc:none -fill white -draw \
  'roundRectangle 0,0 72,72 15,15' in.png \
  -compose SrcIn -composite out.png
</code></pre>

<p>This command-line works fine at a bash prompt, but if you try to invoke it naively from Java it will likely fail in a variety of interesting ways depending on your platform:</p>

<pre><code>public static void main(String... anArgs) {
    // invoke the process, keeping a handle to it for later...
    final Process _p = Runtime.getRuntime().exec(
        "/usr/bin/convert -size 72x72 xc:none -fill white -draw" +
        " 'roundRectangle 0,0 72,72 15,15' /home/steve/Desktop/in.png" +
        " -compose SrcIn -composite /home/steve/Desktop/out.png"
    );

    // Handle stdout...
    new Thread() {
        public void run() {
            try {
                Streams.copy(_p.getInputStream(), System.out);
            } catch (Exception anExc) {
                anExc.printStackTrace();
            }
        }
    }.start();

    // Handle sderr...
    new Thread() {
        public void run() {
            try {
                Streams.copy(_p.getErrorStream(), System.out);
            } catch (Exception anExc) {
                anExc.printStackTrace();
            }
        }
    }.start();

    // wait for the process to complete
    _p.waitFor();
}
</code></pre>

<p>Whilst the command-line worked fine at the bash prompt, running the same command from Java results in an error message!:</p>

<pre><code>convert: non-conforming drawing primitive definition 
    `roundRectangle' @ error/draw.c/DrawImage/3143.
convert: unable to open image `0,0':  @ error/blob.c/OpenBlob/2489.
convert: unable to open image `72,72':  @ error/blob.c/OpenBlob/2489.
convert: unable to open image `15,15'':  @ error/blob.c/OpenBlob/2489.
convert: non-conforming drawing primitive definition 
    `roundRectangle' @ error/draw.c/DrawImage/3143.
</code></pre>

<p>What's going on!? Basically the command we gave to Runtime.exec has been sliced up at spaces, ignoring the single quotes, and so ImageMagick has seen a very different command-line to the one we presented via the shell.</p>

<p><em>Solution:</em> The solution this time is very easy: Use the overloaded Runtime.exec(..) methods that accept the command <em>and</em> the parameters as an array of String's. Re-writing our previous example:</p>

<pre><code>public static void main(String... anArgs) 
throws Exception {
    // invoke the process, keeping a handle to it for later...
    // note that we pass the command and its params as String's in
    // the same String[]
    final Process _p = Runtime.getRuntime().exec(
        new String[]{
            "/usr/bin/convert",
            "-size", "72x72", "xc:none", "-fill", "white", "-draw",
            "roundRectangle 0,0 72,72 15,15", 
            "/home/steve/Desktop/in.png", "-compose", "SrcIn",
            "-composite", "/home/steve/Desktop/out.png"
        }
    );

    // Handle stdout...
    new Thread() {
        public void run() {
            try {
                Streams.copy(_p.getInputStream(), System.out);
            } catch (Exception anExc) {
                anExc.printStackTrace();
            }
        }
    }.start();

    // Handle sderr...
    new Thread() {
        public void run() {
            try {
                Streams.copy(_p.getErrorStream(), System.out);
            } catch (Exception anExc) {
                anExc.printStackTrace();
            }
        }
    }.start();

    // wait for the process to complete
    _p.waitFor();
}
</code></pre>

<h3>Mysterious issues in production</h3>

<p><em>Symptoms:</em> For a good while things appear to be working fine. Processes are invoked, do their work, and shut-down. After a while a problem occurs - the processes are no longer being invoked, or hang.</p>

<p><em>Cause:</em> The cause of this is usually exhaustion of the available file-handles, which in turn is caused by failing to correctly close all of the IO streams opened to handle the process IO.</p>

<p><em>Solution:</em> Careful closure of all standard IO streams opened by the process <em>and</em> streams opened by you to consume the data from the standard streams opened by the process. Note: That's SIX streams in total, not just the three that you open to deal with stdin, stdout and stderr! I also recommend calling <code>destroy</code> on the Process object.</p>

<p>I <em>may</em> be being over-cautious in closing the process's own std streams, but I have seen many cases where closing these streams solved problems of leaked file-handles. (btw., A handy tool if you're running a *nix is <code>lsof</code>, which lists open file handles).</p>

<p>Here's how I recommend cleaning up after your process completes (this assumes that you did provide input via stdin):</p>

<pre><code>public static void main(String... anArgs) {
    Process _process = null;
    InputStream _in = null;
    OutputStream _out = null;
    OutputStream _err = null;
    try {
        _process = Runtime.getRuntime().exec( ... );
        // ... don't forget to initialise in, out, and error,
        // .... and consume the streams in separate threads!
        _process.waitFor();
    } finally {
        if( _process != null ) {
            close(_process.getErrorStream());
            close(_process.getOutputStream());
            close(_process.getInputStream());
            _process.destroy();
        }
        close(_in);
        close(_out);
        close(_err);
    }
}

private static void close(InputStream anInput) {
    try {
        if (anInput != null) {
            anInput.close();
        }
    } catch (IOException anExc) {
        anExc.printStackTrace();
    }
}

private static void close(OutputStream anOutput) {
    try {
        if (anOutput != null) {
            anOutput.close();
        }
    } catch (IOException anExc) {
        anExc.printStackTrace();
    }
}
</code></pre>

<p>These days I usually use some utility classes which I've written to wrap all this stuff up and make life a little easier. You can find them in my <a href="https://github.com/steveliles/sjl.io">sjl.io</a> project at github. There's an example of usage in the <code>test</code> source tree - <code>ExternalProcessTest</code> - which invokes ImageMagick.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Java">Java</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Process">Process</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="invoking_processes_from_java.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="84" description="Couldn't resist posting my latest Comic Strip It! creation, testing the new speech balloon styles and colours, and featuring my latest lego mini-figure - the mad scientist!">
              <span class="meta" itemprop="datePublished"><time datetime="2012-01-25">January 25, 2012</time></span>
              <a itemprop="url" href="another_mini_figure_another_comic_strip.html"><h1 itemprop="name" itemprop="headline">Another mini-figure, another comic strip...</h1></a>
	      <span itemprop="articleBody"><p>Here's a quick taster of the new speech-balloon styles and colours available in Comic Strip It! v1.4.2 (and featuring my latest lego minifigure - the Mad Scientist).</p>

<p><a target="top" href="https://lh5.googleusercontent.com/-ZPNFZHx_4vA/TyCF5AJcchI/AAAAAAAAIpk/qpDlLOxZLBg/s1600/20.jpg"><img alt="Joe Hazmat vs Mad Scientist, a comic strip made with @ComicStripIt" src="https://lh5.googleusercontent.com/-ZPNFZHx_4vA/TyCF5AJcchI/AAAAAAAAIpk/qpDlLOxZLBg/s600/20.jpg"></a></p>

<table>
 <tr>
  <td>Sorry iOS folks, <a href="https://market.android.com/details?id=com.roundwoodstudios.comicstripitpro">Comic Strip It!</a> is only available for Android at this time. Android folks can jump to the Market with this QR code.</td>
  <td><a href="https://market.android.com/details?id=com.roundwoodstudios.comicstripitpro"><img src="images/qr_code.png"></a></td>
 </tr>
</table>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Comic Strip It">Comic Strip It</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Android">Android</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=App">App</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Comic Strip">Comic Strip</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Lego">Lego</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="another_mini_figure_another_comic_strip.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="552" description="I blogged recently about how we've set things up for team development using Maven, Android and Eclipse. This follow up post describes how someone joining the team would go about setting up and getting to work...">
              <span class="meta" itemprop="datePublished"><time datetime="2012-01-23">January 23, 2012</time></span>
              <a itemprop="url" href="maven_android_and_eclipse_joining_the_team.html"><h1 itemprop="name" itemprop="headline">Maven, Android and Eclipse - joining the team</h1></a>
	      <span itemprop="articleBody"><p>I blogged recently about <a href="http://steveliles.github.com/converting_eclipse_adt_android_projects_to_build_with_maven.html">building Android projects with Maven</a>, and <a href="http://steveliles.github.com/setting_up_maven_android_and_svn_for_team_development_of_multiple_applications.html">how we've set things up for team development</a> using Maven, Android and Eclipse. This follow up post describes how someone joining the team would go about setting up and getting to work...</p>

<p>To join in the fun you need a straight-forward installation of the following pre-requisite tools:</p>

<ul>
<li>Eclipse (I usually go for Eclipse classic)</li>
<li>Subversion</li>
<li>Maven 3.0.3</li>
<li>Android SDK</li>
</ul>

<p>You will then need the following Eclipse plugins:</p>

<ul>
<li><a href="http://developer.android.com/sdk/eclipse-adt.html">Android Development Tools (ADT)</a> - update site: https://dl-ssl.google.com/android/eclipse/</li>
<li><a href="http://eclipse.org/m2e/">m2eclipse</a> - update site: http://download.eclipse.org/technology/m2e/releases</li>
<li><a href="http://rgladwell.github.com/m2e-android/">m2e-android</a> - Whilst you can install this like a normal plugin (thx Ricardo for the correction), I recommend that you <em>don't</em> use an update site to install this - instead, follow the instructions at the bottom of this post (after the comic), or at the <a href="http://rgladwell.github.com/m2e-android/">m2e-android site</a>.</li>
</ul>

<p>Since you are setting up to join an existing team, most of the maven configuration has presumably already been done for you. To get working on a project (assuming it is set up <a href="http://steveliles.github.com/setting_up_maven_android_and_svn_for_team_development_of_multiple_applications.html">as I described</a>) you need to check out two projects:</p>

<ol>
<li>The "parent" project containing the common configuration for all Android-Maven projects</li>
<li>The project you actually need to work on</li>
<li>(OK, yes, also any apklib library projects if you need to debug or work on those too)</li>
</ol>

<p>I highly recommend checking out so that all of these projects are siblings in a common projects directory.</p>

<p>The <em>biggest</em> single difference from ADT's usual working style is that you can't (currently) work with the apklib projects as project dependencies <a href="http://steveliles.github.com/the_dreaded_unexpected_top_level_exception.html">because of this issue</a>. Instead, if you make any changes to an apklib project, you'll need to <code>mvn install</code> or <code>mvn deploy</code> it before you can see the change in your dependent apk projects.</p>

<p>I found that I had to "mvn install" each of the apklib projects locally before the dependent projects would build, as the remotely deployed projects for some reason did not include the pom resource - I haven't yet had time to investigate why.</p>

<p><a target="top" href="https://lh4.googleusercontent.com/-WtXO6OjDnEA/Tx1KHLcuupI/AAAAAAAAIoA/HyxxXrw5i10/s1600/75.jpg"><img alt="Converting Eclipse ADT projects to build with Maven, a comic strip made with @ComicStripIt" src="https://lh4.googleusercontent.com/-WtXO6OjDnEA/Tx1KHLcuupI/AAAAAAAAIoA/HyxxXrw5i10/s600/75.jpg"></a></p>

<h3>Installing M2E-Android</h3>

<p><em>Don't install this like a normal Eclipse feature!</em> To install M2E-Android, open an Android-Maven project and open the pom.xml. You should see that the <packaging> element is being highlighted as an error, because without M2E-Android, M2Eclipse does not understand the <code>apk</code> or <code>apklib</code> packaging types.</p>

<p>In the header of the pom.xml editor you should see a red error message: <code>plugin execution not covered by lifecycle configuration...</code>.</p>

<p><img src="https://lh5.googleusercontent.com/-Aki7I_BiCLw/Tx6hX3ZXmkI/AAAAAAAAIoU/KNQvbH5sNRI/s600/plugin-execution-crop.png" alt="error when pom packaging set to apk or apklib" /></p>

<p>Click the error and some details open up, including two quick fixes. Click the first quick fix ("discover new m2e connectors"). The following dialog pops up and after a short search, shows the m2e-android connector:</p>

<p><img src="https://lh4.googleusercontent.com/-YeihPZ0PxWQ/TwRWknaVQeI/AAAAAAAAIas/0NnoMugrFa4/s800/install-m2e-connectors.png" alt="discover connectors dialog" /></p>

<p>Install the connector and the warnings <em>should</em> go away. Actually on one of my two machines they did not - I don't know why, but I had to take the 2nd quick-fix option of turning it off in Eclipse. For me that's just about ok, as I want the maven build to be the master anyway.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Maven">Maven</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Android">Android</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Eclipse">Eclipse</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=m2e-Android">m2e-Android</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=m2eclipse">m2eclipse</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=ADT">ADT</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="maven_android_and_eclipse_joining_the_team.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="790" description="While automating production of customised applications I needed to automatically create a set of icons matching the colour scheme selected by the customer. This is how I tried (and failed) to do it with Image Magick.">
              <span class="meta" itemprop="datePublished"><time datetime="2012-01-18">January 18, 2012</time></span>
              <a itemprop="url" href="creating_colourised_icon_theme_sets_with_image_magick.html"><h1 itemprop="name" itemprop="headline">Creating colourised icon theme-sets with Image-Magick</h1></a>
	      <span itemprop="articleBody"><p>While automating production of customised applications I needed to automatically create a set of icons that match the colour scheme selected by the customer. This article describes some of my experiments (details follow the strip...).</p>

<p><a target="top" href="https://lh6.googleusercontent.com/--oSeeAaXsA4/TxtID4kzrMI/AAAAAAAAImI/24-smIOigfU/s1600/48.jpg"><img alt="ImageMagick comic strip made with @ComicStripIt" src="https://lh6.googleusercontent.com/--oSeeAaXsA4/TxtID4kzrMI/AAAAAAAAImI/24-smIOigfU/s600/48.jpg"></a></p>

<p>My aim was to find a way to take a target colour and re-create the entire icon set matched as closely as possible to that input colour, using a single command-line.</p>

<p>Lets start with a quick look at a sample icon - this was created by our UX designer and used in building the proto-typical instance of the application. It is part of a set of around 30:</p>

<p><img src="https://lh4.googleusercontent.com/-e4m6fYN49O8/Txb9kVwIcjI/AAAAAAAAIg0/QqAZfCYW31I/s800/informations_contactus_icon.png" alt="Original icon" /></p>

<p>Given that I want to be able to apply a colour selected by a customer, I need to start from a neutral state, so my first step is to <em>de-colourise</em> the original icon, producing this grey-scale version:</p>

<p><img src="https://lh6.googleusercontent.com/--8FToJl9oYs/Txb5ePoLJ6I/AAAAAAAAIgc/nCX1EfMY96Y/s800/informations_contactus_icon.png" alt="Example icon to be coloured" /></p>

<p>Note that the icons all have transparency, but otherwise are largely made from shades of a single colour (a gradient) with white highlights.</p>

<p>I started by looking at the simple built-in image-magick commands. Given that I'm converting a large batch of icons I'm using <code>mogrify</code> instead of <code>convert</code>, which also requires that the command-line is re-ordered slightly, for example:</p>

<pre><code>convert in.png -brightness-contrast 20x20 out.png
</code></pre>

<p>becomes:</p>

<pre><code>mogrify -brightness-contrast 20x20 *
</code></pre>

<p>My first attempts used the Image-Magick commands <code>tint</code>, <code>colorize</code>, and <code>+level-colors</code> individually, as I was hoping for a very simple solution to present itself. Let's look at what each of those commands produces if we try to create icons with the following base colour:</p>

<div style="background-color:#0000cc; width:400px; height:60px; margin:auto; padding-left:40px;"><span style="color:white; font-family:'ubuntu mono'; font-size:20px; line-height:60px;">The background here is our base colour</span></div>

<pre><code>mogrify -fill "#0000cc" -tint 100 *
</code></pre>

<p><img src="https://lh6.googleusercontent.com/-cYoe5UrvgsY/TxgphOBN5iI/AAAAAAAAIhM/LVinN-HnqFs/s800/informations_contactus_icon.png" alt="imagemagick tint" /></p>

<pre><code>mogrify -colorize 100,0,0 *
</code></pre>

<p><img src="https://lh6.googleusercontent.com/-52WdHbWDsLc/TxgrS6jOpLI/AAAAAAAAIho/VhS1NSr2RNM/s800/informations_contactus_icon.png" alt="imagemagick colorize" /></p>

<pre><code>mogrify +level-colors "#000066","#0000cc" *
</code></pre>

<p><img src="https://lh6.googleusercontent.com/-djRiYF9xQ_s/TxgslWJEmII/AAAAAAAAIiA/-JRBtifNU_U/s800/informations_contactus_icon.png" alt="imagemagick +level-colors" /></p>

<p>As you can see from those examples, <code>tint</code> does the best job of retaining the fidelity of the icon, but doesn't really get close to the target colour. </p>

<p><code>Colorize</code> has also kept most of the fidelity, but the white foreground has tended towards the target blue colour along with the grey background parts, though neither has really got very close to our intended colour.</p>

<p><code>+level-colors</code> has got us closer to our target colour, but we've almost completely lost the white and the fidelity of the icon is, as a result, pretty much destroyed.</p>

<h2>Reduce and re-compose</h2>

<p>OK, so we can't get there with a simple one-liner. What about if we strip out different aspects of the image, perform different operations on each composite part, and then re-combine them later?</p>

<p>This is ultimately what I ended up doing:</p>

<ol>
<li>Extract the white part only</li>
<li>Brighten the grey part (helps the later stages to get closer to the target colour)</li>
<li>Adjust the grey (background) part towards our target colour</li>
<li>Composite the white foreground back over the re-coloured background</li>
</ol>

<p>Here's the commands to achieve that (note: I switched to using <code>convert</code> instead of <code>mogrify</code> because it was easier to test incremental changes this way):</p>

<pre><code># extract the white parts
convert -fuzz 60% -transparent black in.png 2.png

# lighten the original image
convert in.png -brightness-contrast 20x0 3.png

# level colours ...
convert +level-colors "#000066","#0000cc" 3.png

# composite together ...
convert 3.png 2.png in.png -composite out.png
</code></pre>

<p>It shouldn't be too difficult to follow that. </p>

<p>The first command extracts the white-ish parts of the image (foreground) by making shades of grey - from black through 60% grey - transparent. The fuzz factor is what determines the cut-off point. We produce this white-foreground as a separate image (2.png) because we still need the original for later steps.</p>

<p>Next we create a 3rd image (background) as a lightened version of the original (3.png) then colourise it using the <code>+level-colors</code> command we used earlier.</p>

<p>Finally we composite together the background image as the base, the foreground image on top, and use the original image as a mask so that we don't lose the transparency. The final result looks like this:</p>

<p><img src="https://lh5.googleusercontent.com/-V6IAdSmaJDY/TxhCqKLAarI/AAAAAAAAIig/syTquI4Dtr8/s800/informations_contactus_icon.png" alt="final" /></p>

<p>This is the best I've managed so far with my rudimentary knowledge of ImageMagick. </p>

<p>Since I'm invoking this conversion from a Java process I think I'll try something a little more low-level in Java next. I want the fidelity of the "tint" operation, with the precise colour targeting of the composite approach, I just don't know how to get there with ImageMagick.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=colour">colour</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=icon">icon</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Image Magick">Image Magick</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=automation">automation</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="creating_colourised_icon_theme_sets_with_image_magick.html">Comment on this post</a>

            </div>
        </div>
        <div class="sidebar">
          <div>
            <div class="twitter-feed" show="4" account="steveliles">
              <h5>Recent Tweets</h5>            
              <ul class="tweets">
                <li class="tweet-template" style="display:none">        
                  <span class="text"></span>&nbsp;<span class="date" format="yyyy"></span>
                </li>
              </ul>
              <a href="https://twitter.com/steveliles" class="twitter-follow-button" data-show-count="false">Follow @steveliles</a>
	      <script src="//platform.twitter.com/widgets.js" type="text/javascript"></script>
            </div>
          </div>
          <div>
            <a href="article-archive.html"><h5>Recent Posts</h5></a>
            <ul>
                <li><a href="creating_ios_style_icons_with_imagemagick.html">Creating iOS style icons with ImageMagick</a><span class="date"> - Jan 27, 2012</span></li>
                <li><a href="invoking_processes_from_java.html">Invoking Processes from Java</a><span class="date"> - Jan 26, 2012</span></li>
                <li><a href="another_mini_figure_another_comic_strip.html">Another mini-figure, another comic strip...</a><span class="date"> - Jan 25, 2012</span></li>
                <li><a href="maven_android_and_eclipse_joining_the_team.html">Maven, Android and Eclipse - joining the team</a><span class="date"> - Jan 23, 2012</span></li>
                <li><a href="creating_colourised_icon_theme_sets_with_image_magick.html">Creating colourised icon theme-sets with Image-Magick</a><span class="date"> - Jan 18, 2012</span></li>
            </ul>
            <a href="article-archive.html">Older posts...</a>
          </div>
        </div>
      </div>
      <div class="nav">
        <div class="links">
          
          <div class="next"><a title="next" href="index_1.html">Older Posts</a></div>
        </div>
      </div>
    </div>
    <script type="text/javascript" language="javascript" src="blog/blog.nocache.js"></script>
  </body>
</html>

