
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <link rel="stylesheet" href="css/styles.css" type="text/css" media="screen"/>
    <link rel="alternate" type="application/rss+xml" title="ExoMemory" href="http://steveliles.github.com/rss.xml" />
    <link href='http://fonts.googleapis.com/css?family=Gochi+Hand' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:700' rel='stylesheet' type='text/css'>
    <meta name="description" content="Thoughts on Java, GWT, programming, and other geek stuff"></meta>
    <script type="text/javascript" src="google-analytics.js"></script>
    <title>Steve Liles' Blog</title>
  </head>
  <body>
    <div>
      <div class="site-header">
        <div class="left">
          <a href="/index.html"><h1>ExoMemory</h1></a>
          <h2>Because I'll forget it if I don't write it down...</h2>
        </div>
        <div class="right">
	  <a rel="author" href="http://steveliles.github.com/about_me.html"><img src="images/lego.png"></a>
        </div>
      </div>
      <div class="nav">
        <span>
          <a rel="me" href="https://plus.google.com/105248011271585565954"><img src="https://ssl.gstatic.com/images/icons/gplus-16.png" width="16" height="16"></a>
          <a rel="me" href="http://www.twitter.com/steveliles"><img src="http://twitter-badges.s3.amazonaws.com/t_mini-a.png" alt="Follow steveliles on Twitter"></a>
	  <a rel="me" href="http://uk.linkedin.com/in/steveliles"><img src="http://www.linkedin.com/img/webpromo/btn_in_20x15.png" width="20" height="15" alt="View my LinkedIn profile"></a>
	  <form action="http://www.google.com/search" method="get">
            <input type="hidden" name="q" value="site:steveliles.github.com">
            <input type="text" name="q" placeholder="search"></input>
          </form>
	  <a href="rss.xml"><img src="images/rss.png" width="16" height="16" alt="Subscribe to RSS feed"></a>
        </span>
      </div>
      <div class="content">
        <div class="main">
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="806" description="A very quick how-to for setting up data-binding formatters in Spring ()3.1.x) MVC">
              <span class="meta" itemprop="datePublished"><time datetime="2012-10-01">October 01, 2012</time></span>
              <a itemprop="url" href="configuring_global_data_binding_formatters_in_spring_mvc.html"><h1 itemprop="name" itemprop="headline">Configuring global data-binding formatters in Spring MVC</h1></a>
	      <span itemprop="articleBody"><p>Here's a very quick how-to for configuring Spring-MVC (Spring 3.1.x) to use a global set of formatters for converting (data-binding) web-request and form parameters for use in Controllers, rather than having to have an <code>@InitBinder</code> annotated method in all your <code>@Controller</code>'s.</p>

<p>In your spring-web configuration:</p>

<pre><code>&lt;mvc:annotation-driven conversion-service="conversionService"/&gt;

&lt;!-- just to show that we can wire other beans into our registrar --&gt;
&lt;bean id="serviceA" class="com.sjl.myproject.ServiceA"/&gt;
&lt;bean id="serviceB" class="com.sjl.myproject.ServiceB"/&gt;

&lt;!-- Binding --&gt;    
&lt;bean 
  id="customFormatterRegistrar" 
  class="com.sjl.myproject.web.config.CustomFormatterRegistrar"&gt;
  &lt;constructor-arg ref="serviceA"/&gt;        
  &lt;constructor-arg ref="serviceB"/&gt;
&lt;/bean&gt;

&lt;bean 
  id="conversionService"
  class="
    org.springframework.format.support.FormattingConversionServiceFactoryBean"&gt;
  &lt;property name="formatterRegistrars"&gt;
    &lt;set&gt;
      &lt;ref local="customFormatterRegistrar"/&gt;
    &lt;/set&gt;
  &lt;/property&gt;
&lt;/bean&gt;
</code></pre>

<p>Be sure to add the "conversion-service" attribute (pointing at your conversionService bean) to the &lt;mvc:annotation-driven> element, otherwise it won't work!</p>

<p>The CustomFormatterRegistrar class:</p>

<pre><code>package com.sjl.myproject.web.config;

import org.springframework.format.*;
import com.sjl.myproject.*;

public class CustomFormatterRegistrar implements FormatterRegistrar {
    private ServiceA serviceA;
    private ServiceB serviceB;      

    // construct the registrar with other spring-beans as constructor args
    public CustomFormatterRegistrar(
        ServiceA aServiceA,
        ServiceB aServiceB) {
        serviceA = aServiceA;
        serviceB = aServiceB;
    }

    @Override
    public void registerFormatters(FormatterRegistry aRegistry) {
        aRegistry.addFormatter(new SomeTypeFormatter(serviceA));
        aRegistry.addFormatter(new OtherTypeFormatter(serviceB))
    }
}
</code></pre>

<p>An example formatter:</p>

<pre><code>package com.sjl.myproject.web.config;

import java.text.*;
import java.util.*;

import org.springframework.format.Formatter;

import com.sjl.myproject.*;

public class SomeTypeFormatter implements Formatter&amp;lt;SomeType&gt; {
    private ServiceA serviceA;

    public SomeTypeFormatter(ServiceA aServiceA) {
        serviceA = aServiceA;
    }

    @Override
    public String print(SomeType aSomeType, Locale aLocale) {
        return aSomeType..; // produce some string-based identifier
    }

    @Override
    public SomeType parse(String aText, Locale aLocale) throws ParseException {
        return serviceA.lookupByNameOrIdOrSomething(aText);
    }
}
</code></pre>

<p>And a Controller that benefits from it:</p>

<pre><code>package com.sjl.myproject.web.controllers;

import org.springframework.stereotype.*;
import org.springframework.web.bind.annotation.*;

import com.sjl.myproject.*;

@Controller
public class SomeController {
    public static final String URL = "path/with/{param1}/and/{param2}";

    @RequestMapping(SomeController.URL)
    public String blah(
        @PathVariable SomeType param1, 
        @PathVariable OtherType param2) {

        // .. do stuff with our typed params

        return "view-name";
    }
}
</code></pre>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Spring">Spring</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=MVC">MVC</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=data-binding">data-binding</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=convert">convert</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=format">format</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="configuring_global_data_binding_formatters_in_spring_mvc.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="669" description="A useful mechanism for instantiating beans in spring configuration using other beans defined in that configuration as factories.">
              <span class="meta" itemprop="datePublished"><time datetime="2012-09-14">September 14, 2012</time></span>
              <a itemprop="url" href="spring_config_for_parameterised_non_static_factory_methods.html"><h1 itemprop="name" itemprop="headline">Spring config for parameterised, non-static factory methods</h1></a>
	      <span itemprop="articleBody"><p>I recently discovered a nice way of using beans defined in your spring config as factories in the definition of other beans. </p>

<p>Its great, for example, when you want a factory that has non-static factory methods, or that relies on a bunch of other dependencies, or you want to instrument beans via some service which is itself a bean (this is what I was doing when I made this discovery). Here's how it looks..</p>

<p>A factory class whose factory-method is non-static and requires parameters:</p>

<pre><code>package com.sjl;

class Factory {
    private DependencyA depA;

    public Factory(DependencyA aDepA) {
        depA = aDepA;
    }

    public ResultType newInstance(DependencyB aDepB) {
        ResultType _result = ..; // use the deps to cook up result
        return _result;
    }
}
</code></pre>

<p>.. and a Spring XML config:</p>

<pre><code>&lt;bean id="depA" class="com.sjl.DependencyA"/&gt;
&lt;bean id="depB" class="com.sjl.DependencyB"/&gt;

&lt;bean id="factory" class="com.sjl.Factory"&gt;
  &lt;constructor-arg ref="depA"/&gt;
&lt;/bean&gt;

&lt;bean id="result" class="com.sjl.ResultType"
       factory-bean="factory" factory-method="newInstance"&gt;
   &lt;constructor-arg ref="depB"/&gt;
&lt;/bean&gt;
</code></pre>

<p>So what we have here is an <em>instance</em> of <code>Factory</code>, created with a dependency (depA), on which we invoke a non-static method <em>with arguments</em> to create our <code>ResultType</code>.</p>

<p>The bit that surprised me was the use of <code>&lt;constructor-arg&gt;</code> elements to define the parameters to pass to the factory method.</p>

<h2>Instrumentation</h2>

<p>If you followed any of my recent posts you'll know that I've been playing with dynamic proxies to create services that automagically decorate objects with instrumented versions. </p>

<p>As an example, in <a href="http://steveliles.github.com/dynamic_proxies_in_java.html">this post</a> I showed an <code>InstumentationService</code> which adds timing around method invocations.</p>

<p>I wanted to instrument several (about 8 actually) of my beans via a service that adds health monitoring, where the healthiness of a service is measured as a ratio of successful method invocations to unsuccessful ones (that throw exceptions).</p>

<p>The interface for instrumenting objects for health-monitoring looks like this:</p>

<pre><code>interface HealthServiceInstrumenter {
    public &lt;T&gt; T instrument(T aT);
}
</code></pre>

<p>So what I needed from Spring is: </p>

<ol>
<li>to create the instance of my <code>HealthServiceInstrumenter</code>,</li>
<li>to create the instances of various different <code>T</code> to pass through the <code>HealthServiceInstrumenter</code>, and</li>
<li>the tricky part - to get spring to create the instrumented bean of type <code>T</code> by passing the original bean through the instrumenter.</li>
</ol>

<p>Here's what the spring wiring looks like for that:</p>

<pre><code>&lt;bean id="health-instrumenter" class="com.sjl.HealthInstrumentationService"/&gt;

&lt;bean id="uninstrumented-bean-A" class="com.sjl.BeanA" 
        autowire-candidate="false"/&gt;

&lt;bean id="bean-A" class="com.sjl.BeanA"
       factory-bean="health-instrumenter" 
       factory-method="instrument"&gt;
   &lt;constructor-arg ref="uninstrumented-bean-A"/&gt;
&lt;/bean&gt;

&lt;bean id="uninstrumented-bean-B" class="com.sjl.BeanB" 
        autowire-candidate="false"/&gt;

&lt;bean id="bean-B" class="com.sjl.BeanB"
       factory-bean="health-instrumenter" 
       factory-method="instrument"&gt;
   &lt;constructor-arg ref="uninstrumented-bean-B"/&gt;
&lt;/bean&gt;
</code></pre>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Spring">Spring</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Factory">Factory</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="spring_config_for_parameterised_non_static_factory_methods.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="1,000" description="Making asynchronous Java programming easier with Implicit Futures.">
              <span class="meta" itemprop="datePublished"><time datetime="2012-09-09">September 09, 2012</time></span>
              <a itemprop="url" href="implicit_future_s_aka_promises.html"><h1 itemprop="name" itemprop="headline">Implicit Future's, aka Promises</h1></a>
	      <span itemprop="articleBody"><p><code>java.lang.concurrent.Future&amp;lt;T&gt;</code> is an example of an <em>explicit</em> future, where client code is well aware that the object it is handling is not a direct reference to the value of interest, and must invoke a method to obtain the value (<code>Future.get()</code> in the case of <code>java.lang.concurrent.Future</code>).</p>

<p>That's all very well, but if you have collaborators that expect to deal with the value <code>T</code> you have limited options: </p>

<p>You could invoke <code>get()</code> on your future, wait for it to be realised, then pass the realised value to the collaborators. This defeats the purpose of Future's, since what you really want is to do as much other work as possible before <code>future.get()</code> is called.</p>

<p>Alternatively, you could modify the collaborators to know that they are dealing with a Future. But you don't really want to do that either - its an implementation detail that they should not be concerned with.</p>

<p>What you really want is to pass around <em>implicit</em> futures that hide the fact that the object is anything other than a pojo. </p>

<p>You can create implicit futures by wrapping an explicit <code>future&lt;T&gt;</code> in an implementation of interface <code>T</code> and delegating all of the methods to <code>future.get().xxx()</code>. Here's what that might look like:</p>

<pre><code>// the type expected by client code
interface ExpensiveToCompute {
    public BigDecimal getValue1() throws Exception;
    public BigInteger getValue2() throws Exception;
}

interface Computer {
    public ExpensiveToCompute compute() throws Exception;
}

class SynchronousComputer {
    public ExpensiveToCompute compute() throws Exception {
        // ..
    }
}

// the implicit future, delegating to an explicit future
class ImplicitFutureExpensiveToCompute implements ExpensiveToCompute {
    private Future&amp;lt;ExpensiveToCompute&gt; delegate;

    public ImplicitFutureExpensiveToCompute(
        Future&amp;lt;ExpensiveToCompute&gt; aDelegate) {
        delegate = aDelegate;
    }

    public BigDecimal getValue1() throws Exception {
        delegate.get().getValue1();
    }

    public BigInteger getValue2() throws Exception {
        delegate.get().getValue2();
    }
}

// the async version that returns implicit futures
class AsynchronousComputer implements Computer {
    private ExecutorService executor = ..;
    private SynchronousComputer sync = ..;

    public ExpensiveToCompute compute() throws Exception {
        return new ImplicitFutureExpensiveToCompute(
            executor.submit(new Callable&amp;lt;ExpensiveToCompute&gt;() {
                public ExpensiveToCompute call() {
                    return sync.compute();
                }
            }));
    }
}
</code></pre>

<p>Pretty straight-forward, although there's quite a bit of boiler-plate, and i've passed the buck on exception handling.</p>

<p>This example is very simple, but things can get more involved if, for example, you want to use Future's overloaded <code>get(long timeout, TimeUnit units)</code> and handle timeouts appropriately (say, by returning a default value).</p>

<p>What if, instead of all this, you could pass your current synchronous implementation through some machinery that converted appropriately annotated methods to run asynchronously and return implicit futures, without the chore of having to create those classes yourself?</p>

<p>It might look like this:</p>

<pre><code>// the type expected by client code
interface ExpensiveToCompute {
    public BigDecimal getValue1() throws Exception;
    public BigInteger getValue2() throws Exception;
}

interface Computer {
    @ComputationallyExpensive
    public ExpensiveToCompute compute() throws Exception;
}


// the synchronous implementation - exact same as before
class SynchronousComputer implements Computer{
    public ExpensiveToCompute compute() throws Exception {
        // ..
    }
}

// the async version, returning implicit futures
class AsynchronousComputer implements Computer {
    private Computer async;

    public AsynchronousComputer(
        AsyncificationService anAsyncifier, Computer aDelegate) {
        async = anAsyncifier.makeAsync(aDelegate);
    }

    public ExpensiveToCompute doSomething() {
        return async.doSomething();
    }
}
</code></pre>

<p>This time we didn't need to create the implicit future implementation, cutting a whole lot of boiler-plate, and the async implementation got a fair bit simpler too. We marked the expensive method with an annotation so that the <code>AsyncificationService</code> knew to work its magic on that method.</p>

<p>There's a lot more useful stuff we can do when we have the machinery for converting synchronous methods to asynchronous methods that return implicit futures. For example we can transparently handle exceptions and return default values, or we can impose timeouts and return default values if we don't get a result in time, etc., etc.</p>

<p>If you want to see how we might implement such machinery, or want to try using it, fork the code for <a href="https://github.com/steveliles/implicit-futures">Implicit-Futures</a> from github.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Threads">Threads</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Concurrency">Concurrency</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Java">Java</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Future">Future</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Promise">Promise</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="implicit_future_s_aka_promises.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="1,297" description="A dynamic proxy example demonstrating how dynamic proxies can be used to provide behaviour "around" method calls on java classes that implement any arbitrary interface.">
              <span class="meta" itemprop="datePublished"><time datetime="2012-09-07">September 07, 2012</time></span>
              <a itemprop="url" href="dynamic_proxies_in_java.html"><h1 itemprop="name" itemprop="headline">Dynamic Proxies in Java</h1></a>
	      <span itemprop="articleBody"><p>Dynamic Proxies are a fantastic tool to have in your kit, and pretty easy to get up and running with. </p>

<p>A Dynamic Proxy is just what the name suggests: a proxy to a "normal" Java class, where the proxy is created dynamically - at runtime - and can be substituted instead of the proxied class. </p>

<p>If that still doesn't make sense, hopefully the example below will clear it up.</p>

<p>Lets imagine we want to be able to time the execution of <em>any</em> method on <em>any</em> implementation of <em>any</em> interface. We don't know or care what the interface is. We'll do this by passing the class that implements the interface to an "InstrumentationService", whose interface looks like this:</p>

<pre><code>public interface InstrumentationService {
    /**
     * @param aT - the object to be instrumented for monitoring
     * @return A polymorphically equivalent T which has been instrumented
     */
    public &amp;lt;T&gt; T instrument(T aT);
}
</code></pre>

<p>We'll get to the implementation of InstrumentationService shortly, but for now it should be clear that to instrument a class is as simple as this:</p>

<pre><code>private InstrumentationService instr;

public void doSomeStuff() {
    SomeInterface _si = new SomeClassThatImplementsIt();

    _si.doSomething(); // won't be timed

    _si = instr(_si);

    _si.doSomething(); // will be timed!
}
</code></pre>

<p>OK, so how can we implement InstrumentationService so that it can decorate arbitrary methods on as-yet-unknown interfaces? Enter Dynamic Proxies. </p>

<p>There are several rules and caveats to follow which I won't go into - they are documented pretty well <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/reflection/proxy.html">here</a>. For now it should suffice to say that you can only proxy interfaces (which is ok because you always <a href="http://www.artima.com/lejava/articles/designprinciples.html">program to interfaces</a> / <a href="http://en.wikipedia.org/wiki/Design_by_contract">design by contract</a> anyway, right?)</p>

<p>Here's an implementation of InstrumentationService that uses Dynamic Proxying:</p>

<pre><code>package com.sjl.example;

import java.lang.reflect.*;
import java.util.*;
import java.util.concurrent.*;

public abstract class DynamicInstrumentationService 
implements InstrumentationService {

    protected abstract void record(String anEvent, long aNanos);

    @SuppressWarnings("unchecked")
    @Override
    public &amp;lt;T&gt; T instrument(final T aT)
    {
        return (T) Proxy.newProxyInstance(
            aT.getClass().getClassLoader(), 
            aT.getClass().getInterfaces(), 
            new InvocationHandler() {
                @Override
                public Object invoke(
                    Object aProxy, Method aMethod, Object[] aArgs) 
                    throws Throwable 
                {
                    long _start = System.nanoTime();
                    try {
                        return aMethod.invoke(aT, anArgs);
                    } catch (InvocationTargetException anExc) {
                        throw anExc.getCause();
                    } finally {
                        record(_t.event(), System.nanoTime()-_start);
                    }
                }
            });
    }
}
</code></pre>

<p>So what do we have here?</p>

<ol>
<li>An abstract implementation of IntrumentationService which defers the actual recording of the timed value to a concrete subclass - you could extend and implement the <code>record</code> method to log to stdout, for example.</li>
<li>The <code>instrument</code> method creates a new Dynamic Proxy around the given class by invoking <code>Proxy.newInstance</code>. Notice that we use the classloader of the given class, and pass <em>all</em> of the interfaces it implements as types to be proxied.</li>
<li>The details of <em>what to do</em> when any method of the proxy is invoked are in the InvocationHandler, implemented here as an anonymous inner class. Its pretty simple - capture the clock time before the method is invoked; invoke the method; capture the clock time after the method completes; record the difference in time (after - before).</li>
</ol>

<p>Notice that when we invoke the proxied class's method, we wrap the invocation with a try/catch that catches InvocationTargetException, and if such an exception is thrown we propagate its <em>cause</em>, not the InvocationTargetException itself. This is just unwrapping an uninteresting layer of exceptions (which we added by using reflection to invoke the method) to get to the real problem.</p>

<p>This is a pretty simple example of what you can do with Dynamic Proxies. Even with this simple example its clear that you could modify it to, for example, record separate timings for successful invocations vs those that throw exceptions, or to only record timings for methods with annotations (e.g. you might create an @Timed annotation), etc., etc.</p>

<p>I should mention that there is a down-side to Dynamic Proxies: they use reflection to invoke the method of the proxied class, so there is a small performance penalty.</p>

<p>Lately I've been having all kinds of fun with Dynamic Proxies, from instrumentation (somewhat more complex than the above example) to monitoring service health (by escalating through warning statuses based on the ratio of successful/exceptional completion). </p>

<p>My favourite use so far: asynchronous execution of synchronous service calls, returning the result as a disguised/implicit <a href="http://en.wikipedia.org/wiki/Futures_and_promises">Future/Promise</a> with a coordinated Service Level Agreement cut-off . . . yeah anyways, that's a blog post for another day :) (update 09-09-2012: see <a href="https://github.com/steveliles/implicit-futures">Implicit-Futures</a>)</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Java">Java</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Dynamic Proxy">Dynamic Proxy</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Instrumentation">Instrumentation</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Timing">Timing</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="dynamic_proxies_in_java.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="3,991" description="Jetty embedded with Spring MVC is a great combination for building self-hosting web-apps of all kinds which are easy to maintain and deploy. Setting up is also easy (particularly if you use Maven), as you'll see in this post.">
              <span class="meta" itemprop="datePublished"><time datetime="2012-08-25">August 25, 2012</time></span>
              <a itemprop="url" href="setting_up_embedded_jetty_8_and_spring_mvc_with_maven.html"><h1 itemprop="name" itemprop="headline">Setting up embedded Jetty 8 and Spring MVC with Maven</h1></a>
	      <span itemprop="articleBody"><p>This is intended to be the first post in a series on building straight-forward web-apps with Spring-MVC and embedded Jetty. You can check out the complete source of this simple project from <a href="https://github.com/steveliles/jetty-embedded-spring-mvc">github</a>.</p>

<p>This post describes configuring your Jetty and Spring MVC with XML-based configuration. If you want to use annotations/java-config take a look at <a href="http://steveliles.github.com/setting_up_embedded_jetty_8_and_spring_mvc_with_maven_and_no_xml.html">this post</a>.</p>

<p>Its been a while since I last posted. I've been busy starting up two big projects at work, one using Google App Engine (and Spring MVC ;)), the other using Jetty 8 (embedded), Spring MVC, MongoDB and ElasticSearch.</p>

<p>The Jetty/Spring combination is one which I've used before - several times since Jetty-5/Spring-1.2 - and I really like. You just can't beat it for quick debug cycles, complete control of the environment, minimal configuration, single-jar deployment, etc., etc.</p>

<p>On this most recent project I'm using jsp as the view technology - this is probably the easiest way to go since most things "just work" out of the box. Other view technologies can be used too - for example last year we used this same combination with FreeMarker - its just a little more effort to get things wired up right.</p>

<p>Here's how I set my projects up:</p>

<h3>Maven POM</h3>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project 
 xsi:schemaLocation="
 http://maven.apache.org/POM/4.0.0 
 http://maven.apache.org/xsd/maven-4.0.0.xsd" 
 xmlns="http://maven.apache.org/POM/4.0.0" 
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;
&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

&lt;groupId&gt;com.sjl&lt;/groupId&gt;
&lt;artifactId&gt;webapp&lt;/artifactId&gt;
&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
&lt;name&gt;WebApp&lt;/name&gt;
&lt;description&gt;&lt;/description&gt;

&lt;repositories&gt;
  &lt;repository&gt;
    &lt;id&gt;springsource-repo&lt;/id&gt;
    &lt;name&gt;SpringSource Repository&lt;/name&gt;
    &lt;url&gt;http://repo.springsource.org/release&lt;/url&gt;
  &lt;/repository&gt;
&lt;/repositories&gt;

&lt;properties&gt;
  &lt;jetty.version&gt;8.1.5.v20120716&lt;/jetty.version&gt;
  &lt;jetty.jsp.version&gt;8.1.4.v20120524&lt;/jetty.jsp.version&gt;
  &lt;spring.version&gt;3.1.2.RELEASE&lt;/spring.version&gt;
&lt;/properties&gt;

&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
      &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt;
      &lt;version&gt;2.1.2&lt;/version&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;id&gt;attach-sources&lt;/id&gt;
          &lt;phase&gt;verify&lt;/phase&gt;
          &lt;goals&gt;
            &lt;goal&gt;jar-no-fork&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
    &lt;plugin&gt;
      &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
      &lt;version&gt;2.3.2&lt;/version&gt;
      &lt;configuration&gt;
        &lt;source&gt;1.6&lt;/source&gt;
        &lt;target&gt;1.6&lt;/target&gt;
      &lt;/configuration&gt;
    &lt;/plugin&gt;
    &lt;plugin&gt; 
      &lt;artifactId&gt;maven-eclipse-plugin&lt;/artifactId&gt; 
      &lt;configuration&gt; 
        &lt;downloadSources&gt;true&lt;/downloadSources&gt;
      &lt;/configuration&gt; 
    &lt;/plugin&gt; 
  &lt;/plugins&gt;    
&lt;/build&gt;

&lt;dependencies&gt;

  &lt;!-- SPRING DEPENDENCIES --&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
    &lt;version&gt;${spring.version}&lt;/version&gt;
  &lt;/dependency&gt; 
  &lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;
    &lt;version&gt;${spring.version}&lt;/version&gt;
  &lt;/dependency&gt;

  &lt;!-- JETTY DEPENDENCIES --&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;
    &lt;artifactId&gt;jetty-server&lt;/artifactId&gt;
    &lt;version&gt;${jetty.version}&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;
    &lt;artifactId&gt;jetty-servlet&lt;/artifactId&gt;
    &lt;version&gt;${jetty.version}&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;
    &lt;artifactId&gt;jetty-webapp&lt;/artifactId&gt;
    &lt;version&gt;${jetty.version}&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;
    &lt;artifactId&gt;jetty-servlets&lt;/artifactId&gt;
    &lt;version&gt;${jetty.version}&lt;/version&gt;
  &lt;/dependency&gt;

  &lt;!-- JSP and JSTL SUPPORT --&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;
    &lt;artifactId&gt;jetty-jsp&lt;/artifactId&gt;
    &lt;version&gt;${jetty.jsp.version}&lt;/version&gt;
  &lt;/dependency&gt;    
  &lt;dependency&gt;
    &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
    &lt;artifactId&gt;jstl&lt;/artifactId&gt;
    &lt;version&gt;1.2&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;/project&gt;
</code></pre>

<p>A couple of things worth pointing out:</p>

<ul>
<li>I've added the spring-source maven repo in order to get the spring dependencies</li>
<li>I'm using Jetty 8 from eclipse, who have taken over from codehaus (who took over from mortbay)</li>
<li>I'm attaching sources for all dependencies that make them available, so that you can drill down into the source while debugging</li>
<li>I'm setting the source and target jdk compliance to 6</li>
<li>I'm using Jetty-jsp 8.1.4 - many other jstl implementations I tried have bugs, including a nasty one where recursive calls in tag-files would not compile.</li>
<li>I've never really bothered with things like maven archetypes, which is probably lazy-stupid of me. I tend to start from a pom that i've created previously then modify it to suit my needs.</li>
</ul>

<p>After creating the pom in my project directory I create the <code>src/main/java</code> and <code>src/test/java</code> directories and then run <code>mvn eclipse:eclipse</code> to fetch the dependencies and create the eclipse .project and .classpath files. Having done that I import the project to Eclipse.</p>

<p>Once I have the project in Eclipse I create a few more directories - specifically the <code>META-INF/webapp/WEB-INF</code> directory to host my web.xml and spring context files (amongst other things).</p>

<p>I typically start with a spring application context and a spring web context, so I can specify beans at a larger scope than the web-application. Here's some simple example web and spring configs, all of which I place in WEB-INF:</p>

<h3>web.xml</h3>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns="http://java.sun.com/xml/ns/javaee" 
xmlns:web="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
xsi:schemaLocation="
  http://java.sun.com/xml/ns/javaee 
  http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
id="WebApp_ID" version="3.0"&gt;

&lt;listener&gt;
  &lt;listener-class&gt;
    org.springframework.web.context.ContextLoaderListener
  &lt;/listener-class&gt;
&lt;/listener&gt;

&lt;context-param&gt;
    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
    &lt;param-value&gt;
        /WEB-INF/application-context.xml
    &lt;/param-value&gt;
&lt;/context-param&gt;

&lt;!-- Handles all requests into the application --&gt;
&lt;servlet&gt;
    &lt;servlet-name&gt;Spring MVC Dispatcher Servlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;
      org.springframework.web.servlet.DispatcherServlet
    &lt;/servlet-class&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
        &lt;param-value&gt;/WEB-INF/web-context.xml&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;  

&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;Spring MVC Dispatcher Servlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;      

&lt;/web-app&gt;
</code></pre>

<h3>application-context.xml</h3>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:context="http://www.springframework.org/schema/context"
  xsi:schemaLocation="
http://www.springframework.org/schema/beans 
http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
http://www.springframework.org/schema/context 
http://www.springframework.org/schema/context/spring-context-3.0.xsd"&gt;

&lt;!-- Define your application beans here. They will be available to the
   beans defined in your web-context because it is a sub-context.

   Beans defined in the web-context will not be available in the 
   application context.
--&gt;

&lt;/beans&gt;
</code></pre>

<h3>web-context.xml</h3>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:context="http://www.springframework.org/schema/context"
  xmlns:mvc="http://www.springframework.org/schema/mvc"
  xsi:schemaLocation="
http://www.springframework.org/schema/mvc 
http://www.springframework.org/schema/mvc/spring-mvc-3.0.xsd
http://www.springframework.org/schema/beans 
http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
http://www.springframework.org/schema/context 
http://www.springframework.org/schema/context/spring-context-3.0.xsd"&gt;

&lt;!-- Configures the @Controller programming model --&gt;
&lt;mvc:annotation-driven/&gt;

&lt;!-- Forwards requests to the "/" resource to the "home" view --&gt;
&lt;mvc:view-controller path="/" view-name="index"/&gt;    

&lt;mvc:resources mapping="/i/**" location="WEB-INF/images/" /&gt;
&lt;mvc:resources mapping="/c/**" location="WEB-INF/css/" /&gt;
&lt;mvc:resources mapping="/s/**" location="WEB-INF/scripts/" /&gt;
&lt;mvc:resources mapping="/favicon.ico" 
  location="WEB-INF/images/favicon.ico" /&gt;

&lt;!-- Resolve jsp's --&gt;
&lt;bean id="viewResolver" 
  class="org.springframework.web.servlet.view.UrlBasedViewResolver"&gt;
    &lt;property name="viewClass" 
      value="org.springframework.web.servlet.view.JstlView"/&gt;
    &lt;property name="prefix" value="/WEB-INF/views/"/&gt;
    &lt;property name="suffix" value=".jsp"/&gt;
&lt;/bean&gt;

&lt;!-- i18n message source --&gt;
&lt;bean id="messageSource" 
  class="
    org.springframework.context.support.
      ReloadableResourceBundleMessageSource"&gt;
    &lt;property name="basename" value="/WEB-INF/i18n/messages" /&gt;
    &lt;property name="defaultEncoding" value="UTF-8"/&gt;
    &lt;property name="cacheSeconds" value="30" /&gt;
&lt;/bean&gt;

&lt;/beans&gt;
</code></pre>

<p>Some important things to note in this file are:</p>

<ul>
<li>We're using the annotation model for spring Controllers, hence there aren't any Controller beans specified in this xml</li>
<li>We're mapping static resources to be served efficiently by the Spring dispatcher servlet</li>
<li>We've set up a view resolver to look for jsp's in /WEB-INF/views. Note that when specifying a view in Controller code you drop the .jsp suffix.</li>
<li>We're configuring an internationalization message source, just so we can demonstrate use of a spring taglib a bit later...</li>
</ul>

<p>Now we need to create a class to set up the embedded Jetty.</p>

<h3>Embedded Jetty</h3>

<pre><code>package com.sjl;

import java.io.*;
import java.net.*;
import java.util.*;

import org.eclipse.jetty.server.*;
import org.eclipse.jetty.server.handler.*;
import org.eclipse.jetty.server.nio.*;
import org.eclipse.jetty.util.thread.*;
import org.eclipse.jetty.webapp.*;

/**
 * Example WebServer class which sets up an embedded Jetty 
 * appropriately whether running in an IDE or in "production" 
 * mode in a shaded jar.
 */
public class WebServer
{
    // TODO: You should configure this appropriately for 
    // your environment
    private static final String LOG_PATH = 
      "./var/logs/access/yyyy_mm_dd.request.log";

    private static final String WEB_XML = 
      "META-INF/webapp/WEB-INF/web.xml";
    private static final String CLASS_ONLY_AVAILABLE_IN_IDE = 
      "com.sjl.IDE";
    private static final String PROJECT_RELATIVE_PATH_TO_WEBAPP = 
      "src/main/java/META-INF/webapp";

    public static interface WebContext
    {
        public File getWarPath();
        public String getContextPath();
    }

    private Server server;
    private int port;
    private String bindInterface;

    public WebServer(int aPort)
    {
        this(aPort, null);
    }

    public WebServer(int aPort, String aBindInterface)
    {        
        port = aPort;
        bindInterface = aBindInterface;
    }

    public void start() throws Exception
    {
        server = new Server();

        server.setThreadPool(createThreadPool());
        server.addConnector(createConnector());
        server.setHandler(createHandlers());        
        server.setStopAtShutdown(true);

        server.start();       
    }

    public void join() throws InterruptedException
    {
        server.join();
    }

    public void stop() throws Exception
    {        
        server.stop();
    }

    private ThreadPool createThreadPool()
    {
        // TODO: You should configure these appropriately
        // for your environment - this is an example only
        QueuedThreadPool _threadPool = new QueuedThreadPool();
        _threadPool.setMinThreads(10);
        _threadPool.setMaxThreads(100);
        return _threadPool;
    }

    private SelectChannelConnector createConnector()
    {
        SelectChannelConnector _connector = 
            new SelectChannelConnector();
        _connector.setPort(port);
        _connector.setHost(bindInterface);
        return _connector;
    }

    private HandlerCollection createHandlers()
    {                
        WebAppContext _ctx = new WebAppContext();
        _ctx.setContextPath("/");

        if(isRunningInShadedJar())
        {          
            _ctx.setWar(getShadedWarUrl());
        }
        else
        {            
            _ctx.setWar(PROJECT_RELATIVE_PATH_TO_WEBAPP);
        }

        List&amp;lt;Handler&gt; _handlers = new ArrayList&amp;lt;Handler&gt;();

        _handlers.add(_ctx);

        HandlerList _contexts = new HandlerList();
        _contexts.setHandlers(_handlers.toArray(new Handler[0]));

        RequestLogHandler _log = new RequestLogHandler();
        _log.setRequestLog(createRequestLog());

        HandlerCollection _result = new HandlerCollection();
        _result.setHandlers(new Handler[] {_contexts, _log});

        return _result;
    }

    private RequestLog createRequestLog()
    {
        NCSARequestLog _log = new NCSARequestLog();

        File _logPath = new File(LOG_PATH);
        _logPath.getParentFile().mkdirs();

        _log.setFilename(_logPath.getPath());
        _log.setRetainDays(90);
        _log.setExtended(false);
        _log.setAppend(true);
        _log.setLogTimeZone("GMT");
        _log.setLogLatency(true);
        return _log;
    }  

    private boolean isRunningInShadedJar()
    {
        try
        {
            Class.forName(CLASS_ONLY_AVAILABLE_IN_IDE);
            return false;
        }
        catch(ClassNotFoundException anExc)
        {
            return true;
        }
    }

    private URL getResource(String aResource)
    {
        return Thread.currentThread().
            getContextClassLoader().getResource(aResource); 
    }

    private String getShadedWarUrl()
    {
        String _urlStr = getResource(WEB_XML).toString();
        // Strip off "WEB-INF/web.xml"
        return _urlStr.substring(0, _urlStr.length() - 15);
    }
}
</code></pre>

<p>Notice that here we try to load a class that will only ever be available if we're running in test mode (e.g. directly from Eclipse). </p>

<p>If the class is found we assume we're running in exploded form, otherwise we assume we're running in a shaded jar - this is so that we can use the correct path to locate the web resources. </p>

<p>If you're trying this out you must make sure that the com.sjl.IDE class exists in your test source tree!.</p>

<h3>Spring MVC Controller</h3>

<pre><code>package com.sjl.web;

import org.springframework.stereotype.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.*;

@Controller
public class Home {
    @RequestMapping("/")
    public ModelAndView home()
    {
        return new ModelAndView("index");
    }
}
</code></pre>

<p>A very simple Controller that simply tells Spring to render the index.jsp view when a request is made for the root of the web-app.</p>

<h3>index.jsp</h3>

<pre><code>&lt;%@taglib prefix="spring" uri="http://www.springframework.org/tags"%&gt;
&lt;html&gt;
  &lt;body&gt;
    &lt;p&gt;&lt;spring:message code="hello"/&gt;&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h3>messages.properties</h3>

<pre><code>hello=Hi
</code></pre>

<p>That's almost everything. You will need a couple of other little pieces, for example a main class to instantiate the WebServer.</p>

<h3>Project directory structure</h3>

<p>Your project directory structure should end up looking something like this:</p>

<pre><code>|_src
|___main
|_____java
|_______META-INF
|_________webapp
|___________WEB-INF
|_____________[web.xml and spring context configs here]
|_____________css
|_____________i18n
|_____________images
|_____________scripts
|_____________views
|_______________[jsp files here]
|_______com
|_________sjl
|___________web
|_____________[Spring MVC Controllers here]
|___test
|_____java
|_______com
|_________sjl
</code></pre>

<p>Check out the <a href="https://github.com/steveliles/jetty-embedded-spring-mvc">github project</a> for the complete working example.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Jetty">Jetty</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Embedded">Embedded</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Spring">Spring</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=MVC">MVC</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Maven">Maven</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="setting_up_embedded_jetty_8_and_spring_mvc_with_maven.html">Comment on this post</a>

            </div>
        </div>
        <div class="sidebar">
          <div>
            <div class="twitter-feed" show="4" account="steveliles">
              <h5>Recent Tweets</h5>            
              <ul class="tweets">
                <li class="tweet-template" style="display:none">        
                  <span class="text"></span>&nbsp;<span class="date" format="yyyy"></span>
                </li>
              </ul>
              <a href="https://twitter.com/steveliles" class="twitter-follow-button" data-show-count="false">Follow @steveliles</a>
	      <script src="//platform.twitter.com/widgets.js" type="text/javascript"></script>
            </div>
          </div>
          <div>
            <a href="article-archive.html"><h5>Recent Posts</h5></a>
            <ul>
                <li><a href="gwt_i18n_using_browser_locale.html">GWT i18n using browser locale</a><span class="date"> - Feb 27, 2013</span></li>
                <li><a href="cross_domain_inter_frame_communication_in_javascript.html">Cross-domain inter-frame communication in javascript</a><span class="date"> - Feb 05, 2013</span></li>
                <li><a href="subversion_1_7_eclipse_integration_in_ubuntu_12.html">Subversion 1.7 Eclipse integration in Ubuntu 12</a><span class="date"> - Nov 13, 2012</span></li>
                <li><a href="setting_up_embedded_jetty_8_and_spring_mvc_with_maven_and_no_xml.html">Setting up embedded Jetty 8 and Spring MVC with Maven and NO XML</a><span class="date"> - Nov 13, 2012</span></li>
                <li><a href="configuring_global_exception_handling_in_spring_mvc.html">Configuring global exception-handling in Spring MVC</a><span class="date"> - Oct 05, 2012</span></li>
            </ul>
            <a href="article-archive.html">Older posts...</a>
          </div>
        </div>
      </div>
      <div class="nav">
        <div class="links">
          <div class="prev"><a title="previous" href="index.html">Newer Posts</a></div>
          <div class="next"><a title="next" href="index_2.html">Older Posts</a></div>
        </div>
      </div>
    </div>
    <script type="text/javascript" language="javascript" src="blog/blog.nocache.js"></script>
  </body>
</html>

