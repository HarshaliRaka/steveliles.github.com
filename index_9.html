
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <link rel="stylesheet" href="css/styles.css" type="text/css" media="screen"/>
    <link rel="alternate" type="application/rss+xml" title="ExoMemory" href="http://steveliles.github.com/rss.xml" />
    <link href='http://fonts.googleapis.com/css?family=Gochi+Hand' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:700' rel='stylesheet' type='text/css'>
    <meta name="description" content="Thoughts on Java, GWT, programming, and other geek stuff"></meta>
    <script type="text/javascript" src="google-analytics.js"></script>
    <title>Steve Liles' Blog</title>
  </head>
  <body>
    <div>
      <div class="site-header">
        <div class="left">
          <a href="/index.html"><h2>Because I'll forget it if I don't write it down...</h2></a>
        </div>
        <div class="right">
	  <a rel="author" href="http://steveliles.github.com/about_me.html"><img src="images/lego-small.png"></a>
        </div>
      </div>
      <div class="nav">
        <span>
          <a rel="me" href="https://plus.google.com/105248011271585565954"><img src="https://ssl.gstatic.com/images/icons/gplus-16.png" width="16" height="16"></a>
          <a rel="me" href="http://www.twitter.com/steveliles"><img src="http://twitter-badges.s3.amazonaws.com/t_mini-a.png" alt="Follow steveliles on Twitter"></a>
	  <a rel="me" href="http://uk.linkedin.com/in/steveliles"><img src="http://www.linkedin.com/img/webpromo/btn_in_20x15.png" width="20" height="15" alt="View my LinkedIn profile"></a>
	  <form action="http://www.google.com/search" method="get">
            <input type="hidden" name="q" value="site:steveliles.github.com">
            <input type="text" name="q" placeholder="search"></input>
          </form>
	  <a href="rss.xml"><img src="images/rss.png" width="16" height="16" alt="Subscribe to RSS feed"></a>
        </span>
      </div>
      <div class="content">
        <div class="main">
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="637" description="My travails with getting google to use the microformat, rich-snippets and rel=author information on my blog">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-24">November 24, 2011</time></span>
              <a itemprop="url" href="microformats_rich_snippets_rel_author_and_search_listings.html"><h1 itemprop="name" itemprop="headline">Microformats, rich snippets, rel=author, and search listings</h1></a>
	      <span itemprop="articleBody"><p>Whilst moving my blog from Blogger to github pages I've been looking into various ways to bump up my traffic. </p>

<p>I came across <a href="http://schema.org">schema.org</a> microformats some time ago and read about plans from Google, Yahoo and Microsoft to support them. I implemented the <a href="http://schema.org/BlogPosting">BlogPosting</a> microformat to mark up my posts "semantically", and waited to see what google would make of it.</p>

<p>I admit, I was pretty excited at the thought of my search listings being presented in a more interesting fashion - I think that would really make them stand out. Here's an example of what Google's "rich snippets" testing tool makes of my articles:</p>

<p><img src="https://lh5.googleusercontent.com/-svXxV_v3GEM/Ts7iHUCNneI/AAAAAAAAHyY/lpTiC3ZKFI0/s867/rich-snippets.png" alt="rich snippets info for one of my blog posts" /></p>

<p>Unfortunately to-date it hasn't made a great deal of difference to how my posts are presented in a google search result.</p>

<p><img src="https://lh6.googleusercontent.com/-56_YwrdGwv4/Ts7VbPtTwHI/AAAAAAAAHw8/s__A_feIMnY/s600/search-listing.png" alt="google search listing" /></p>

<p>The first result in that listing image is for my blog. The only difference I see is that my blog result shows a date (which is nice, but I'm not sure its there because of the rich snippets markup - my old blogger blog shows dates like this too, and currently has no metadata markup that I can spot in the html source).</p>

<p>So much for rich snippets. </p>

<p>More recently I came across <code>rel=author</code>, and again I've been quite excited to try it out. This time I checked before-hand and found a handful of webby types who've got this working on their blogs. Here's what they look like:</p>

<p><img src="https://lh4.googleusercontent.com/-j1PTvhmppyU/Ts7XnanwE-I/AAAAAAAAHxs/N4Z7toDlRN0/s600/rel-author-search-listing.png" alt="google search listing with rel=author" /></p>

<p>A couple of weeks later I'm still having a bit of a trial getting this to work. I've done the setup exactly as described by google and a bunch of these other guys who've got it working - no joy. I'm using the three-way setup as follows:</p>

<ul>
<li>From each blog post, link to my about page with rel="author" (I've linked the lego man image at top-right in the header).</li>
<li>From my about page, link to my google profile with rel="me" (I have two links, one <code>&lt;link rel="me"&gt;</code> in the <code>&lt;head&gt;</code>, and one in an <code>&lt;a rel="me" ..</code> in the G+ icon in the navigation bar just below the header.</li>
<li>From my google profile, create a contributes-to link back to my about page.</li>
</ul>

<p>The reason for this set of reciprocal links is so that google can trust that the content really is produced by you, and its no hard-ship to set up. Except that for some reason I can't fathom it just <em>doesn't work for me</em>.</p>

<p>The rich-snippets testing tool gives me the all-clear, and even shows an example search listing:</p>

<p><img src="https://lh3.googleusercontent.com/-DKGP9ZJF8G0/Ts7aVKcwJiI/AAAAAAAAHyE/ZHCauxKCvYM/s600/rich-snippets-search-listing.png" alt="" /></p>

<p>I've tried about a dozen variants now, each time waiting for a re-index before trying something different (you can tell when you've been indexed using Google's <a href="http://www.google.com/webmasters/tools/">Webmaster Tools</a>).</p>

<p>So far I've tried:</p>

<ul>
<li>Relative links between blog-post and about page</li>
<li>Absolute links between blog-post and about page</li>
<li>All links as <code>&lt;link&gt;</code> elements in the <code>&lt;head&gt;</code></li>
<li>All links as <code>&lt;a&gt;</code> elements in the page <code>&lt;body&gt;</code></li>
<li>All combinations of the above alternatives</li>
</ul>

<p>I have a few remaining alternatives in the works. One is to remove all rel=me links to profiles other than google (I currently also have twitter and linked-in profiles linked with rel=me). </p>

<p>Another is to add a link to my google+ profile in an <code>&lt;a href="https://plus.google.com/105248011271585565954?rel=author"&gt;Steve+&lt;/a&gt;</code> (yes, with the + at the end of the link text - see <a href="http://www.google.com/support/webmasters/bin/answer.py?answer=1408986">option 2, here</a>). </p>

<p>There's also <a href="https://spreadsheets.google.com/spreadsheet/viewform?formkey=dHdCLVRwcTlvOWFKQXhNbEgtbE10QVE6MQ">this form</a> which sounds tantalisingly like it might be a necessary part of the process, and which I hadn't previously seen mentioned anywhere. I've submitted the form, but a bit of googling suggests that it will make no difference.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=rel=author">rel=author</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=rich snippets">rich snippets</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=microformats">microformats</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=schema.org">schema.org</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="microformats_rich_snippets_rel_author_and_search_listings.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="680" description="How to create a CSS selector that does not match for individual uses of the classes, but matches on elements that are assigned the intersection of the css classes">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-24">November 24, 2011</time></span>
              <a itemprop="url" href="a_multi_class_union_css_selector.html"><h1 itemprop="name" itemprop="headline">A multi-class union CSS selector</h1></a>
	      <span itemprop="articleBody"><p><em>Update:</em> In the original post I got my terminology all wrong, including in the title. Changing the title would move the post and lose the comments, so I've left the title unchanged. The title of this post should actually always have been:</p>

<h1>A multi-class intersection CSS selector</h1>

<p><style> <br />
  .urgent { color:red; }
  .important { font-weight:bold; }
  .urgent.important { font-style:italic; }
</style>
Several times while working on the styling of this blog I've wanted to style elements differently when the complete combination or set intersection of css classes are used on the same element. If the css classes are applied separately the style should not apply. Until today I didn't realise that this is, in fact, both possible and easy to achieve.</p>

<p>Here's the html I want to be able to write:</p>

<pre><code>&lt;div class="urgent"&gt;something urgent&lt;/div&gt;
&lt;div class="important"&gt;something important&lt;/div&gt;
&lt;div class="urgent important"&gt;urgent &amp; important&lt;/div&gt;
</code></pre>

<p>And this is how that should look:</p>

<div class="example">
  <div class="urgent">something urgent</div>
  <div class="important">something important</div>
  <div class="urgent important">urgent & important</div>
</div>

<p>The urgent &amp; important text should be bold, red and italic in your browser. Notice that neither the "urgent" or the "important" are italic - that only comes when both css classes combine on the same element.</p>

<p>Here are three ways you can achieve the effect. Make sure you get to option-3, even if you have to skip options 1 and 2 (hint: they both suck).</p>

<h3>Option 1: specific, separate css class</h3>

<pre><code>&lt;style&gt;
  .urgent { color:red; }
  .important { font-weight:bold; }
  .both   { font-style:italic; }
&lt;/style&gt;

&lt;div class="urgent"&gt;Red Text&lt;/div&gt;
&lt;div class="important"&gt;Bold Red Text&lt;/div&gt;
&lt;div class="urgent important both"&gt;Bold Italic Red Text&lt;/div&gt;
</code></pre>

<p>This is nasty. I want to define my css classes to be as orthogonal and meaningful as possible, and while creating my html markup I do not want to be "mixing concerns" that should be kept separate.</p>

<h3>Option 2: nested html tags and ancestry selectors</h3>

<pre><code>&lt;style&gt;
  .urgent { color:red; }
  .important { font-weight:bold; }
  .urgent .important { font-style:italic }
&lt;/style&gt;

&lt;div class="urgent"&gt;Red Text&lt;/div&gt;
&lt;div class="important"&gt;Bold Red Text&lt;/div&gt;
&lt;div class="urgent"&gt;
  &lt;div class="important"&gt;Bold Italic Red Text&lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>Double nasty, take it away! Now I've had to change my html markup to nest <code>.important</code> under <code>.urgent</code>, just so I can style things as I want them. It also doesn't work if I nest them the other way around. This is really stupid and annoying: styling should be separate from markup.</p>

<p>OK, so here's the right way to do it, and I just can't believe it took me so long to feel the pain hard enough to go looking for a solution...</p>

<h3>Option 3: use the sub-set* selector</h3>

<pre><code>&lt;style&gt;
  .urgent { color:red; }
  .important { font-weight:bold; }
  .urgent.important { font-style:italic; }
&lt;/style&gt;

&lt;div class="urgent"&gt;Red Text&lt;/div&gt;
&lt;div class="important"&gt;Bold Text&lt;/div&gt;
&lt;div class="urgent important"&gt;Bold Italic Red Text&lt;/div&gt;
</code></pre>

<p>The difference in the css declaration between option-2 and option-3 is so small I'll point it out, just in case you missed it: </p>

<ul>
<li>the selector uses <em>both</em> class names <em>without</em> the space separating them - like this <code>.urgent.important</code>.</li>
<li>whereas the example in option-2 <code>.urgent .important</code> separates the two classes with a space, and matches on an element with <code>.important</code> descending from an element with <code>.urgent</code>.</li>
</ul>

<p>CSS can be a thumping great pain, but just occasionally it comes up trumps.</p>

<p>* I can't find an "official" name for this type of selector. The <a href="http://www.w3.org/TR/CSS2/selector.html#class-html">section of the css spec that covers this</a> doesn't name it other than referring to matching sub-sets. "Intersection Selector" seems like a good name to me, although "Dude McManus" in the comments calls it an "Exclusion Selector".</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=css">css</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=selector">selector</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=intersection">intersection</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="a_multi_class_union_css_selector.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="1,218" description="Description, code and sample images from various image processing techiques aiming at producing a bitmap with a vectorised appearance">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-19">November 19, 2011</time></span>
              <a itemprop="url" href="weighted_average_smoothing_with_java2d.html"><h1 itemprop="name" itemprop="headline">Weighted Average smoothing with Java2d</h1></a>
	      <span itemprop="articleBody"><p>Since my <a href="">original post</a> I've done a little bit more playing with processing images to try to give them a "vectorised" look. I really didn't change much, just played with the algorithm for choosing pixel colour. The algorithms all work by examining the colours of the current and surrounding pixels to determine what colour to paint the current pixel. The colour selection is performed by classes that implement the following simple interface:   </p>

<pre><code>interface Counter {
    // add a colour channel value for one of 
    // the neighbouring pixels
    public void add(int aValue);

    // calculates the value we should use
    // for the current colour channel of the
    // current pixel based on its neighbours
    public int mostFrequent();
}
</code></pre>

<p>The client code that deals this interface invokes the add method 3 times for each pixel - once for each colour channel (red / green /blue). The client code looks like this:</p>

<pre><code>// calculate the colour 
private int count(int anOffset, int[] aSurrounding) {
    Counter _c = getCounter();
    int _length = aSurrounding.length-(2-anOffset);
    for (int i=anOffset; i&amp;lt;_length; i+=3) {
        _c.add(aSurrounding[i]);
    }
    return _c.mostFrequent();
}
</code></pre>

<p>Here you can see that I can easily supply different implementations of Counter, so I can try different algorithms easily.</p>

<h3>The original colour-selection algorithm</h3>

<p>The original algorithm simply takes the most frequent value of each colour channel so that, for example, if 51% of the surrounding pixels are bright blue, and the other 49% are bright red, this pixel will be bright red.</p>

<pre><code>class SimpleCounter implements Counter {
    int[] values = new int[256];

    public SimpleCounter() {
        Arrays.fill(values, -1);
    }

    public void add(int aValue) {
        values[aValue] += 1;
    }

    public int mostFrequent() {
        int _highest = -1;
        int _colour = -1;
        for (int i=0; i&amp;lt;256; i++) {
            if (values[i] &amp;gt; _highest) {
            _highest = values[i];
            _colour = i;
            }
        }
        return _colour;
    }
}
</code></pre>

<p>This algorithm does produce the effect I'm looking for, but I get some sharp edges and colour bleeding that I don't really want (see example output below).</p>

<h3>The weighted-average algorithm</h3>

<p>This algorithm weights the values of the surrounding pixels relative to the most common value, so we get a weighted average that does take some account of less popular colours in the neighbourhood of the current pixel.</p>

<pre><code>class WeightedAverageCounter implements Counter {
    int[] values = new int[256];

    public WeightedAverageCounter() {
        Arrays.fill(values, 0);
    }

    public void add(int aValue) {
        values[aValue] += 1;
    }

    public int mostFrequent() {
        int _max = max();
        double _weight=0, _colour=0, _count=0;
        for (int i=0; i&amp;lt;256; i++) {
            if (values[i] &gt; 0) {
                _weight = (((double)values[i]) / _max);
                _weight = Math.pow(_weight, 5);
                _colour += _weight * i;
                _count += _weight;
            }
        }
        return (int) (_colour / _count);
    }

    private int max() {
        int _highest = 0;
        for (int i=0; i&amp;lt;256; i++) {
            if (values[i] &gt; _highest) {
                _highest = values[i];
            }
        }
        return _highest;
    }
}
</code></pre>

<p>The result of the weighted average algorithm is a much smoother colour composition with a reduction in the aliasing effects that can be seen in the more simple algorithm's output. It does have a significant performance penalty however - on my quad core i7 laptop on an image of 600x650 pixels and a 16x16 neighbourhood, the simple algorithm completes in 10 seconds, whereas the weighted-average needs 90 seconds!</p>

<h3>Output for comparison</h3>

<p>Here are some examples for comparison. First is the original image, then then the image processed with the simple colour selection algorithm, followed by the weighted average algorithm.</p>

<p><img alt="The original photograph" width="600" height="654" src="https://lh3.googleusercontent.com/-zPwUf1ZwEes/TsfLHPhDT0I/AAAAAAAAHuI/Rpt4as1QyIE/s600/duck.jpg"></p>

<div class="caption">The original image</div>

<p><img alt="Processed with 'Simple' algorithm" width="600" height="654" src="https://lh6.googleusercontent.com/--uqph05DLD4/TsfLMt4MJ3I/AAAAAAAAHuU/aJ_bXBLOFEw/s600/duck-16x16-simple.png"></p>

<div class="caption">Processed with 'Simple' algorithm</div>

<p><img alt="Processed with 'Weighted Average' algorithm" width="600" height="654" src="https://lh5.googleusercontent.com/-C6hRgaQDTtA/TsfLRfOMKLI/AAAAAAAAHuc/gLLTePCCUfo/s600/duck-16x16-weighted-average.png"></p>

<div class="caption">Processed with 'Weighted Average' algorithm</div>

<p>It might be a little difficult to see the difference, so here's one final composite image showing the difference close-up and side-by-side</p>

<p><img alt="composite - left-side 'simple', right-side 'weighted average'" width="600" height="327" src="https://lh6.googleusercontent.com/-i6hEeV2vdC0/TsfYihtEPaI/AAAAAAAAHu8/Yx2b4FTSvBM/s600/duck-composite.jpg"></p>

<div class="caption">Composite for comparison</div>

<p>The left-side shows the image processed with the simple algorithm, whilst the right-side shows the smoother result of the weighted-average algorithm.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Image">Image</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Processing">Processing</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Java2D">Java2D</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Convolve">Convolve</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Kernel">Kernel</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Vectorize">Vectorize</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="weighted_average_smoothing_with_java2d.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="421" description="Description and code samples for a mortgage or loan overpayment calculator written using Google Web Toolkit and progressive enhancement techniques">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-17">November 17, 2011</time></span>
              <a itemprop="url" href="mortgage_loan_overpayment_calculator.html"><h1 itemprop="name" itemprop="headline">Mortgage/Loan Overpayment Calculator</h1></a>
	      <span itemprop="articleBody"><p>A few weeks back I was talking with someone who was looking into over-paying a loan. The premise is that, provided your lender allows overpayments, by over-paying you can save a fortune in interest payments.</p>

<p>The amount you can save isn't all that straight-forward to work out, due to the miracle that is compound interest. I knocked up a quick <a href="http://www.overpayment-calculator.com/">overpayment calculator</a> using <code>gwt.progressive</code>, which I'm <a href="hosting_a_static_website_in_amazon_s3.html">hosting at Amazon S3</a> with a <a href="pointing_a_domain_name_to_an_amazon_s3_bucket.html">registered domain name</a>.</p>

<p>Here's one of the classes that's being bound - or "activated" if you like - by gwt.progressive:</p>

<pre><code>public class OverpaymentSummary extends Composite {
    interface MyActivator extends WidgetActivator&amp;lt;OverpaymentSummary&gt;{}
    MyActivator activator = GWT.create(MyActivator.class);

    @RuntimeUiWidget(id="saving") InlineLabel saving;
    @RuntimeUiWidget(id="years") InlineLabel years;
    @RuntimeUiWidget(id="months") InlineLabel months;

    public OverpaymentSummary(Element anElement) {
        initWidget(activator.activate(this, anElement));
    }

    public void setResults(
        Money aStandardTotal, int aStandardMonths, 
        Money anOverpaidTotal, int anOverMonths) {
        saving.setText(aStandardTotal.minus(anOverpaidTotal).toString());

        int _monthsSaved = aStandardMonths - anOverMonths;
        setYears(_monthsSaved/12);
        setMonths(_monthsSaved - ((_monthsSaved/12)*12));

        removeStyleName("hidden");
    }

    private void setYears(int aYears) {
        years.setText(""+aYears);
    }

    private void setMonths(int aMonths) {
        months.setText(""+aMonths);
    }
}
</code></pre>

<p>Which is bound onto html that looks like this:</p>

<pre><code>&amp;lt;div class="summary hidden"&gt;By overpaying you could save
&amp;lt;span id="saving"&gt;???&amp;lt;/span&gt;, and reduce your mortgage 
term by &amp;lt;span id="years"&gt;?&amp;lt;/span&gt; years and 
&amp;lt;span id="months"&gt;?&amp;lt;/span&gt; months!&amp;lt;/div&gt;
</code></pre>

<p>Notice the <code>&amp;lt;span&gt;</code> elements with the id's "saving", "years", and "months" - these are bound automatically to the three <code>InlineLabel</code>'s annotated with <code>@RuntimeUiWidget</code>.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Mortgage">Mortgage</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Loan">Loan</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Overpayment">Overpayment</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Calculator">Calculator</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=GWT">GWT</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="mortgage_loan_overpayment_calculator.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="2,956" description="Description, code and sample images from various image processing techiques aiming at producing a bitmap with a vectorised appearance">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-16">November 16, 2011</time></span>
              <a itemprop="url" href="creating_a_vectorisation_effect_with_java2d.html"><h1 itemprop="name" itemprop="headline">Creating a "Vectorisation" effect with Java2D</h1></a>
	      <span itemprop="articleBody"><p>On my <a href="http://steveliles.github.com/about_me.html">about me</a> page I have a picture of myself wearing a stupid hat and an even more stupid grin. This picture started out as an old photograph from which I removed the background using GIMP, then vectorized using an online tool called <a href="http://vectormagic.com/home">Vector Magic</a>.</p>

<p>Vector Magic is a very cool tool - it converts bitmap's to vector images by "tracing" the bitmap. Once vectorised you can rescale the image as large as you like without losing the smooth edges.</p>

<p>Here are the two images of me - on the left is the bitmap (before vectorisation) and on the right is a bitmap of the vectorized image created by Vector Magic (I vectorised the image for the comic-book <em>effect</em> of vectorisation, not in order to use the vector image itself):</p>

<table>
  <tr>
    <td><img src="https://lh5.googleusercontent.com/-TW1qOjU0mxY/TsQyq8NZ8mI/AAAAAAAAHpw/o2s_M3fUDNk/s291/before.png"></td>
    <td><img src="https://lh6.googleusercontent.com/-okVBiU07UVo/TsQyq2py0HI/AAAAAAAAHps/Wk7l-acfBxY/s281/after.png""></td>
  </tr>
</table>

<p>Hopefully you can see the effect I'm talking about - large areas of colour are blocked out, and generally you get a kind of comic-book or oil-painting effect.</p>

<p>After vectorizing that image I started wondering how it worked and if I could whip up something myself, and so I began playing with Java2D to see if I could get close.</p>

<h2>"Hatching" the image</h2>

<p>I began my efforts with a very simple approach of testing pixels in each row and "dragging" a pixel colour across adjacent pixels until I encounter a pixel with a significantly different colour, at which point I swap the current colour and repeat the process.</p>

<p>Thanks to Java2D doing all the heavy lifting, the code is pretty short:</p>

<pre><code>public void hatch() {
    // load the image and extract the raster data
    BufferedImage _img = loadImage("cat.jpg");
    Raster _raster = _img.getData();

    // prepare a new raster to write the hatched
    // version of the image to
    BufferedImage _copy = new BufferedImage(
        _img.getWidth(), _img.getHeight(), _img.getType());
    WritableRaster _writable = _copy.getRaster();

    double[] _current = new double[3];
    double[] _previous = new double[3];
    double[] _write = new double[3];

    int _threshold = 75;

    for (int y=0; y&amp;lt;_img.getHeight(); y++) {
        for (int x=0; x&amp;lt;_img.getWidth(); x++) {
            // for each pixel in the image, decide whether
            // to use its original colour, or to drag in the
            // colour of a preceding pixel
            _current = _raster.getPixel(x, y, _current);
            _write = decide(_previous, _current, _threshold);
            _writable.setPixel(x, y, _write);
            _previous = Arrays.copyOf(_write, _write.length);
        }
    }

    // save the result to a new png file
    ImageIO.write(_copy, "png", new File("cross-hatch.png"));
}

private double[] decide(double[] aThis, double[] aThat, int aThreshold) {
    for (int i=0; i&amp;lt;aThis.length; i++) {
        if (Math.abs(aThis[i] - aThat[i]) &amp;gt; aThreshold) {
            return aThat;
        }
    }
    return aThis;
}
</code></pre>

<p>This has an interesting arty effect of "hatching" the image, but before the vectorisation effect becomes significant I start to get colour runs, where the colour gets dragged too far. </p>

<p>I played around with combining vertical and horizontal (and even diagonal) hatching with lower thresholds, which again produces a nice arty effect - particularly on hi-res images, but it isn't really the effect i'm looking for.</p>

<p>Below are some (lo-res) examples, using a high threshold value to make the effect more pronounced.</p>

<table>
  <tr>
    <th><img src="https://lh6.googleusercontent.com/-WaE9HVjyP00/TsQ5Mnf749I/AAAAAAAAHqY/QhN9JEmDW8o/s290/cat.jpg"><div class="caption">original image</div></th>
    <th><img src="https://lh6.googleusercontent.com/-TMtXRSp3G68/TsQ5QdqoajI/AAAAAAAAHqg/7axdHs9O34I/s290/vertical.png"><div class="caption">vertical hatching</div></th>
  </tr>
  <tr>
    <th><img src="https://lh5.googleusercontent.com/-iwdfREXJWx8/TsQ5o1FhKXI/AAAAAAAAHqo/MsgbftSuYs4/s290/horizontal.png"><div class="caption">horizontal hatching</div></th>
    <th><img src="https://lh4.googleusercontent.com/-nsB6SodNjCg/TsQ6A0HMeJI/AAAAAAAAHq8/KPhxcJyPEQ4/s290/cross-hatch.png"><div class="caption">cross hatching</div></th>
  </tr>
</table>

<p>If you look carefully at certain areas of the images you can see the colour runs - for example on the dark area just where the cats leg joins its body at bottom right of the image, you can see the lighter brown vertical lines in the vertical-hatching image, and similar horizontal lines in the horizontal hatching image.</p>

<p>Notice that the cross-hatching image is starting to get the blocky effect somewhat similar to vectorisation, but pushing the thresholds high enough to create significant blocks of colour ruins the overall effect by dragging too much colour across the image.</p>

<p>I tried various techniques to reduce the drag effect - including an inverse-square factor of the distance since the colour was first encountered. This did indeed smooth things quite a bit, but still doesn't achieve the effect i'm looking for. Time for a new approach.</p>

<h2>Edge Detection</h2>

<p>Next I pondered some obvious techniques like edge detection. The classic mechanism for edge detection is to apply a filter, or convolution kernel, where each pixel is treated with respect to several surrounding pixels. Simple edge detection kernels look something like this:</p>

<table style="width:auto; margin:auto;">
  <tr>
    <th>
      <table style="width:90px; border:1px solid black; margin:20px;">
        <tr>
      <th class="caption">-1</th>
      <th class="caption">0</th>
      <th class="caption">1</th>
    </tr>
    <tr>
      <th class="caption">-2</th>
      <th class="caption">0</th>
      <th class="caption">2</th>
    </tr>
    <tr>
      <th class="caption">1</th>
      <th class="caption">0</th>
      <th class="caption">1</th>
    </tr>
      </table>
      <div class="caption">Horizontal</div>
    </th>
    <th>
      <table style="width:90px; border:1px solid black; margin:20px;">
        <tr>
      <th class="caption">-1</th>
      <th class="caption">-2</th>
      <th class="caption">-1</th>
    </tr>
    <tr>
      <th class="caption">0</th>
      <th class="caption">0</th>
      <th class="caption">0</th>
    </tr>
    <tr>
      <th class="caption">1</th>
      <th class="caption">2</th>
      <th class="caption">1</th>
    </tr>
      </table>
      <div class="caption">Vertical</div>
    </th>
  </tr>
</table>

<p>Here's what running the "horizontal" edge-detection kernel on the cat image produces:</p>

<table>
  <tr>
    <th>
      <img src="https://lh3.googleusercontent.com/-ISL5K81GcKQ/TsRF_VK5KYI/AAAAAAAAHrY/xov4o7PQkMQ/s290/horiz-edge.png">
      <div class="caption">Edge Detected</div>
    </th>
  </tr>
</table>

<p>And the code for that, again made very simple by Java2D's built in convolution support:</p>

<pre><code>public void edgeDetect() throws Exception {
    BufferedImage _input = loadImage("cat.jpg");
    BufferedImage _horiz = convolve(_input, newHorizontalKernel());
    ImageIO.write(_horiz, "png", new File("edge.png"));
}

private BufferedImage convolve(BufferedImage anImage, Kernel aKernel) {
    BufferedImage _out = new BufferedImage(
        anImage.getWidth(), anImage.getHeight(), anImage.getType());

    ConvolveOp _op = new ConvolveOp(aKernel, ConvolveOp.EDGE_NO_OP, null);
    _op.filter(anImage, _out);

    return _out;
}

private Kernel newHorizontalKernel() {
    return new Kernel(3, 3, new float[] {
        -2, -4, -2,
        0, 0, 0,
        2, 4, 2
    });
}

private Kernel newVerticalKernel() {
    return new Kernel(3, 3, new float[] {
        -2, 0, 2,
        -4, 0, 4,
        -2, 0, 2
    });
}
</code></pre>

<p>This is a neat result, and probably I could use the edges thus detected as indicators of where to switch colours, but this just seems like a very round-about way of producing what i want. Time for a new approach.</p>

<h2>Convolution with a dynamic kernel</h2>

<p>After scratching my head for a while I figured that what I really want to do is somewhere between the two approaches outlined above. I want to use a weighted function of the surrounding pixels (like a convolution kernel), but I want to do something a bit more complex than I can achieve with a static convolution kernel.</p>

<p>After quite a bit more monkeying around I finally nailed it. This time I'm examining pixels around the current one, finding the most common value for each colour channel, and giving the current pixel the most common value for each colour channel. Strictly speaking this isn't a convolution operation at all, but the analogy is a useful one.</p>

<p>I get some slightly funky alias effects on some images, so my next task is to smooth that out, but overall the results are very close to what I was after.</p>

<p>Here's the code:</p>

<pre><code>public void vectorEffect()
throws Exception
{
    BufferedImage _img = loadImage("cat.jpg");
    Raster _raster = _img.getData();

    BufferedImage _copy = new BufferedImage(
        _img.getWidth(), _img.getHeight(), _img.getType());
    WritableRaster _writable = _copy.getRaster();

    int _blockWidth = 8;
    int _blockHeight = 8;

    int _halfWidth = _blockWidth / 2;
    int _halfHeight = _blockWidth / 2;

    int[] _lens = new int[(_blockWidth * _blockHeight) * 3];

    for (int y=0; y&amp;lt;_img.getHeight(); y++) {
        for (int x=0; x&amp;lt;_img.getWidth(); x++) {
            // get the surround NxM pixel grid as a
            // one dimensional array of r,g,b values
            _lens = _raster.getPixels(
                Math.max(0, x-_halfWidth), 
                Math.max(0, y-_halfHeight), 
                Math.min(_img.getWidth()-x, _blockWidth), 
                Math.min(_img.getHeight()-y, _blockHeight), 
                _lens
            );
            _writable.setPixel(x, y, getPixelColour(_lens));
        }
    }

    ImageIO.write(_copy, "png", new File("vector-effect.png"));
}

// choose the colour for the current pixel by finding the most
// common value for each colour channel in the surrounding pixels
private int[] getPixelColour(int[] aSurrounding) {
    int[] _result = new int[3];
    _result[0] = mostFrequent(0, aSurrounding);
    _result[1] = mostFrequent(1, aSurrounding);
    _result[2] = mostFrequent(2, aSurrounding);
    return _result;
}

// find the most frequent colour level for a given channel
// within the surrounding pixels. offset of 0 gives red channel,
// 1 gives green channel, 2 is blue channel
private int mostFrequent(int anOffset, int[] aSurrounding) {
    Counter _c = new Counter();
    int _length = aSurrounding.length-(2-anOffset);
    for (int i=anOffset; i&amp;lt;_length; i+=3) {
        _c.add(aSurrounding[i]);
    }
    return _c.mostFrequent();
}

// relatively efficient counter for quickly racking up 
// a count of occurrences of any given colour level
class Counter {
    int[] values = new int[256];

    public Counter() {
        Arrays.fill(values, -1);
    }

    public void add(int aValue) {
        values[aValue] += 1;
    }

    public int mostFrequent() {
        int _highest = -1;
        int _colour = -1;
        for (int i=0; i&amp;lt;256; i++) {
            if (values[i] &amp;gt; _highest) {
                _highest = values[i];
                _colour = i;
            }
        }
        return _colour;
    }
}
</code></pre>

<p>And here's what the resulting "vector-effect" image looks like:</p>

<table>
  <tr>
    <th>
      <img src="https://lh6.googleusercontent.com/-h7WklR032Mk/TsRN6coQ38I/AAAAAAAAHsQ/JWkuc8ANBY0/s290/vector-effect.png">
      <div class="caption">4x4 sample grid</div>
    </th>
    <th>
      <img src="https://lh3.googleusercontent.com/-vsw4wvURlK4/TsRJkaFlyBI/AAAAAAAAHr0/B8JSW3ZA7yQ/s290/vector-effect.png">
      <div class="caption">8x8 sample grid</div>
    </th>
  </tr>
</table>

<p>Because of the low resolution of this image, a large grid size quickly reduces the resultant image quality. On larger images (e.g. 8MP photos) a 16x16 or even 32x32 grid produces good results. The time to render is proportional to the grid size though.</p>

<h2>Me Again</h2>

<p>Here's the results of processing my viking-hat picture with four different grid sizes: 2x2, 4x4, 8x8 and 16x16. You can see that at such a low resolution the image quickly degenerates with a large grid size - I'm looking pretty demonic by the time we get to 16x16:</p>

<table>
  <tr>
    <th><img src="https://lh4.googleusercontent.com/-NuogXfqNWmA/TsRU2sshuKI/AAAAAAAAHtM/ikSxFtH3i9w/s291/after-2x2.png"><div class="caption">2x2</div></th>
    <th><img src="https://lh5.googleusercontent.com/-hE6Z_o9mrR4/TsRU2ohWggI/AAAAAAAAHtQ/cTkyx-gYM9I/s291/after-4x4.png"><div class="caption">4x4</div></th>
  </tr>
  <tr>
    <th><img src="https://lh4.googleusercontent.com/-w37U7iH5tfg/TsRU2qiVWXI/AAAAAAAAHtI/0Id8prE6AZ4/s291/after-8x8.png"><div class="caption">8x8</div></th>
    <th><img src="https://lh6.googleusercontent.com/-ZViGZb-uaIA/TsRVE7M2jRI/AAAAAAAAHts/3yFJbGNleX4/s291/after-16x16.png"><div class="caption">16x16</div></th>
  </tr>
</table>

<h2>A High-Resolution Image</h2>

<p>An 8MP image (3456x2304) processed with a 16x16 grid takes about 50 seconds on my quad-core i7 laptop. The same image processed with an 8x8 grid takes 27 seconds.</p>

<p>This last image was processed at its full size (3456x2304) with a 16x16 grid, then the result was cropped and resized (by more than 50%) in GIMP to fit the width of my blog.</p>

<table>
  <tr>
    <th>
      <img src="https://lh3.googleusercontent.com/-JiE1KHRC6qs/TsRPaJYe7OI/AAAAAAAAHss/kYIP-Llk-0k/s600/vector-16x16.png">
      <div class="caption">vector effect, using a 16x16 grid</div>
    </th>
  </tr>
</table>

<h2>What's next?</h2>

<p>Well its still some way off from the clean look that Vector Magic produces, but I think its a good start. I'm going to try some ideas to de-fuzz and clean up the edges a bit.</p>

<p>After that ... I'm wondering if I can take the next step and identify bounds for the areas of colour, and thus create a vector image from my "vector-effect" bitmaps?</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Image">Image</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Processing">Processing</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Java2D">Java2D</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Convolve">Convolve</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Kernel">Kernel</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Vectorize">Vectorize</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="creating_a_vectorisation_effect_with_java2d.html">Comment on this post</a>

            </div>
        </div>
        <div class="sidebar">
          <div>
            <div class="twitter-feed" show="4" account="steveliles">
              <h5>Recent Tweets</h5>            
              <ul class="tweets">
                <li class="tweet-template" style="display:none">        
                  <span class="text"></span>&nbsp;<span class="date" format="yyyy"></span>
                </li>
              </ul>
              <a href="https://twitter.com/steveliles" class="twitter-follow-button" data-show-count="false">Follow @steveliles</a>
	      <script src="//platform.twitter.com/widgets.js" type="text/javascript"></script>
            </div>
          </div>
          <div>
            <a href="article-archive.html"><h5>Recent Posts</h5></a>
            <ul>
                <li><a href="porting_ischangingconfigurations_to_api_levels_below_11.html">Porting isChangingConfigurations to API-levels below 11</a><span class="date"> - Oct 21, 2013</span></li>
                <li><a href="android_ssl_certificate_not_trusted.html">Android SSL - Certificate not trusted</a><span class="date"> - May 01, 2013</span></li>
                <li><a href="roman_numeral_conversion_in_clojure_part_ii.html">Roman numeral conversion in Clojure, part II</a><span class="date"> - Mar 03, 2013</span></li>
                <li><a href="roman_numeral_conversion_in_clojure.html">Roman numeral conversion in Clojure</a><span class="date"> - Feb 28, 2013</span></li>
                <li><a href="gwt_i18n_using_browser_locale.html">GWT i18n using browser locale</a><span class="date"> - Feb 27, 2013</span></li>
            </ul>
            <a href="article-archive.html">Older posts...</a>
          </div>
        </div>
      </div>
      <div class="nav">
        <div class="links">
          <div class="prev"><a title="previous" href="index_8.html">Newer Posts</a></div>
          <div class="next"><a title="next" href="index_10.html">Older Posts</a></div>
        </div>
      </div>
    </div>
    <script type="text/javascript" language="javascript" src="blog/blog.nocache.js"></script>
  </body>
</html>

