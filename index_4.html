
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <link rel="stylesheet" href="css/styles.css" type="text/css" media="screen"/>
    <link rel="alternate" type="application/rss+xml" title="ExoMemory" href="http://steveliles.github.com/rss.xml" />
    <link href='http://fonts.googleapis.com/css?family=Gochi+Hand' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:700' rel='stylesheet' type='text/css'>
    <meta name="description" content="Thoughts on Java, GWT, programming, and other geek stuff"></meta>
    <script type="text/javascript" src="google-analytics.js"></script>
    <title>Steve Liles' Blog</title>
  </head>
  <body>
    <div>
      <header class="site-header">
        <div class="left">
          <a href="/index.html"><h1>ExoMemory</h1></a>
          <h2>Because I'll forget it if I don't write it down...</h2>
        </div>
        <div class="right">
	  <a rel="author" href="http://steveliles.github.com/about_me.html"><img src="images/lego.png"></a>
        </div>
      </header>
      <nav>
        <span>
          <a rel="me" href="https://plus.google.com/105248011271585565954"><img src="http://www.google.com/images/icons/ui/gprofile_button-16.png" width="16" height="16"></a>
          <a rel="me" href="http://www.twitter.com/steveliles"><img src="http://twitter-badges.s3.amazonaws.com/t_mini-a.png" alt="Follow steveliles on Twitter"></a>
	  <a rel="me" href="http://uk.linkedin.com/in/steveliles"><img src="http://www.linkedin.com/img/webpromo/btn_in_20x15.png" width="20" height="15" alt="View my LinkedIn profile"></a>
	  <form action="http://www.google.com/search" method="get">
            <input type="hidden" name="q" value="site:steveliles.github.com">
            <input type="text" name="q" placeholder="search"></input>
          </form>
	  <a href="rss.xml"><img src="images/rss.png" width="16" height="16" alt="Subscribe to RSS feed"></a>
        </span>
      </nav>
      <div class="content">
        <div class="main">
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="2,097" description="Description and code for a progressive enhancement syntax highlighter written in javascript using Google Web Toolkit">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-13">November 13, 2011</time></span>
              <a itemprop="url" href="syntax_highlighting_with_gwt_progressive.html"><h1 itemprop="name" itemprop="headline">Syntax Highlighting with GWT.Progressive</h1></a>
	      <span itemprop="articleBody"><p>There are many good syntax-highlighters available for progressively enhancing code on website's such as my blog. On my old blog I used <a href="http://alexgorbatchev.com/SyntaxHighlighter/">Alex Gorbachev's</a> - which is exceptionally good.</p>

<p>For this blog, I really wanted to write my own. Why? Well, for the same reason I wrote the site-generation software that builds the blog from Markdown templates - because I love programming, and doing this stuff is FUN!</p>

<p>Having just released my <code>GWT.Progressive</code> library I had two very good reasons to write a syntax-highlighter that works by progressive-enhancement:</p>

<ol>
<li>I need good examples of progressive enhancement written in <code>GWT</code> using <code>GWT.Progressive</code></li>
<li>Those very same code-samples need syntax-highlighting to aid readability!</li>
</ol>

<p>For this first attempt I'm not setting out to write the world's greatest syntax-highlighter. My aims are more modest: merely to illustrate the <code>GWT.Progressive</code> library and add basic syntax-highlighting (Java) capabilities to my blog.</p>

<p>The syntax-highlighter will work as follows:</p>

<ol>
<li>After the page is loaded, identify <code>&lt;pre&gt;&lt;code&gt; ... &lt;/code&gt;&lt;/pre&gt;</code> blocks on my blog.</li>
<li>Try to ascertain if the text in the block is Java, or a similar language (e.g. JavaScript).</li>
<li>Mark keywords, literals, comments, and a few other choice elements using inline html markup to add css classes, allowing the actual colours and styles to be selected independently of the process of identify the parts to highlight.</li>
</ol>

<p>The script that kicks this off is loaded by the very last line in the html body of each page on my blog:</p>

<pre><code>&lt;script 
  type="text/javascript" language="javascript" 
  src="blog/blog.nocache.js"&gt;
&lt;/script&gt;
</code></pre>

<p>The Java class that uses the <code>GWT.Progressive</code> library to scan for <code>&lt;pre&gt;&lt;code&gt;</code> blocks is, in full, as follows:</p>

<pre><code>package com.sjl.blog.client.syntax;

import com.google.gwt.core.client.*;
import com.google.gwt.dom.client.*;
import com.knowledgeview.gwt.activator.client.*;
import com.knowledgeview.gwt.activator.client.widgets.*;

@RootBinding(tag="code")
public class Code extends BoundRootPanel {
    interface MyActivator extends ElementActivator&lt;Code&gt;{}
    static MyActivator activator = GWT.create(MyActivator.class);

    static JavaSyntaxHighlighter highlighter = 
        new JavaSyntaxHighlighter();

    public Code(Element anElement) {
        setElement(activator.activate(this, anElement));

        if (isJavaCode(getElement().getInnerText())) {
            getElement().setInnerHTML(
                highlighter.highlight(getElement().getInnerText()));
        }
    }

    private boolean isJavaCode(String aString) {
        return !aString.trim().startsWith("&lt;");
    }
}
</code></pre>

<p>The <code>GWT</code> module descriptor looks like this:</p>

<pre><code>&lt;module rename-to="blog"&gt;
  &lt;inherits name="com.google.gwt.user.User"/&gt;
  &lt;inherits name="com.google.gwt.user.Debug"/&gt;

  &lt;inherits name="com.sjl.gwt.progressive.Progressive"/&gt;
  &lt;entry-point class="com.sjl.blog.client.BlogApplication" /&gt;

      &lt;!-- allows the script to be used cross domain --&gt;
  &lt;add-linker name="xs" /&gt;
&lt;/module&gt;
</code></pre>

<p>I will take the time to write a better highlighter some time in the future (using ANTLR or similar to generate a parser), but for now I knocked up a simple version using regular expressions.</p>

<p>This highlighter was built by TDD'ing my way through highlighting the different components, starting simple with keywords. The design changed a few times along the way, but in total, including the <code>Code</code> class, the finished highlighter took around 90 minutes to build.</p>

<p>The slowest part, actually, was round-trip testing and fixing "for real" with GWT production mode, since the <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.4/com/google/gwt/regexp/shared/RegExp.html">difference in regular expression engines</a> between development and production mode caught me out.</p>

<p>Here's the Java syntax highlighter in full:</p>

<pre><code>public class JavaSyntaxHighlighter implements SyntaxHighlighter {
    private List&amp;lt;Replacement&gt; replacements;

    public JavaSyntaxHighlighter() {
        replacements = new ArrayList&amp;lt;Replacement&gt;();

        // order is important
        replacements.add(new CommentReplacement());
        replacements.add(new AnnotationReplacement());
        replacements.add(new LiteralReplacement());
        replacements.add(new KeywordReplacement());
    }

    public String highlight(String anInput) {
        List&amp;lt;Component&gt; _components = new ArrayList&amp;lt;Component&gt;();
        _components.add(new SplittableComponent(anInput));

        for (Replacement _r : replacements) {
        _components = _r.process(_components);
        }

        StringBuilder _sb = new StringBuilder();
        for (Component _c : _components) {
        _sb.append(_c);
        }
        return _sb.toString();
    }
}

interface Component {
    boolean canSplit();
    String toString();
}

class SplittableComponent implements Component {
    protected String value;

    public SplittableComponent(String aValue) {
        value = aValue;
    }

    public boolean canSplit() {
        return true;
    }

    public String toString() {
        return value;
    }
}

class UnsplittableComponent extends SplittableComponent {
    public UnsplittableComponent(String aValue) {
        super(aValue);
    }

    public boolean canSplit() {
        return false;
    }
}

interface Replacement {
    public List&amp;lt;Component&gt; process(List&amp;lt;Component&gt; anInput);
}

abstract class AbstractReplacement implements Replacement {
    private String cssClass;

    public AbstractReplacement(String aCssClass) {
        cssClass = aCssClass;
    }

    protected abstract String replace(String aString);

    @Override
    public List&amp;lt;Component&gt; process(List&amp;lt;Component&gt; aComponents)
    {
        List&amp;lt;Component&gt; _result = new ArrayList&amp;lt;Component&gt;();
        for (Component _c : aComponents) {
        if (_c.canSplit()) {
            String _replaced = replace(_c.toString());
            _result.addAll(createComponents(_replaced, cssClass));
        } else {
            _result.add(_c);
        }
        }
        return _result;
    }

    private List&amp;lt;Component&gt; createComponents(
        String anInput, String aClass) {
        List&amp;lt;Component&gt; _result = new ArrayList&amp;lt;Component&gt;();
        for (String _s : anInput.split("\\[\\[\\[|\\]\\]\\]")) {
        if (_s.startsWith("&amp;lt;span class=\"" + aClass)) {
            _result.add(new UnsplittableComponent(_s));
        } else {
            _result.add(new SplittableComponent(_s));
        }
        }
        return _result;
    }

    protected String replacement(String aClass) {
        return "[ [ [&amp;lt;span class=\"" + aClass + "\"&amp;gt;$1&amp;lt;/span&amp;gt;] ] ]";
    }
}

class KeywordReplacement extends AbstractReplacement
{
    public static String[] KEYWORDS = new String[] {
        "class", "package", "import", "public", "private", "protected", 
        "interface", "extends", "this", "implements", "throws", "try", 
        "catch", "finally", "final", "return", "new", "void", "for", 
        "if", "else", "while", "static", "transient", "synchronized", 
        "byte", "short", "int ", "char ", "long ", "float ", "double ", 
        "boolean ", "true", "false", "abstract", "volatile", "switch", 
        "case"
    };

    public KeywordReplacement() {
        super("sh-keyword");
    }

    protected String replace(String aString) {
        String _result = aString;
        for (String _k : KEYWORDS) {
        _result = _result.replaceAll("(" + _k + ")", 
                replacement("sh-keyword"));
        }
        return _result;
    }
}

class LiteralReplacement extends AbstractReplacement {

    public LiteralReplacement() {
        super("sh-literal");
    }

    protected String replace(String aString) {
        return aString.replaceAll("(\"[^\"]*\")", 
            replacement("sh-literal"));
    }
}

class CommentReplacement extends AbstractReplacement {
    public CommentReplacement() {
        super("sh-comment");
    }

    protected String replace(String aString) {
        String _result = aString.replaceAll("(//.*)", 
            replacement("sh-comment"));
        _result = _result.replaceAll("(\\/\\*[\\*]?.*\\*\\/)", 
            replacement("sh-comment"));
        return _result;
    }
}

class AnnotationReplacement extends AbstractReplacement {
    public AnnotationReplacement() {
        super("sh-annotation");
    }

    protected String replace(String aString) {
        return aString.replaceAll("(@\\w+)", 
            replacement("sh-annotation"));
    }
}
</code></pre>

<p>You can find out more about <code>GWT.Progressive</code> in the <a href="gwt_progressive.html">release announcement</a>, or at the <a href="https://github.com/steveliles/gwt-progressive">github repository</a>.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=syntax">syntax</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=highlight">highlight</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=java">java</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=GWT">GWT</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=progressive">progressive</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=enhancement">enhancement</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=regexp">regexp</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="syntax_highlighting_with_gwt_progressive.html">Comment on this post</a>

            </article>
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="2,076" description="Description and code samples for progressive enhancement using Google Web Toolkit and a new open source library called gwt.progressive">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-12">November 12, 2011</time></span>
              <a itemprop="url" href="gwt_progressive.html"><h1 itemprop="name" itemprop="headline">gwt.progressive</h1></a>
	      <span itemprop="articleBody"><h2>Easy Progressive-Enhancement with GWT</h2>

<p>Progressive-enhancement is a technique for delivering a basic website suitable for search-engines and older web-browsers, then layering on polish, effects, interactivity and general goodness using javascript - the idea being to have a graceful degradation of service, not an all-or-nothing experience.</p>

<p>Traditionally <code>GWT</code> works the other way around - it builds all of the <code>DOM</code> structure of your web-app in script, so search-engines (and browsers with script disabled) only see an inscrutable mass of script.</p>

<p><code>GWT.Progressive</code> helps to bring your ninja <code>GWT</code> skills to bear on web-sites that need progressive enhancement.</p>

<p>You can get <code>GWT.Progressive</code> from the <a href="https://github.com/steveliles/gwt-progressive">git repository</a> at github.</p>

<h2>What can GWT.Progressive do for me?</h2>

<ul>
<li>Bind <code>GWT</code> widgets to html elements on static (or server-generated) html pages, using the html as a template and <code>GWT</code> magic to "enhance" the user-experience</li>
<li>Automatically bind nested html elements to properties of widget classes (child widgets, grand-child widgets, etc)</li>
<li>Bind repeated html elements to <code>List&lt;MyWidgetClass&gt;</code> properties of widget classes</li>
<li>Automatically bind attributes of html elements to properties of widget classes - with automatic type coercion</li>
<li>Make partial page-updates a breeze (replacing parts of the <code>DOM</code> with new server-generated content)</li>
</ul>

<h2>How GWT.Progressive works</h2>

<h3>Element Binding</h3>

<p>You can bind a <code>GWT</code> widget to any html element on your website - just by adding an annotation to the widget class:</p>

<pre><code>// bind by id
@RootBinding(id="mywidget")
class MyWidget extends Composite {
    //...
}

// bind by tag name
@RootBinding(tag="h1")
class MyWidget extends Composite {
   //...
}

// bind by css class
@RootBinding(cssClass="bind-me")
class MyWidget extends Composite {
   //...
}

// bind by tag name and css class
@RootBinding(tag="div", cssClass="bind-me")
class MyWidget extends Composite {
   //...
}
</code></pre>

<p>Bind nested html to child widgets:</p>

<pre><code>// bind the first &amp;lt;h1&gt; tag we find by breadth first
// search of the DOM within our widget's root element
@RuntimeUiWidget(tag="h1") MyHeaderWidget header;

// bind the first element we find by breadth first
// search that has the css class "foo"
@RuntimeUiWidget(cssClass="foo") MyFooWidget foo;
</code></pre>

<p>Bind repeated elements to a List of child widgets:</p>

<pre><code>// bind all the &amp;lt;img&gt; elements we find inside our
// widget's root element to the list of Image widgets
@RuntimeUiWidget(tag="img") List&lt;Image&gt; images;
</code></pre>

<h3>Attribute Binding</h3>

<p>Bind html attributes as properties of your widgets, with automatic type coercion:</p>

<pre><code>// the following attributes will have their default values (set below)
// overridden by the values of attributes in the html, if they exist
@RuntimeUiAttribute("text-attr") String textAttr = "default";
@RuntimeUiAttribute("int-attr") Integer integerAttr = 22;
@RuntimeUiAttribute("long-attr") Long longAttr = 9L;
@RuntimeUiAttribute("float-attr") Float floatAttr = 2.3f;
@RuntimeUiAttribute("double-attr") Double doubleAttr = 2222222.222d;
@RuntimeUiAttribute("boolean-attr") Boolean booleanAttr = false;
</code></pre>

<p>Bind attributes to custom types by supplying converters - given html like: <code>&lt;div coords="200x400"&gt; ... &lt;/div&gt;</code>, automatically bind the coords property of our widget as an instance of Coords, converted by CoordsAttributeConverter...</p>

<p>In the <code>Widget</code> we're binding:</p>

<pre><code>// automatically bind our custom Coords class 
@RuntimeUiAttribute("coords") Coords coords;
</code></pre>

<p>The <code>Coords</code> class:</p>

<pre><code>class Coords {
    public Integer x, y;
    public Coords(Integer anX, Integer aY) {
        x = anX;
        y = aY;
    }
}
</code></pre>

<p>The <code>AttributeConverter</code>:</p>

<pre><code>@RuntimeUiAttributeConverter
public class CoordsAttributeConverter 
extends AttributeConverter&lt;Coords&gt; {
    public Coords convert(String aString) {
        String[] _parts = aString.split("x");
        return new Coords(
            Integer.parseInt(_parts[0]), 
            Integer.parseInt(_parts[1])
        );
    }
}
</code></pre>

<h3>Partial Page Updates</h3>

<p>Replace chunks of html with new html from the server. Your server can provide this html as it pleases - for example you can call servlets, jsp's, PHP or whatever you like to get the html for the replacement. Your widgets will re-bind to the new html after adding it to the <code>DOM</code>.</p>

<pre><code>// UiBinder afficionados will be familiar with this plumbing
// which we'll use to invoke our page update...
interface MyActivator extends ElementActivator&lt;Partial&gt;{}
MyActivator activator = GWT.create(MyActivator.class);

// here's the widget we're going to update
@RuntimeUiWidget(tag="div") UpdateMe updateMe;

    ...

// call this method to trigger the update
private void someMethod() {
    activator.update(
        updateMe, "/update-me.jsp", 
        new CallMeWhenUpdated()
    );
}
</code></pre>

<h3>Partial Page Update callbacks</h3>

<p>You can register callbacks to trigger when a partial update completes - successfully or otherwise. Here's a more complete partial update example:</p>

<pre><code>@RootBinding(tag="div")
public class Partial extends BoundRootPanel
    // UiBinder afficionados will be familiar with this
    interface MyActivator extends ElementActivator&lt;Partial&gt;{}
    MyActivator activator = GWT.create(MyActivator.class);

    @RuntimeUiWidget(tag="div") UpdateMe updateMe;

    public Partial(Element anElement)
    {
        setElement(activator.activate(this, anElement));

        // Update the page when we're clicked...
        addDomHandler(new ClickHandler() {
            public void onClick(ClickEvent aEvent) {
                activator.update(
                    Partial.this, "/update-me.jsp", 
                    new CallMeWhenUpdated()
                );
            });
        }            
    }, ClickEvent.getType());

    class CallMeWhenUpdated 
    implements PageUpdateCallback&lt;Partial&gt;() {
        public void onSuccess(Partial anUpdated) {
            Window.alert("Updated!");
        }

        public void onError(Throwable anExc) {
            GWT.log("oops, something bad happened", anExc);
        }   
    }
}
</code></pre>

<h3>Complete example - Progressive Enhancement with GWT</h3>

<p>Here's the HTML we're going to enhance:</p>

<pre><code>&lt;html&gt;
  &lt;body&gt;
    &lt;div class="widget"&gt;
      &lt;img class="first" src="/image-1.png"&gt;
      &lt;img class="second" src="/image-2.png"&gt;
    &lt;/div&gt;
    &lt;!-- our script loads last, and progressive 
         enhancement begins --&gt;
    &lt;script 
        type="text/javascript" language="javascript" 
        src="example/example.nocache.js?cache=20111112180652"&gt;
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Here's the widget we're going to bind to the <code>&lt;div&gt;</code> of css-class "widget":</p>

<pre><code>@RootBinding(cssClass="widget")
class MyWidget extends BoundRootPanel {
    interface MyActivator extends ElementActivator&lt;MyWidget&gt;{}
    MyActivator activator = GWT.create(MyWidget.class);

    @RuntimeUiWidget(cssClass="first") Image first;
    @RuntimeUiWidget(cssClass="second") Image second;

    public MyWidget(Element anElement) {
        setElement(activator.activate(this, anElement);

        // ... now we do some enhancements, e.g. add
        // click-handlers to our image's or something
    }
}
</code></pre>

<p>We'll need an EntryPoint - this is still a <code>GWT</code> application:</p>

<pre><code>class Example1 implements EntryPoint {
    public void onModuleLoad() {
        PageActivator _activator = GWT.create(PageActivator.class);
        _activator.activate();
    }
}
</code></pre>

<p>... and a <code>GWT</code> module descriptor (<code>.gwt.xml</code>) of course:</p>

<pre><code>&lt;module rename-to="example"&gt;
  &lt;inherits name="com.google.gwt.user.User"/&gt;
  &lt;inherits name="com.sjl.gwt.progressive.Progressive"/&gt;

  &lt;entry-point class="com.sjl.example.client.Example" /&gt;

  &lt;!-- for maximum compatibility, use the xs linker --&gt;
  &lt;add-linker name="xs" /&gt;
&lt;/module&gt;
</code></pre>

<h2>Rules of engagement</h2>

<p><code>GWT.Progressive</code> requires that you follow a few simple rules to ensure that your widgets get "activated" correctly, integrated into the GWT/browser eventing system, etc.</p>

<p>Your widgets <em>must</em>:</p>

<ul>
<li>Have a public <code>Constructor</code> that takes a <code>com.google.gwt.dom.client.Element</code> argument, OR</li>
<li>Have a <code>public static &lt;T&gt; wrap(Element anElement)</code> method that returns an instance of your widget class (this is how native GWT widgets like Image and Label are bound by GWT.Progressive).</li>
<li><code>GWT.create()</code> a special class that allows <code>GWT.Progressive</code>'s generator to work its magic on your widgets (either <code>com.sjl.gwt.progressive.client.ElementActivator</code> or <code>com.sjl.gwt.progressive.client.WidgetActivator</code>).</li>
<li>Set your Widget's Element as the return value from activation (<code>setElement(activator.activate(this, anElement))</code>) or init your Composite with it (<code>initWidget(activator.activate(this, anElement))</code>).</li>
</ul>

<p>If you've ever used UiBinder, this pattern will be very familiar to you.</p>

<p>Also, make sure to use the "xs" linker by specifying <code>&lt;add-linker name="xs"/&gt;</code> in your gwt module descriptor for maximum compatibility.</p>

<h3>Where can I find more examples of GWT.progressive?</h3>

<p>In the github repository, in the <a href="https://github.com/steveliles/gwt-progressive/tree/master/src/java/test/com/sjl/gwt/progressive">test source tree</a>.</p>

<h3>Are there any examples in the wild?</h3>

<p>There are two examples on this page! - The Twitter feed in the sidebar, and the code <a href="syntax_highlighting_with_gwt_progressive.html">syntax-highlighting</a> are both implemented using <code>gwt.progressive</code>.</p>

<p>You can also try my mortgage/loan <a href="http://www.overpayment-calculator.com/">overpayment calculator</a> which is built with gwt.progressive.</p>

<h3>Can I use this in my products?</h3>

<p>Sure, its available under the Apache-2.0 license, and is a github fork away, but ... disclaimer: use at your own risk and discretion, I cannot accept responsibility for any issues that may arise from using this library.</p>

<h3>Can I modify the code, fix bugs, etc?</h3>

<p>Knock yourself out :) ... I'd love to hear about it if you do.</p>

<h2>Final Words</h2>

<p>I just want to say - props to my employer (<a href="http://www.knowledgeview.com">KnowledgeView ltd.</a>) for allowing me to release the code, some of which was developed on their dime. Mucho thanks KV :)</p>

<p>You can find some more background on <code>GWT.Progressive</code> in some of my earlier blog posts: <a href="http://steveliles.github.com/progressive_enhancement_with_gwt_part_1.html">part-1</a>, <a href="http://steveliles.github.com/progressive_enhancement_with_gwt_part_2.html">part-2</a>, and <a href="http://steveliles.github.com/progressive_enhancement_with_gwt_part_3.html">part-3</a></p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=GWT">GWT</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Progressive">Progressive</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Enhancement">Enhancement</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Library">Library</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Apache2">Apache2</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=SEO">SEO</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="gwt_progressive.html">Comment on this post</a>

            </article>
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="898" description="Description and code for creating a sitemap xml using freemarker">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-11">November 11, 2011</time></span>
              <a itemprop="url" href="templating_my_blog_with_freemarker.html"><h1 itemprop="name" itemprop="headline">Templating my Blog with FreeMarker</h1></a>
	      <span itemprop="articleBody"><p>Part of the fun of shifting my Blog from Blogger to github has been building the static-site-generator tool which reads my blog content as <a href="http://daringfireball.net/projects/markdown/syntax">Markdown</a> and spits it out as html + css.</p>

<p>I'm using <a href="http://code.google.com/p/markdownj/">MarkdownJ</a> to convert the Markdown syntax to HTML, and <a href="http://freemarker.sourceforge.net/">FreeMarker</a> for templating.</p>

<p>FreeMarker for templating was an easy choice for me:</p>

<ul>
<li>It is a decent templating engine that I've used recently for a dynamic website,</li>
<li>It is very easy to set up in Java for my one-hit templating needs,</li>
<li>I like its syntax compared to, say, Velocity</li>
</ul>

<p>Yesterday I used FreeMarker to add two new productions to my site-generator: a sitemap, and an RSS feed, and thought I'd make some quick notes...</p>

<p>FreeMarker strives to be a pure templating language, and as such resists the temptation to ... shall we say, make certain things easy that you probably shouldn't do in a template. </p>

<p>This can make templating a little uncomfortable sometimes - all the more so if you try to use complex domain objects directly in your templates instead of producing model's specifically for output (YMMV depending on the complexity of your domain model of course).</p>

<p>For the simple needs of my Blog FreeMarker has been great, allowing me to whiz up the sitemap template in a couple of minutes, and not much longer for the RSS-2.0 template.</p>

<p>Setting up FreeMarker in Java is very very simple indeed. I chose to abstract FreeMarker away behind my own interface (<code>TemplateProcessor</code>), in case I want to use something different later:</p>

<pre><code>import java.io.*;
import freemarker.template.*;

public class FreemarkerTemplateProcessor implements TemplateProcessor
{
    private Configuration cfg;

    public FreemarkerTemplateProcessor(File aTemplateDir) 
    throws IOException
    {
        cfg = new Configuration();
        cfg.setDirectoryForTemplateLoading(aTemplateDir);
        cfg.setObjectWrapper(new DefaultObjectWrapper());
    }

    @Override
    public void process(Object aModel, String aTemplate, Writer aWriter) 
    throws IOException, TemplateException
    {
        Template _tpl = cfg.getTemplate(aTemplate);
        _tpl.process(aModel, aWriter);
    }
}
</code></pre>

<p>The templating language is quite neat, and very easy to write - as I mentioned before, it helps if your model is a good fit for the view you are trying to render so you don't need to squeeze to many conditionals into the template. </p>

<h2>Freemarker template for sitemap.xml</h2>

<p>There are only 3 lines of FreeMarker markup in my sitemap template:</p>

<ul>
<li><code>&lt;#list posts as post&gt;</code> which iterates over an <code>Iterable</code> containing <code>Post</code> objects,</li>
<li>the closing <code>&lt;/#list&gt;</code>, and</li>
<li>the line that reads the post's link <code>&lt;loc&gt;${blog.url}/${post.link}&lt;/loc&gt;</code></li>
</ul>

<p>Here's the template in full:</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt; 
&lt;urlset xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation=
        "http://www.sitemaps.org/schemas/sitemap/0.9 
        http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd"
  xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"&gt; 

  &lt;url&gt;
    &lt;loc&gt;${blog.url}/index.html&lt;/loc&gt;
    &lt;changefreq&gt;daily&lt;/changefreq&gt;
    &lt;priority&gt;1.0&lt;/priority&gt;
  &lt;/url&gt;
  &lt;url&gt;
    &lt;loc&gt;${blog.url}/about_me.html&lt;/loc&gt;
    &lt;changefreq&gt;daily&lt;/changefreq&gt;
    &lt;priority&gt;0.9&lt;/priority&gt;
  &lt;/url&gt;

  &lt;#list posts as post&gt;
    &lt;url&gt; 
      &lt;loc&gt;${blog.url}/${post.link}&lt;/loc&gt;
      &lt;changefreq&gt;hourly&lt;/changefreq&gt;
    &lt;/url&gt;
  &lt;/#list&gt;

&lt;/urlset&gt;
</code></pre>

<h2>Freemarker template for RSS 2.0</h2>

<p>The RSS template is very similar to the sitemap template, as it deals with exactly the same model. Skipping the pre-amble, here's the part that actually involves any freemarker markup:</p>

<pre><code>&lt;#list posts as post&gt;
  &lt;item&gt;
    &lt;title&gt;&lt;![CDATA[${post.title}]]&gt;&lt;/title&gt;
    &lt;link&gt;&lt;![CDATA[http://${blog.url}/${post.link}]]&gt;&lt;/link&gt;
    &lt;guid isPermaLink="true"&gt;${blog.url}/${post.link}&lt;/guid&gt;
    &lt;description&gt;&lt;![CDATA[${post.body}]]&gt;&lt;/description&gt;
    &lt;#list post.keywords as keyword&gt;
      &lt;category&gt;${keyword}&lt;/category&gt;
    &lt;/#list&gt;
    &lt;dc:creator&gt;&lt;![CDATA[ Steve Liles ]]&gt;&lt;/dc:creator&gt;
    &lt;pubDate&gt;${post.date?string("EEE, dd MMM yyyy HH:mm:ss Z")}&lt;/pubDate&gt;
  &lt;/item&gt;
&lt;/#list&gt;
</code></pre>

<p>I like the date built-in here: <code>${post.date?string("EEE, dd MMM yyyy HH:mm:ss Z")}</code> which keeps the date format in the template where it belongs. </p>

<p>Of course, here I've just written it directly into this template because I only use this format once in my whole site - if I were using it more I could define a re-usable FreeMarker macro instead to avoid repetition.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=FreeMarker">FreeMarker</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Template">Template</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Sitemap">Sitemap</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=RSS">RSS</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="templating_my_blog_with_freemarker.html">Comment on this post</a>

            </article>
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="80" description="A quick test of github's url shortener, invoked using curl">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-10">November 10, 2011</time></span>
              <a itemprop="url" href="most_geeky_thing_i_ever_saw.html"><h1 itemprop="name" itemprop="headline">Most geeky thing I ever saw</h1></a>
	      <span itemprop="articleBody"><p>There's something fabulously, deliciously geeky about using Curl to call a url-shortening service for url's to the web-management console of an online source-code-control system! <a href="http://git.io/help">Githubber's you ROCK!</a></p>

<p><code>curl -i http://git.io -F "url=https://github.com/blog/985-git-io-github-url-shortener" -F "code=geek"</code></p>

<p>gives:</p>

<pre><code>HTTP/1.1 201 Created
Server: nginx/1.0.4
X-Node: gitio2
X-Sha: 50f8f21981a362dfbaa5fbc85193621e56379dfb
Content-Type: text/html;charset=utf-8
Date: Thu, 10 Nov 2011 23:23:12 GMT
Status: 201 Created
Location: http://git.io/help
X-Runtime: 0.008420
Connection: keep-alive
Content-Length: 0
</code></pre>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=github">github</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=geek">geek</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=url-shortener">url-shortener</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="most_geeky_thing_i_ever_saw.html">Comment on this post</a>

            </article>
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="98" description="A comparison of linux distribution popularity using Google Trends">
              <span class="meta" itemprop="datePublished"><time datetime="2011-11-10">November 10, 2011</time></span>
              <a itemprop="url" href="popularity_contest_ubuntu_vs_osx_lion_vs_win7.html"><h1 itemprop="name" itemprop="headline"> Popularity contest - Ubuntu vs OSX Lion vs Win7</h1></a>
	      <span itemprop="articleBody"><p>A while back I played with Google Trends to compare <a href="linux_distro_popularity.html">Linux distribution popularity</a>. Ubuntu was the clear winner.</p>

<p>In that post I also tried to compare OSX and Windows7 against the Linux supremo, but I think I didn't hit on the right search term for OSX.</p>

<p>I tried again today out of curiosity, and I think I got better results, though perhaps still not really reflecting the true state of the world (I'm <em>sure</em> OSX kicks Ubuntu's pants in reality).</p>

<p><img src="https://lh3.googleusercontent.com/-Dzc_zxe0T1c/Trw6VrnoVgI/AAAAAAAAHo4/wA3dBag5IFw/s900/ubuntu-vs-lion-vs-win7-2011-11-10.png" alt="ubuntu(blue), windows7(red), OSX Lion(orange)" /></p>

<p><code>ubuntu(blue), windows7(red), OSX Lion(orange)</code></p>

<p>More at <a href="http://www.google.com/trends?q=ubuntu%2C+windows+7%2C+lion&amp;ctab=0&amp;geo=all&amp;date=all&amp;sort=0">Google Trends</a>.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Linux">Linux</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Ubuntu">Ubuntu</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=OSX Lion">OSX Lion</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Windows7">Windows7</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="popularity_contest_ubuntu_vs_osx_lion_vs_win7.html">Comment on this post</a>

            </article>
        </div>
        <div class="sidebar">
          <div>
            <div class="twitter-feed" show="4" account="steveliles">
              <h5>Recent Tweets</h5>            
              <ul class="tweets">
                <li class="tweet-template" style="display:none">        
                  <span class="text"></span>&nbsp;<span class="date" format="yyyy"></span>
                </li>
              </ul>
              <a href="https://twitter.com/steveliles" class="twitter-follow-button" data-show-count="false">Follow @steveliles</a>
	      <script src="//platform.twitter.com/widgets.js" type="text/javascript"></script>
            </div>
          </div>
          <div>
            <a href="article-archive.html"><h5>Recent Posts</h5></a>
            <ul>
                <li><a href="maven_android_and_eclipse_joining_the_team.html">Maven, Android and Eclipse - joining the team</a><span class="date"> - Jan 23, 2012</span></li>
                <li><a href="creating_colourised_icon_theme_sets_with_image_magick.html">Creating colourised icon theme-sets with Image-Magick</a><span class="date"> - Jan 18, 2012</span></li>
                <li><a href="capture_screenshots_from_the_android_emulator_or_mobile_device.html">Capture screenshots from the Android Emulator or Mobile Device</a><span class="date"> - Jan 12, 2012</span></li>
                <li><a href="the_dreaded_unexpected_top_level_exception.html">The dreaded UNEXPECTED TOP-LEVEL EXCEPTION</a><span class="date"> - Jan 11, 2012</span></li>
                <li><a href="setting_up_maven_android_and_svn_for_team_development_of_multiple_applications.html">Setting up Maven, Android and SVN for team development of multiple applications</a><span class="date"> - Jan 09, 2012</span></li>
            </ul>
            <a href="article-archive.html">Older posts...</a>
          </div>
        </div>
      </div>
      <nav>
        <div class="links">
          <div class="prev"><a title="previous" href="index_3.html">Newer Posts</a></div>
          <div class="next"><a title="next" href="index_5.html">Older Posts</a></div>
        </div>
      </nav>
    </div>
    <script type="text/javascript" language="javascript" src="blog/blog.nocache.js"></script>
  </body>
</html>

