
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <link rel="stylesheet" href="css/styles.css" type="text/css" media="screen"/>
    <link rel="alternate" type="application/rss+xml" title="ExoMemory" href="http://steveliles.github.com/rss.xml" />
    <link href='http://fonts.googleapis.com/css?family=Gochi+Hand' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:700' rel='stylesheet' type='text/css'>
    <meta name="description" content="Thoughts on Java, GWT, programming, and other geek stuff"></meta>
    <script type="text/javascript" src="google-analytics.js"></script>
    <title>Steve Liles' Blog</title>
  </head>
  <body>
    <div>
      <header class="site-header">
        <div class="left">
          <a href="/index.html"><h1>ExoMemory</h1></a>
          <h2>Because I'll forget it if I don't write it down...</h2>
        </div>
        <div class="right">
	  <a rel="author" href="http://steveliles.github.com/about_me.html"><img src="images/lego.png"></a>
        </div>
      </header>
      <nav>
        <span>
          <a rel="me" href="https://plus.google.com/105248011271585565954"><img src="http://www.google.com/images/icons/ui/gprofile_button-16.png" width="16" height="16"></a>
          <a rel="me" href="http://www.twitter.com/steveliles"><img src="http://twitter-badges.s3.amazonaws.com/t_mini-a.png" alt="Follow steveliles on Twitter"></a>
	  <a rel="me" href="http://uk.linkedin.com/in/steveliles"><img src="http://www.linkedin.com/img/webpromo/btn_in_20x15.png" width="20" height="15" alt="View my LinkedIn profile"></a>
	  <form action="http://www.google.com/search" method="get">
            <input type="hidden" name="q" value="site:steveliles.github.com">
            <input type="text" name="q" placeholder="search"></input>
          </form>
	  <a href="rss.xml"><img src="images/rss.png" width="16" height="16" alt="Subscribe to RSS feed"></a>
        </span>
      </nav>
      <div class="content">
        <div class="main">
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="445" description="A short profile on Steve Liles">
              <span class="meta" itemprop="datePublished"><time datetime="2011-09-11">September 11, 2011</time></span>
              <a itemprop="url" href="about_me.html"><h1 itemprop="name" itemprop="headline">About Me</h1></a>
	      <span itemprop="articleBody"><p>I didn't intend to have an about me page, but it turns out that to get google to display my mugshot next to search listings I have to have one. So here it is.</p>

<table>
<tr>
<td>
  <img src="images/viking.png">
</td>
<td>
  <img src="images/arrow-left.png">
</td>
<td>
  <p>This is me, the grinning idiot in the viking hat. Sadly I no longer have the hat.</p>
  <p>If you're interested, I took an (old) picture and vectorised it using <a href="http://vectormagic.com/">Vector Magic</a>, which allows online vectorising of a couple of images for free (thanks VectorMagic!)</p>
</td>
</tr>
</table>

<p>I graduated from Reading University with a BSc hons. degree in Computer Science and <a href="http://www.reading.ac.uk/cybernetics/">Cybernetics</a>, and immediately started work as a programmer at <a href="http://www.baesystems.com/">British Aerospace</a>, where I stayed for about a year and a half.</p>

<p>Next I moved on to work at a much smaller and more exciting company - <a href="http://www.knowledgeview.com">KnowledgeView</a> - where I have spent the last 11 years (oh me, oh my) developing a variety of web-based Editorial, Publishing and Syndication systems for news publishers - many based in the Middle-East and working and publishing in Arabic. We also build native and web apps for iPhone, iPad and Android devices to complement our publishing systems. </p>

<p>My current title is "Development Manager", though I think the job description would be better represented by the title "Chief Engineer". (A peculiar quirk of being a programmer is that you become a <a href="http://rcm-uk.amazon.co.uk/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=stlibl-21&amp;o=2&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=B005LI3W9W]">pedant for nomenclature</a>). </p>

<p>I still code every day, for as many hours as I can. My "management style", if I have such a thing, is to lead by example. I care a lot about writing good code, using good tools, and leaving things in a better state than I found them. I try hard to <a href="what_makes_a_good_developer.html">enthuse my team</a> to the same ideals.</p>

<p>KnowledgeView is still small, though we have a growing team in Beirut. It's also occasionally quite exciting, otherwise I wouldn't still be there. Over the years we've had many high-profile customers, including:</p>

<ul>
<li><a href="http://www.newsint.co.uk/">News International</a></li>
<li><a href="http://www.cnnarabic.com">CNN arabic</a></li>
<li><a href="http://www.inmplc.com/">Independent News and Media</a></li>
<li><a href="http://www.srmg.com/en">Saudi Research and Media Group</a></li>
<li><a href="http://www.daralhayat.com/">Al-Hayat Newspaper</a></li>
<li><a href="http://www.alquds.co.uk/">Al-Quds</a></li>
<li>... and many more besides</li>
</ul>

<p>When I'm not at work I divide my time between growing veg on my allotment (conveniently just outside my garden gate) and working on my personal programming projects. </p>

<p>I believe that programming is the most fun a person can have on their own, and I often wonder if non-programmers know what they are missing out on. I sometimes find time to <a href="some_old_sketches.html">draw</a>, and wish I could find <a href="more_old_sketches.html">more</a>.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=steve liles">steve liles</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="about_me.html">Comment on this post</a>

            </article>
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="2,904" description="Description and code for an Android desktop widget and backing Service for displaying tweets">
              <span class="meta" itemprop="datePublished"><time datetime="2011-09-08">September 08, 2011</time></span>
              <a itemprop="url" href="my_first_android_app_desktop_widget.html"><h1 itemprop="name" itemprop="headline">My first Android app (desktop widget)</h1></a>
	      <span itemprop="articleBody"><p>Having spent quite a bit of time away from Eclipse lately I've been itching to play with some code again. During a short meeting this morning an idea hit me for a really simple Android desktop widget: a twitter search widget that you can drop on your desktop and configure with a hash-tag search.</p>

<p>Here's how it looks in the Android emulator:</p>

<p><img src="https://lh5.googleusercontent.com/-vquQDRX3D2Y/TmjCGIscAiI/AAAAAAAAHlw/g0nU2gdPnug/s815/tweet-widget.png" alt="Screenshot" /></p>

<p>I know, not exactly eye-candy, but that wasn't really the point :)</p>

<h3>The important pieces of the puzzle are:</h3>

<ul>
<li>A BroadcastReceiver that receives events telling the widget to update. Here I extended AppWidgetProvider to override onUpdate only.</li>
<li>A Service that does the Twitter API request asynchronously - we don't want to use the UI thread and fail the responsiveness criteria</li>
<li>The "widget info" descriptor xml</li>
<li>Android manifest entries that register the Service and the broadcast receiver</li>
<li>SAX ContentHandler implementation to parse the Tweet text from the atom response to the Twitter API request</li>
</ul>

<p>Here's the code, currently wired to display a search for "#uml"</p>

<h4>The BroadcastReceiver</h4>

<pre><code>public class NewsTicker extends AppWidgetProvider {
    @Override
    public void onUpdate(Context aContext, 
        AppWidgetManager aAppWidgetManager, 
        int[] aAppWidgetIds) {
        super.onUpdate(aContext, aAppWidgetManager, aAppWidgetIds);
        aContext.startService(
            new Intent(aContext, NewsTickerDataService.class));
    }
}
</code></pre>

<h4>The Service</h4>

<pre><code>public class NewsTickerDataService extends Service {

    @Override
    public void onStart(Intent aIntent, int aStartId) {
        super.onStart(aIntent, aStartId);   
        RemoteViews _views = buildUpdatedViews(this);   
        ComponentName _widget = 
            new ComponentName(this, NewsTicker.class);
        AppWidgetManager _manager = 
            AppWidgetManager.getInstance(this); 
        _manager.updateAppWidget(_widget, _views);
    }

    @Override
    public IBinder onBind(Intent aParamIntent) {
        // not supporting binding   
        return null;
    }

    private RemoteViews buildUpdatedViews(Context aContext) {
        List&amp;lt;Story&gt; _stories = getStories();
        RemoteViews _result = new RemoteViews(
            aContext.getPackageName(), 
            R.layout.newsticker_widget
        );

        if (_stories.isEmpty()) {
            _result.setTextViewText(R.id.title, 
                "Sadly there's nothing to read today.");
        } else {
            _result.setTextViewText(
                R.id.title, _stories.get(0).getTitle());
        }
        return _result;
    }

    private List&amp;lt;Story&gt; getStories() {
        try {
            URL _url = new URL("http://search.twitter.com" +
                "/search.atom?q=%23uml&amp;" + 
                "result_type=mixed&amp;count=5"
            );
            InputStream _in = _url.openStream();
            return parse(new InputSource(_in));
        } catch (Exception anExc) {
            Log.e("NewsTicker", anExc.getMessage(), anExc);
            return new ArrayList&amp;lt;Story&gt;();
        }
    }

    private List&amp;lt;Story&gt; parse(InputSource aSource)
    throws Exception {
        SAXParserFactory _f = SAXParserFactory.newInstance();
        SAXParser _p = _f.newSAXParser();
        XMLReader _r = _p.getXMLReader();

        AbstractParser _h = new AtomParser();
        _r.setContentHandler(_h);   
        _r.parse(aSource);

        return _h.getStories();
    }
}
</code></pre>

<h4>The SAX ContentHandler</h4>

<pre><code>public abstract class AbstractParser extends DefaultHandler {

    static interface Handler {
        Handler startElement(String aName);
        Handler characters(char[] aChars, int aStart, int aLength);
        Handler endElement(String aName);
    }

    public static AbstractParser newAtomParser() {
        return new AbstractParser() {
            protected String getStoryElementName() {
                return "entry";
            }
        };
    }

    private Handler handler;
    private List&amp;lt;Story&gt; stories;

    public AbstractParser() {
        stories = new ArrayList&amp;lt;Story&gt;();
        handler = newDefaultHandler();
    }

    protected abstract String getStoryElementName();

    @Override
    public void startElement(
        String aUri, String aLocalName, 
        String aQName, Attributes aAttributes) 
    throws SAXException {
        handler = handler.startElement(aLocalName);
    }

    @Override
    public void characters(char[] aCh, int aStart, int aLength) 
    throws SAXException {
        handler = handler.characters(aCh, aStart, aLength);
    }

    @Override
    public void endElement(String aUri, String aLocalName, String aQName) 
    throws SAXException {
        handler = handler.endElement(aLocalName);
    }

    public List&amp;lt;Story&gt; getStories() {
        return stories;
    }

    private Handler newDefaultHandler() {
        return new Handler() {
            @Override
            public Handler startElement(String aName) {
                if (aName.equals(getStoryElementName())) {
                    return newItemHandler(this);
                }
                return this;
            }

            @Override
            public Handler characters(
                char[] aChars, int aStart, int aLength) {
                return this;
            }

            @Override
            public Handler endElement(String aName) {
                return this;
            }
        };
    }

    private Handler newItemHandler(final Handler aParent) {
        stories.add(new StoryImpl());

        return new Handler() {
            @Override
            public Handler startElement(String aName) {
                if ("title".equals(aName)) {
                    return newTitleHandler(this);
                }
                return this;
            }

            @Override
            public Handler characters(
                char[] aChars, int aStart, int aLength) {
                return this;
            }

            @Override
            public Handler endElement(String aName) {
                if (getStoryElementName().equals(aName)) {
                    return aParent;
                }
                return this;
            }
        };
    }

    private Handler newTitleHandler(final Handler aParent) {
        final StringBuilder _title = new StringBuilder();

        return new Handler() {
            @Override
            public Handler startElement(String aName) {
                return this;
            }

            @Override
            public Handler characters(
                char[] aChars, int aStart, int aLength) {
                _title.append(aChars, aStart, aLength);
                return this;
            }

            @Override
            public Handler endElement(String aName) {
                if ("title".equals(aName)) {
                    StoryImpl _s = (StoryImpl) 
                    stories.get(stories.size()-1);
                    _s.setTitle(_title.toString());
                    return aParent;
                }
                return this;
            }
        };
    }
}
</code></pre>

<h4>The Android Manifest</h4>

<pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;manifest 
    xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.knowledgeview.android.ticker"
    android:versionCode="1"
    android:versionName="1.0"&gt;
  &lt;uses-sdk android:minSdkVersion="7" /&gt;
  &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
  &lt;application 
        android:icon="@drawable/icon" 
        android:label="@string/app_name"&gt;
    &lt;receiver android:name=".NewsTicker"&gt;
      &lt;intent-filter&gt;
    &lt;action 
          android:name="android.appwidget.action.APPWIDGET_UPDATE"/&gt;
      &lt;/intent-filter&gt;
      &lt;meta-data 
            android:name="android.appwidget.provider"
    android:resource="@xml/newsticker_widget_info"/&gt;
    &lt;/receiver&gt;
    &lt;service android:name=".NewsTickerDataService"/&gt;
  &lt;/application&gt;
&lt;/manifest&gt;
</code></pre>

<h4>The Widget descriptor</h4>

<pre><code>&lt;appwidget-provider 
      xmlns:android="http://schemas.android.com/apk/res/android"
  android:minWidth="294dp"
  android:minHeight="72dp"
  android:updatePeriodMillis="86400000"
  android:initialLayout="@layout/newsticker_widget"&gt;
&lt;/appwidget-provider&gt;
</code></pre>

<h4>The layout descriptor</h4>

<pre><code>&lt;LinearLayout 
      android:id="@+id/linearLayout1" 
      android:layout_width="fill_parent" 
      android:layout_height="fill_parent" 
      xmlns:android="http://schemas.android.com/apk/res/android"&gt;
  &lt;TextView
    android:textAppearance="?android:attr/textAppearanceSmall"
    android:id="@+id/title"
    android:text="TextView"
    android:textSize="10sp"
    android:textColor="#fff"
    android:layout_height="60dp"
    android:layout_width="fill_parent"
    android:background="#c333"
    android:padding="3dp"
    android:layout_margin="5dp"&gt;
  &lt;/TextView&gt;
&lt;/LinearLayout&gt;
</code></pre>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Android">Android</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Desktop Widget">Desktop Widget</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Twitter">Twitter</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="my_first_android_app_desktop_widget.html">Comment on this post</a>

            </article>
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="198" description="Binding Java processes - and thus threads - to a single CPU">
              <span class="meta" itemprop="datePublished"><time datetime="2011-07-19">July 19, 2011</time></span>
              <a itemprop="url" href="replicating_java_threading_issues_between_machines_with_different_cpu_counts.html"><h1 itemprop="name" itemprop="headline">Replicating Java threading issues between machines with different cpu counts</h1></a>
	      <span itemprop="articleBody"><p>Today I had a problem where a multi-threaded testcase which runs fine on my 8-core dev box failed when committed to the single-cpu build-server.</p>

<p>To replicate I needed to run on a single-cpu but I didn't want to commit more potentially broken tests to source-control and run repeatedly breaking builds on the build-server.</p>

<p>I discovered that its possible to bind an exec'd process to a single CPU in newer 'nix's using taskset. Invoking my maven build using taskset to bind the test-run to a single CPU core replicated the failure immediately, and from there it was an easy fix. Here's the cmdline to bind a maven build to a single CPU (I'm running Ubuntu, YMMV):</p>

<pre><code>taskset -pc 0 mvn clean test
</code></pre>

<p>tasket is part of schedutils, which you may or may not have installed. It was installed on my machine already, possibly because of other things i've installed in the past. If needed you can install it with:</p>

<pre><code>sudo apt-get install schedutils
</code></pre>

<p>It basically sets processor affinity by setting some process properties that tell the linux cpu scheduler to only allow the process to run on the stated CPU's.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=CPU affinity">CPU affinity</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Linux">Linux</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Java">Java</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Threading">Threading</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="replicating_java_threading_issues_between_machines_with_different_cpu_counts.html">Comment on this post</a>

            </article>
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="403" description="Problem description and solution for runtime error messages pertaining to testing a web app that uses JQuery using HtmlUnit.">
              <span class="meta" itemprop="datePublished"><time datetime="2011-05-27">May 27, 2011</time></span>
              <a itemprop="url" href="jquery_htmlunit_runtimeerror_messages_galore.html"><h1 itemprop="name" itemprop="headline">JQuery + HtmlUnit = runtimeError messages galore</h1></a>
	      <span itemprop="articleBody"><p>For those who don't care about the back-story and just want the solution: switch the user-agent to Firefox by using the WebClient constructor that takes a BrowserVersion parameter.</p>

<p>...
One of my colleagues wrote a htmlunit test that involved swiftly navigating through a set of pages. The test checked the behaviour was correct and passed just fine, but left behind a very large number of messages like this:</p>

<pre><code>runtimeError: message=
  [The data necessary to complete this operation is not yet available.]
  sourceName=[http://localhost:10821/js/jquery-1.6.1.js] line=[16]
  lineSource=[null] lineOffset=[0]
</code></pre>

<p>This was looking pretty nasty in the hudson and mvn build logs, so I investigated a little to see if I could get rid of it.</p>

<p>First step was to try to figure out what part of the jquery script was triggering the problem, but of course we are using the minified jquery script, so it was impossible to find the problem on line 16 (line 16 is jquery).</p>

<p>Replacing the minified script with the "source" version I get the same error reported at line 923. It's doing the following check:</p>

<pre><code>// The DOM ready check for Internet Explorer
function doScrollCheck() {
 if ( jQuery.isReady ) {
  return;
 }

 try {
  // If IE is used, use the trick by Diego Perini
  // http://javascript.nwbox.com/IEContentLoaded/
     document.documentElement.doScroll("left");
 } catch(e) {
  setTimeout( doScrollCheck, 1 );
  return;
 }

 // and execute any waiting functions
 jQuery.ready();
}
</code></pre>

<p>Line 923 is the one inside the try block. Of course, this is a an IE specific check, and the default user-agent mimicked by HtmlUnit is Internet Explorer 7 - and yes, we were using the default.</p>

<p>You can change the default by passing a BrowserVersion parameter to the WebClient constructor. Switch to Firefox 3 or 3.6 and the problem goes away, switch to IE8 and it gets worse (test fails) - although it seems this is for different reasons, not related to the doScrollCheck. Can't even escape browser version troubles when not using a browser :(</p>

<p>Incidentally I <a href="http://www.andismith.com/blog/2011/11/25-dev-tool-secrets/">discovered recently</a> that many of the latest browsers and developer plugins can "unminify" javascript on the fly.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=JQuery">JQuery</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=HtmlUnit">HtmlUnit</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=runtimeerror">runtimeerror</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="jquery_htmlunit_runtimeerror_messages_galore.html">Comment on this post</a>

            </article>
	    <article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="1,658" description="Tell dont ask programming style, and how to unit test code written in that style - with examples.">
              <span class="meta" itemprop="datePublished"><time datetime="2011-03-15">March 15, 2011</time></span>
              <a itemprop="url" href="unit_testing_code_written_in_tell_don_t_ask_style.html"><h1 itemprop="name" itemprop="headline">Unit Testing code written in "Tell, Don't Ask" style</h1></a>
	      <span itemprop="articleBody"><p>More and more I find myself enjoying the "Tell, Don't Ask" style of programming, to the extent that recently I've been challenging myself to write all my code that way. </p>

<p>This brought up an interesting discussion while working on a proto-type with an excellent developer I've known and worked with for years - how do you test code written in this style?</p>

<h3>Setting the scene</h3>

<p>The idea of the proto-type was to play with and test out several Entity-Extraction and Text-Clustering algorithms - some that we had researched, some using existing libraries, and others of our own devising. We collected a few dozen Mb-worth of sample data to toy with, and I knocked up a quick harness to feed the test data into the Entity-Extraction and Test-Clustering routines, which just needed to implement a bunch of Java interfaces I'd written (using "Tell, Don't Ask" style). Each of us then proceeded to implement some of the algorithms, which we plugged in Strategy-Pattern style.</p>

<p>Every so often as we were working, my colleague would turn and say something like "I need to add Xxxx to the Yyyy interface, so I can unit-test my implementation". His feeling was that whilst in principle "Tell, Don't Ask" is laudable, it makes testing very awkward and ungainly.</p>

<p>As a result the interfaces drifted away from "Tell, Don't Ask" so that, whilst they still included the callback-style methods, they now presented a more typical "Ask" style API too - a simple example being: implementing <code>Iterable&lt;T&gt;</code> as well as providing <code>each(T)</code> methods.</p>

<h3>Example Tests</h3>

<p>Let's look at a simple example of the kind of tests that appear to be made difficult due to the "Tell, Don't Ask" style. Note that I'm using junit 3.8 style for these examples.</p>

<p>Say we have a Stuff interface, which is an immutable container of Thing's, and a ThingMaker that creates many Thing's and returns them packed in a Stuff.  Here are the "Tell, Don't Ask" interfaces we might have started off with:</p>

<pre><code>  public interface Thing {
    public String getName();
    public void doThings();
  }

  public interface ThingCallback {
    public void with(Thing thing);
  }

  public interface Stuff {
    public void each(ThingCallback callback);
  }

  public interface ThingMaker {
    public Stuff makeThings(int howMany);
  }
</code></pre>

<p>Pretty straight-forward. Now, lets see what happens when we want to test that when we ask the ThingMaker to make two Thing's, we actually get two non-null Thing's. Here's what the test method might look like:</p>

<pre><code>public void testMakesCorrectNumberOfThings() {
  ThingMaker tm = new SimpleThingMaker();
  Stuff result = tm.makeThings(2);

  final boolean[] calledBack = new boolean[1];
  final int[] count = new int[1];

  result.each(new ThingCallback() {
    public void with(Thing thing) {
      calledBack[0] = true;
      if (thing != null) {
        count[0] = count[0]++;
      }
    }
  });

  assertTrue(calledBack[0]);
  assertEquals(2, count.length);
}
</code></pre>

<p>Yikes, that's pretty nasty. What's all that nonsense with the final arrays? Well, given that we're working in an anonymous inner class (the callback) we can't just update a boolean or an int that we've declared in the enclosing scope, the only option we have is to cheat and use final variables that have mutable content - arrays are a cheap way to do that. But I think you'll agree this is hideous.</p>

<p>An alternative is to make the inner class do the checking and counting. To do that we have to raise its profile somewhat, to make it a named inner class:</p>

<pre><code>  class TestThingCallback implements ThingCallback {
    boolean called;
    int count;

    public void with(Thing thing) {
      called = true;
      count++;
    }
  }

  public void testMakesCorrectNumberOfThings() {
    ThingMaker tm = new SimpleThingMaker();
    Stuff result = tm.makeThings(2);

    TestThingCallback cb = new TestThingCallback();
    result.each(cb);

    assertTrue(cb.called);
    assertEquals(2, cb.count);
  }
</code></pre>

<p>OK, well that's a lot better, but the effort of making these "Test Spy" objects grows very quickly, and although this is more readable it somehow feels less concise, and by moving code outside of the test-method it makes it just that little bit more awkward to read.</p>

<p>I think this shows that "classical" unit testing of "Tell, Don't Ask" style code is actually awkward enough to want to find a better way. But can we do any better? Absolutely ...</p>

<h3>Enter, jMock</h3>

<p>jMock is an astonishingly useful tool in the testing arsenal. It makes truly unit testing your code possible without masses of work creating Test Double's, because it does all the grunt work for you. Lets quickly re-write our test using jmock.</p>

<pre><code>  public class TestCaseThingMaker extends MockObjectTestCase {
    public void testMakesCorrectNumberOfThings() {
      final ThingCallback callback = mock(ThingCallback.class);
      checking(new Expectations(){{
        exactly(2).of(callback).each(with(any(Thing.class)));
      }});

      ThingMaker tm = new SimpleThingMaker();
      Stuff result = tm.makeThings(2);
      result.each(callback);
    }
  }
</code></pre>

<p>Some of that might need a little explanation, so here goes:</p>

<p>The first thing we do inside our test method is create a "mock" instance of the ThingCallback interface. jMock does this for you in the invocation of the mock method.</p>

<p>Next we set up our "expectations" of what will happen to the mock ThingCallback during our test. The slightly funky syntax with the double braces is just an instance initializer on an anonymous inner class. The interesting bit is the declaration of what we expect to happen to our mock object - this is the bit inside those {{ ... }} written in jMock's intuitive internal DSL. To understand it you just have to read the whole line from left to right - we're expecting exactly 2 invocations of callback.each() with any instance of Thing.</p>

<p>Once we've set up our expectations it only remains to build the object under test - SimpleThingMaker - and invoke the methods we want to test.
If you are staring at that and wondering how JMock knows that the test is finished and the expectations should have been met (and that it should fail the test if not), notice that I'm using the JUnit-3 integration here - extending MockObjectTestCase - and the behind the scenes plumbing is taking care of that last step for me. </p>

<p>If you're using the JUnit-4 integration you need to explicitly invoke assertIsSatisfied on the mock object context (org.jmock.Mockery) which supplied your mock objects.
jMock takes a little getting used to, as it involves quite a different way of thinking about your test. If you want to write good tests with it it certainly involves considerable effort to learn how to use it well (its easy to use it badly and end up with tests which are very difficult to understand). Once you get used to it though, it really does make tests much easier to write and, more importantly, to read.</p>

<p>I find that jMock really comes into its own when testing Tell, Don't Ask code - the code under test is clean and, by nature of the improved data-hiding, more robust, whilst jMock provides a very neat way to test that code with a minimum of fuss and boiler-plate. </p>

<p><em>UPDATE:</em> After ruminating on this for a while I came to the conclusion that JMock is so good at testing "Tell, don't ask" code that I was sure the designers of JMock must have set out with that in mind. I found a very nice post from @natpryce (one of the JMock authors) which confirmed my suspicions - Nat describes tell don't ask very succinctly:</p>

<blockquote>
  <p>"...objects tell each other what to do by sending commands to one another, they don't ask each other for information and then make decisions upon the results of those queries. </p>
  
  <p>The end result of this style is that it is easy to swap one object for another that can respond to the same commands but in a different way. This is because the behaviour of one object is not tied to the internal structure of the objects that it talks to."</p>
</blockquote>

<p>Nat goes on to say that the only way to test tell-dont-ask code is to see how the state of the world is affected when objects are told to do something (because you can't ask them about their state), and that this is best achieved with mock objects, whereas "train wreck" code (Nat's description of code that is not written tell-dont-ask style, and commonly violates demeter's law) is hard to test with mock objects.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=TDD">TDD</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Unit Testing">Unit Testing</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Tell Dont Ask">Tell Dont Ask</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="unit_testing_code_written_in_tell_don_t_ask_style.html">Comment on this post</a>

            </article>
        </div>
        <div class="sidebar">
          <div>
            <div class="twitter-feed" show="4" account="steveliles">
              <h5>Recent Tweets</h5>            
              <ul class="tweets">
                <li class="tweet-template" style="display:none">        
                  <span class="text"></span>&nbsp;<span class="date" format="yyyy"></span>
                </li>
              </ul>
              <a href="https://twitter.com/steveliles" class="twitter-follow-button" data-show-count="false">Follow @steveliles</a>
	      <script src="//platform.twitter.com/widgets.js" type="text/javascript"></script>
            </div>
          </div>
          <div>
            <a href="article-archive.html"><h5>Recent Posts</h5></a>
            <ul>
                <li><a href="setting_up_maven_android_and_svn_for_team_development_of_multiple_applications.html">Setting up Maven, Android and SVN for team development of multiple applications</a><span class="date"> - Jan 09, 2012</span></li>
                <li><a href="converting_eclipse_adt_android_projects_to_build_with_maven.html">Converting Eclipse ADT Android projects to build with Maven</a><span class="date"> - Jan 04, 2012</span></li>
                <li><a href="android_source_code_available.html">Android Source Code available!</a><span class="date"> - Dec 20, 2011</span></li>
                <li><a href="perforated_postage_stamp_border_with_inkscape.html">Perforated postage-stamp border with Inkscape</a><span class="date"> - Dec 18, 2011</span></li>
                <li><a href="subversion_1_7_eclipse_integration_in_ubuntu.html">Subversion 1.7 Eclipse integration in Ubuntu</a><span class="date"> - Dec 16, 2011</span></li>
            </ul>
            <a href="article-archive.html">Older posts...</a>
          </div>
        </div>
      </div>
      <nav>
        <div class="links">
          <div class="prev"><a title="previous" href="index_4.html">Newer Posts</a></div>
          <div class="next"><a title="next" href="index_6.html">Older Posts</a></div>
        </div>
      </nav>
    </div>
    <script type="text/javascript" language="javascript" src="blog/blog.nocache.js"></script>
  </body>
</html>

