<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <link rel="stylesheet" href="css/styles.css" type="text/css" media="screen"/>
    <link href='http://fonts.googleapis.com/css?family=Gochi+Hand' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:700' rel='stylesheet' type='text/css'>
    <meta name="keywords" content="GWT" itemprop="keywords">
<meta name="keywords" content="JavaScript" itemprop="keywords">
<meta name="keywords" content="Overlay" itemprop="keywords">
<meta name="keywords" content="JSO" itemprop="keywords">
<meta name="keywords" content="JSON" itemprop="keywords">
<meta name="keywords" content="Parsing" itemprop="keywords">
<meta name="keywords" content="JSNI" itemprop="keywords">

  </head>
  <body>
    <div>
      <header class="site-header">
        <div class="left">
          <a href="/index.html"><h1>ExoMemory</h1></a>
          <h2>Because I'll forget it if I don't write it down...</h2>
        </div>
        <div class="right">
          <img src="images/lego.png"> 
        </div>
      </header>
      <nav>
        <span>
          <a rel="author" href="https://plus.google.com/105248011271585565954/posts?hl=en"><img src="http://www.google.com/images/icons/ui/gprofile_button-16.png" width="16" height="16"></a>
          <a rel="author" href="http://www.twitter.com/steveliles"><img src="http://twitter-badges.s3.amazonaws.com/t_mini-a.png" alt="Follow steveliles on Twitter"/></a>
	  <a rel="author" href="http://uk.linkedin.com/in/steveliles"><img src="http://www.linkedin.com/img/webpromo/btn_in_20x15.png" width="20" height="15" alt="View my LinkedIn profile"></a>
	  <form action="http://www.google.com/search" method="get">
            <input type="hidden" name="q" value="site:steveliles.github.com">
            <input type="text" name="q" placeholder="search"></input>
          </form>
        </span>
      </nav>
      <div class="content">
        <div class="main"><article itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="1105">
  <span class="meta" itemprop="datePublished"><time datetime="2011-10-12">October 12, 2011</time></span>
  <a itemprop="url" href="gwt_javascriptobjects_javascript_overlays.html"><h1 itemprop="name" itemprop="headline">GWT JavaScriptObjects (Javascript Overlays)</h1></a>
  <span itemprop="articleBody"><p>GWT has a fantastic tool for "overlaying" java (GWT) classes on JSON objects such that you don't have to write any parsing code to parse a piece of JSON. There are some nice articles about this from the GWT folks themselves, for example this one. The gist of it is, given some JSON like this:</p>

<pre><code>{ "item": {
    "id": 123,
    "name": "cheese",
    "type": "food"
  }
}
</code></pre>

<p>we can "overlay" a java class onto that JSON, and have the GWT compiler (and the browser's native JSON parsing) do the marshalling for us, by writing a class that looks like this:</p>

<pre><code>public class Item extends JavaScriptObject
{
    protected Item(){}

    public final native Integer getId()/*-{ 
        return this.id; 
    }-*/;

    public final native String getName()/*-{ 
        return this.name; 
    }-*/;

    public final native String getType()/*-{ 
        return this.id; 
    }-*/;
}
</code></pre>

<p>Those three native methods are known in GWT-land as "JSNI" (JavaScript Native Interface), and the part in comments at the end is actually pure JavaScript that you can write to directly access parts of the JSON object. In these native JSNI sections the "this" object being referred to is the JSON object itself, and although I've only shown very simple property access here you can in fact perform more complex operations if you like.</p>

<p>The return values from our JSNI can be Java's primitive wrappers or String, any class that extends JavaScriptObject (JSO), or one of a number of special JSO classes GWT provides such as JsArray, JsIterable, JsArrayString, etc.</p>

<p>I have exclusively used jsni methods in my example above, but you can include pure java methods as well (provided they are final) - say, for example, we need to parse a date from some json:</p>

<pre><code>public class Item extends JavaScriptObject
{
    private static final DateTimeFormat df = 
        DateTimeFormat.getFormat("yyyyMMdd");

    protected Item(){}

    public final Date whenCreated() {
        return df.parse(getCreateDateString());
    }

    public final native Integer getId()/*-{ 
        return this.id; 
    }-*/;

    public final native String getName()/*-{ 
        return this.name; 
    }-*/;

    public final native String getType()/*-{ 
        return this.id; 
    }-*/;

    public final native String getCreateDateString()/*-{ 
        return this.createDate; 
    }-*/;
}
</code></pre>

<p>These are simple examples of course, but i've had no trouble mapping even the most complex JSON objects using JSO's. You can map arrays easily enough using the built in GWT JsArray types, like this:</p>

<pre><code>public class Items extends JavaScriptObject
{
    protected Items(){}

    public final native JsArray getItems()/*-{ 
        return this.items; 
    }-*/;
}
</code></pre>

<p>Which would map the following JSON:</p>

<pre><code>{ items: [
  {
    "id": 123,
    "name": "cheese",
    "type": "food"
  },
  {
    "id": 456,
    "name": "ham",
    "type": "food"
  },
  {
    "id": 789,
    "name": "eggs",
    "type": "food"
  }]
}
</code></pre>

<p>There are a couple of basic rules to follow:</p>

<ul>
<li>Must have a protected no-arg constructor</li>
<li><em>All</em> methods must be "final"</li>
<li>Must not have any instance fields</li>
<li>May only implement a single Interface</li>
</ul>

<p>With regard to that last point, there's another gotcha to look out for: only one JavaScriptObject class can implement any given interface. Think about that for a minute, because its more of a restriction than you might at first realise. The whole point of Interfaces is to use them to define a contract that implementations will adhere to, so that multiple poly-morphically interchangeable implementations can be used. With JSO's, you can only have one single JSO implementation of an interface - for example you cannot have several JSO's which implement Iterable. This is for the same reason that all JSO methods must be final - JSO's cannot use dynamic method dispatch.</p>

<p>If you try to implement the same interface in more than one of your JSO's you don't (currently) get any warnings from the compiler ... instead you get crazy runtime behaviour due to the wrong JSO class's methods being invoked (because one of your JSO's will receive all method invocations for the interface, regardless of which class the method should have been invoked against).</p>

<p>Interestingly I ran into a problem in the latest GWT release (2.4) that reported a very unhelpful error message (I'm sure the messages in earlier releases of GWT were much more helpful actually). Here's the error message I got:</p>

<pre><code>java.lang.ClassFormatError: Illegal method name "$"
 in class com/xxx/xxx/client/model/UserResult
 at java.lang.ClassLoader.defineClass1(Native Method)
 at java.lang.ClassLoader.defineClassCond(ClassLoader.java:631)
 at java.lang.ClassLoader.defineClass(ClassLoader.java:615)
 at java.lang.ClassLoader.defineClass(ClassLoader.java:465)
 at com.google.gwt.dev.shell.CompilingClassLoader.findClass
    (CompilingClassLoader.java:1085)
 at java.lang.ClassLoader.loadClass(ClassLoader.java:306)
 at java.lang.ClassLoader.loadClass(ClassLoader.java:247)
</code></pre>

<p>... as it turns out, the problem actually was that I broke one of the rules - I had a non-final method in my JavaScriptObject. Not a very helpful error message in this case, which is fairly unusual in my experience of GWT.</p>
</span>
  <ul class="keywords"><li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=GWT">GWT</a></li>
<li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=JavaScript">JavaScript</a></li>
<li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Overlay">Overlay</a></li>
<li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=JSO">JSO</a></li>
<li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=JSON">JSON</a></li>
<li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Parsing">Parsing</a></li>
<li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=JSNI">JSNI</a></li>
</ul>
  <div style="clear:both"></div>
</article>
</div>
        <div class="sidebar">
          <div class="twitter-feed" show="5" account="steveliles">
            <h5>Recent Tweets</h5>            
              <ul class="tweets">
                <li class="tweet-template" style="display:none">        
                  <span class="text"></span>&nbsp;<span class="date" format="yyyy"></span>
                </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <script type="text/javascript" language="javascript" src="blog/blog.nocache.js?cache=${build.timestamp}"></script>
  </body>
</html>
